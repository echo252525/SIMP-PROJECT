<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Verification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Keep your existing sidebar styles and icons -->
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />

    <style>
      :root {
        --ink: #1c2430;
        --muted: #6c7a8a;
        --line: #e7edf3;
        --brand: #20a44c;
        --danger: #e53935;
        --card: #fff;
        --pill: #eef6ff;
        --radius: 14px;

        /* modal */
        --modal-backdrop: rgba(14, 25, 42, 0.55);
        --modal-head: #f7fbff;
        --shadow-xl: 0 24px 64px rgba(16, 24, 40, 0.2);
        --shadow-md: 0 8px 24px rgba(16, 24, 40, 0.08);
        --shadow-sm: 0 2px 10px rgba(16, 24, 40, 0.06);
      }

      main {
        margin-top: 1.4rem;
      }

      .two-col {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 1rem;
      }

      @media (max-width: 980px) {
        .two-col {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 12px;
      }

      .panel h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        color: var(--ink);
      }

      .search {
        position: relative;
        margin-bottom: 0.6rem;
      }

      .search input {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px 10px 36px;
        outline: none;
        background: #fcfeff;
        transition: box-shadow 150ms ease, border-color 150ms ease;
      }

      .search input:focus {
        border-color: #cfe7ff;
        box-shadow: 0 0 0 4px #e9f4ff;
      }

      .search .material-icons-sharp {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 20px;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 70vh;
        overflow: auto;
        padding-right: 4px;
      }

      .item {
        display: grid;
        grid-template-columns: 40px 1fr auto;
        align-items: center;
        gap: 10px;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        cursor: pointer;
        background: #fff;
        transition: background 150ms ease, border-color 150ms ease,
          box-shadow 150ms ease, transform 120ms ease;
      }

      .item:hover {
        background: #f8fbff;
        border-color: #d9ebff;
        box-shadow: var(--shadow-sm);
      }

      .item:focus-visible {
        outline: 2px solid #9fd3ff;
        outline-offset: 2px;
      }

      .item.active {
        background: #f3fdf7;
        border-color: #b7f0cf;
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #1f2a3a;
        overflow: hidden;
        user-select: none;
      }

      .avatar.cover {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        color: transparent;
        text-indent: -9999px;
      }

      .pill {
        font-size: 0.75rem;
        background: var(--pill);
        padding: 4px 8px;
        border-radius: 999px;
        color: #2463a6;
        border: 1px solid #d6e9ff;
        white-space: nowrap;
      }

      .pill.you {
        background: #e8fff4;
        color: #0f5132;
        border-color: #b7e4c7;
        margin-left: 8px;
      }

      .details {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        overflow: clip;
      }

      .details .head {
        display: grid;
        grid-template-columns: 72px 1fr;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid var(--line);
        align-items: center;
        background: linear-gradient(180deg, #f9fbff, #ffffff);
      }

      .details .name {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0 0 2px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        color: var(--ink);
      }

      .meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 4px;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .actions-row {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--line);
        justify-content: flex-end;
        background: #fff;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 16px;
      }

      @media (max-width: 980px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      .card {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }

      .card h4 {
        margin: 0 0 0.6rem 0;
        font-size: 0.95rem;
        color: var(--ink);
      }

      .info-list {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px 12px;
      }

      @media (max-width: 640px) {
        .info-list {
          grid-template-columns: 1fr;
        }
      }

      .label {
        color: var(--muted);
        font-size: 0.85rem;
        display: block;
        margin-bottom: 2px;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 10px;
        padding: 9px 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        transition: transform 120ms ease, box-shadow 150ms ease,
          border-color 150ms ease, background 150ms ease, color 150ms ease;
      }

      .btn:hover {
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.primary {
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
      }

      .btn.warn {
        background: #fff8e1;
        color: #8a6d0a;
        border-color: #fde68a;
      }

      .btn.reject {
        background: #fff5f5;
        color: var(--danger);
        border-color: #ffd7d7;
      }

      .empty-state,
      .not-auth {
        padding: 24px;
        border-radius: 12px;
        background: #fbfeff;
        text-align: center;
        color: var(--muted);
      }

      .empty-state {
        border: 1px dashed var(--line);
      }

      .not-auth {
        border: 1px solid var(--line);
        background: #fff;
      }

      .role-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
      }

      .dot-pending {
        background: #f59e0b;
      }

      .dot-admin {
        background: #10b981;
      }

      .dot-super {
        background: #6366f1;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: var(--modal-backdrop);
        display: none;
        align-items: flex-end;
        z-index: 9999;
      }

      .modal-overlay.open {
        display: flex;
      }

      .modal-sheet {
        width: 100%;
        max-height: 85vh;
        background: #fff;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
        box-shadow: var(--shadow-xl);
        overflow: hidden;
      }

      .modal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        background: var(--modal-head);
        border-bottom: 1px solid var(--line);
      }

      .modal-title {
        font-weight: 700;
        color: var(--ink);
      }

      .modal-close {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
      }

      .modal-close:hover {
        background: #eef5ff;
      }

      .modal-body {
        max-height: calc(85vh - 52px);
        overflow: auto;
      }

      @media (max-width: 980px) {
        #detailsPane {
          display: none !important;
        }

        #approveBtn,
        #rejectBtn,
        #demoteBtn,
        #promoteBtn {
          width: 44px;
          height: 44px;
          padding: 0;
          justify-content: center;
          font-size: 0;
          position: relative;
        }

        #approveBtn::before,
        #rejectBtn::before,
        #demoteBtn::before,
        #promoteBtn::before {
          font-family: "Material Icons Sharp";
          font-size: 22px;
          line-height: 1;
        }

        #approveBtn::before {
          content: "check";
        }

        #rejectBtn::before {
          content: "close";
        }

        #demoteBtn::before {
          content: "south";
        }

        #promoteBtn::before {
          content: "grade";
        }
      }

      .head {
        display: flex;
        align-items: flex-start;   /* align to top */
        justify-content: center;   /* center horizontally */
        text-align: center;        /* center text inside */
        padding: 0;                /* remove the left padding */
        margin: 0 auto;            /* center the whole block itself */
      }

      /* ====== Skeleton Loader (PC + Mobile) ====== */
      .hidden{ display:none !important; }
      .skel{ position:relative; overflow:hidden; background:#eef2f7; border-radius:12px; }
      .skel-line{ height:14px; border-radius:8px; background:#eef2f7; }
      .skel.w-30{ width:30%; } .skel.w-40{ width:40%; } .skel.w-50{ width:50%; }
      .skel.w-60{ width:60%; } .skel.w-70{ width:70%; } .skel.w-80{ width:80%; } .skel.w-90{ width:90%; }
      .skel.shimmer::after{
        content:""; position:absolute; inset:0; transform:translateX(-100%);
        background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.55) 50%, rgba(255,255,255,0) 100%);
        animation:shmm 1.1s infinite;
      }
      @keyframes shmm{ 0%{ transform:translateX(-100%);} 100%{ transform:translateX(100%);} }

      /* Skeleton layout mirrors two-col */
      #skeletonArea.two-col { display:grid; grid-template-columns:340px 1fr; gap:1rem; }
      @media (max-width:980px){ #skeletonArea.two-col { grid-template-columns:1fr; } }

      /* Left skeleton (list) */
      .sk-panel{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:12px; }
      .sk-list{ display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow:auto; }
      .sk-item{ display:grid; grid-template-columns:40px 1fr auto; align-items:center; gap:10px; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; }
      .sk-avatar{ width:40px; height:40px; border-radius:50%; }
      .sk-pill{ width:80px; height:20px; border-radius:999px; }

      /* Right skeleton (details) */
      .sk-details{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; }
      .sk-head{ display:grid; grid-template-columns:72px 1fr; gap:16px; padding:16px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#f9fbff,#ffffff); }
      .sk-bigavatar{ width:72px; height:72px; border-radius:50%; }
      .sk-actions{ display:flex; gap:8px; padding:12px 16px; border-bottom:1px solid var(--line); background:#fff; }
      .sk-btn{ width:88px; height:36px; border-radius:10px; }
      .sk-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:16px; }
      @media (max-width:980px){ .sk-grid{ grid-template-columns:1fr; } }
      .sk-card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; }
      .sk-title{ height:16px; width:140px; margin-bottom:10px; }

    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="../../../img/simpLogo.png" alt="SIMP Logo" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>

        <div class="sidebar">
          <a href="dashboard.html">
            <span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3>
          </a>
          <a href="workerVerification.html">
            <span class="material-icons-sharp">engineering</span>
            <h3>Workers<br />Verification</h3>
          </a>
          <a href="jobVerification.html">
            <span class="material-icons-sharp">work</span>
            <h3>Jobs<br />Verification</h3>
          </a>
          <a href="jobApplicationVerification.html">
            <span class="material-icons-sharp">approval</span>
            <h3>Application<br />Verification</h3>
          </a>
          <a href="adminVerification.html" class="active">
            <span class="material-icons-sharp">shield</span>
            <h3>Admin<br />Verification</h3>
          </a>
          <a href="manageShop.html">
            <span class="material-icons-sharp">shop</span>
            <h3>Manage<br />Shop</h3>
          </a>
          <a href="paymentsRequest.html">
            <span class="material-icons-sharp">payments</span>
            <h3>Payments<br />Request</h3>
          </a>
          <a href="courses.html">
            <span class="material-icons-sharp">school</span>
            <h3>Course<br />Publisher</h3>
          </a>
          <a href="settings.html">
            <span class="material-icons-sharp">settings</span>
            <h3>Settings</h3>
          </a>
          <a href="#" id="logout-btn">
            <span class="material-icons-sharp">logout</span>
            <h3>Logout</h3>
          </a>
        </div>
      </aside>

      <!-- MAIN -->
      <main>
        <section>

          <!-- ===== SKELETON AREA (shown first) ===== -->
          <div id="skeletonArea" class="two-col">
            <!-- Left skeleton (list) -->
            <div class="sk-panel">
              <div class="skel skel-line w-60 shimmer" style="height:18px; margin-bottom:10px;"></div>

              <div class="skel skel-line shimmer" style="height:36px; border-radius:10px; margin-bottom:10px;"></div>
              <div class="skel skel-line shimmer" style="height:36px; border-radius:10px; margin-bottom:10px;"></div>

              <div class="sk-list">
                <div class="sk-item">
                  <div class="skel sk-avatar skel shimmer sk-avatar"></div>
                  <div>
                    <div class="skel skel-line w-80 shimmer" style="height:14px; margin-bottom:6px;"></div>
                    <div class="skel skel-line w-60 shimmer" style="height:12px;"></div>
                  </div>
                  <div class="skel sk-pill shimmer"></div>
                </div>
                <div class="sk-item">
                  <div class="skel sk-avatar skel shimmer sk-avatar"></div>
                  <div>
                    <div class="skel skel-line w-70 shimmer" style="height:14px; margin-bottom:6px;"></div>
                    <div class="skel skel-line w-50 shimmer" style="height:12px;"></div>
                  </div>
                  <div class="skel sk-pill shimmer"></div>
                </div>
                <div class="sk-item">
                  <div class="skel sk-avatar skel shimmer sk-avatar"></div>
                  <div>
                    <div class="skel skel-line w-65 shimmer" style="height:14px; margin-bottom:6px;"></div>
                    <div class="skel skel-line w-45 shimmer" style="height:12px;"></div>
                  </div>
                  <div class="skel sk-pill shimmer"></div>
                </div>
                <div class="sk-item">
                  <div class="skel sk-avatar skel shimmer sk-avatar"></div>
                  <div>
                    <div class="skel skel-line w-75 shimmer" style="height:14px; margin-bottom:6px;"></div>
                    <div class="skel skel-line w-55 shimmer" style="height:12px;"></div>
                  </div>
                  <div class="skel sk-pill shimmer"></div>
                </div>
              </div>
            </div>

            <!-- Right skeleton (details) -->
            <div class="sk-details">
              <div class="sk-head">
                <div class="skel sk-bigavatar shimmer"></div>
                <div>
                  <div class="skel skel-line w-60 shimmer" style="height:18px; margin-bottom:8px;"></div>
                  <div class="skel skel-line w-40 shimmer" style="height:14px;"></div>
                </div>
              </div>
              <div class="sk-actions">
                <div class="skel sk-btn shimmer"></div>
                <div class="skel sk-btn shimmer"></div>
              </div>
              <div class="sk-grid">
                <div class="sk-card">
                  <div class="skel sk-title shimmer"></div>
                  <div class="skel skel-line w-90 shimmer" style="height:14px; margin-bottom:8px;"></div>
                  <div class="skel skel-line w-80 shimmer" style="height:14px; margin-bottom:8px;"></div>
                  <div class="skel skel-line w-70 shimmer" style="height:14px;"></div>
                </div>
                <div class="sk-card">
                  <div class="skel sk-title shimmer"></div>
                  <div class="skel skel-line w-85 shimmer" style="height:14px; margin-bottom:8px;"></div>
                  <div class="skel skel-line w-60 shimmer" style="height:14px; margin-bottom:8px;"></div>
                  <div class="skel skel-line w-75 shimmer" style="height:14px;"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- ===== /SKELETON AREA ===== -->

          <div class="two-col" id="contentArea" style="display: none">
            <!-- Left: list -->
            <div class="panel">
              <h3>Admin Directory</h3>

              <div class="search">
                <span class="material-icons-sharp">search</span>
                <input
                  id="searchInput"
                  type="text"
                  placeholder="Search name or email…"
                />
              </div>

              <div style="margin-bottom: 0.6rem">
                <select
                  id="statusFilter"
                  style="
                    width: 100%;
                    border: 1px solid var(--line);
                    border-radius: 10px;
                    padding: 10px 12px;
                    background: #fcfeff;
                    outline: none;
                  "
                >
                  <option value="">All statuses</option>
                  <option value="pending">Pending</option>
                  <option value="admin">Admin</option>
                  <option value="superadmin">Super Administrator</option>
                </select>
              </div>

              <div id="adminList" class="list"></div>

              <div id="emptyAdmins" class="empty-state" style="display: none">
                No admin profiles found.
              </div>
            </div>

            <!-- Right: details -->
            <div class="details" id="detailsPane">
              <div class="empty-state">
                Select a profile on the left to review full details.
              </div>
            </div>
          </div>

          <div id="notAuth" class="not-auth" style="display: none">
            You don’t have access to Admin Verification. Please contact a super
            administrator.
          </div>
        </section>
      </main>
    </div>

    <!-- Mobile details modal (bottom sheet) -->
    <div id="detailsModal" class="modal-overlay" aria-hidden="true">
      <div
        class="modal-sheet"
        role="dialog"
        aria-modal="true"
        aria-labelledby="detailsModalTitle"
      >
        <div class="modal-head">
          <div class="modal-title" id="detailsModalTitle">Admin Details</div>
          <button class="modal-close" id="detailsModalClose" aria-label="Close">
            <span class="material-icons-sharp">close</span>
          </button>
        </div>
        <div class="modal-body" id="detailsModalBody"></div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
        { db: { schema: "public" } }
      );

      const contentArea = document.getElementById("contentArea");
      const notAuth = document.getElementById("notAuth");
      const adminList = document.getElementById("adminList");
      const emptyAdmins = document.getElementById("emptyAdmins");
      const detailsPane = document.getElementById("detailsPane");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");

      const detailsModal = document.getElementById("detailsModal");
      const detailsModalBody = document.getElementById("detailsModalBody");
      const detailsModalClose = document.getElementById("detailsModalClose");

      /* === ADDED: skeleton handle === */
      const skeletonArea = document.getElementById("skeletonArea");
      const hideSkeleton = () => { if (skeletonArea) skeletonArea.style.display = "none"; };
      const showSkeleton = () => { if (skeletonArea) skeletonArea.style.display = ""; };

      let currentUser = null;
      let currentRole = null; // 'pending' | 'admin' | 'superadmin' | null
      let admins = [];
      let activeAdminId = null;

      const avatarCache = {};

      const cap = (s) => (s ? s.charAt(0).toUpperCase() + s.slice(1) : s);

      const roleDot = (role) => {
        if (role === "admin") return '<span class="role-dot dot-admin"></span>';
        if (role === "superadmin")
          return '<span class="role-dot dot-super"></span>';
        return '<span class="role-dot dot-pending"></span>';
      };

      const initials = (name = "") => {
        const i = name
          .trim()
          .split(/\s+/)
          .map((p) => p[0] || "")
          .join("")
          .toUpperCase()
          .slice(0, 2);
        return i || "?";
      };

      const isMobile = () => window.matchMedia("(max-width: 980px)").matches;

      function applyAvatarToEl(el, url) {
        if (!el) return;
        if (url) {
          el.classList.add("cover");
          el.style.backgroundImage = 'url("' + url + '")';
          el.textContent = "";
        } else {
          el.classList.remove("cover");
          el.style.backgroundImage = "";
        }
      }

      async function signAvatar(path) {
        if (!path) return null;
        try {
          const { data, error } = await supabase.storage
            .from("admin_profile")
            .createSignedUrl(path, 3600);
          if (error) return null;
          return data && data.signedUrl ? data.signedUrl : null;
        } catch (e) {
          return null;
        }
      }

      async function hydrateAvatars(rows) {
        const jobs = rows.map(async (a) => {
          const path = a && a.admin_profile_url ? a.admin_profile_url : null;
          if (!path) {
            avatarCache[a.id] = null;
            return;
          }
          const url = await signAvatar(path);
          avatarCache[a.id] = url || null;
        });
        await Promise.allSettled(jobs);
      }

      document.addEventListener("DOMContentLoaded", async function () {
        // Show skeleton immediately; real content & notAuth are hidden by default
        showSkeleton();

        const res = await supabase.auth.getUser();
        const user = res && res.data ? res.data.user : null;

        if (!user) {
          hideSkeleton();
          notAuth.style.display = "block";
          return;
        }

        currentUser = user;

        const meRes = await supabase
          .from("admin")
          .select("id, role")
          .eq("id", user.id)
          .maybeSingle();

        if (meRes.error) {
          console.error(meRes.error);
          hideSkeleton();
          notAuth.style.display = "block";
          return;
        }

        currentRole = meRes.data ? meRes.data.role : null;

        if (!(currentRole === "admin" || currentRole === "superadmin")) {
          hideSkeleton();
          notAuth.style.display = "block";
          return;
        }

        contentArea.style.display = "grid";
        await refreshAdmins(); // while this runs, skeleton stays visible
        // Once list + details rendered, hide the skeleton
        hideSkeleton();

        wireUI();

        detailsModalClose.addEventListener("click", closeDetailsModal);
        detailsModal.addEventListener("click", function (e) {
          if (e.target === detailsModal) closeDetailsModal();
        });

        window.addEventListener("resize", function () {
          if (!isMobile()) closeDetailsModal();
        });
      });

      function wireUI() {
        searchInput.addEventListener("input", renderAdminList);
        statusFilter.addEventListener("change", renderAdminList);
      }

      async function refreshAdmins() {
        const { data, error } = await supabase
          .from("admin")
          .select("id, email, name, phone, role, created_at, admin_profile_url")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          adminList.innerHTML = "";
          emptyAdmins.style.display = "block";
          emptyAdmins.textContent =
            "Error loading admin profiles: " + error.message;
          return;
        }

        admins = data || [];

        await hydrateAvatars(admins);

        renderAdminList();

        if (admins.length > 0) {
          const first = admins[0];
          activeAdminId = first.id;
          renderDetails(first);
          maybeOpenMobileModal(first);
          setTimeout(function () {
            var items = document.querySelectorAll("#adminList .item");
            for (var i = 0; i < items.length; i++) {
              if (items[i].dataset.id === activeAdminId) {
                items[i].classList.add("active");
              }
            }
          }, 0);
        } else {
          detailsPane.innerHTML =
            '<div class="empty-state">No admin profiles found.</div>';
        }
      }

      function renderAdminList() {
        adminList.innerHTML = "";

        var q = (searchInput.value || "").trim().toLowerCase();
        var roleSel = (statusFilter.value || "").toLowerCase();

        var filtered = (admins || []).filter(function (a) {
          var matchesQuery =
            !q ||
            (a.name && a.name.toLowerCase().includes(q)) ||
            (a.email && a.email.toLowerCase().includes(q));
          var matchesRole =
            !roleSel || (a.role || "").toLowerCase() === roleSel;
          return matchesQuery && matchesRole;
        });

        emptyAdmins.style.display = filtered.length ? "none" : "block";

        filtered.forEach(function (a) {
          var item = document.createElement("div");
          item.className = "item";
          item.dataset.id = a.id;
          if (a.id === activeAdminId) item.classList.add("active");

          var youBadge =
            a.id === (currentUser ? currentUser.id : "")
              ? ' <span class="pill you">You</span>'
              : "";

          var avatar =
            '<div class="avatar" data-avatar-id="' +
            a.id +
            '">' +
            initials(a.name || a.email) +
            "</div>";

          item.innerHTML =
            avatar +
            "<div>" +
            '<div style="font-weight:700; color: var(--ink);">' +
            (a.name || "(no name)") +
            youBadge +
            "</div>" +
            '<div style="font-size:.85rem; color:var(--muted);">' +
            a.email +
            "</div>" +
            "</div>" +
            '<span class="pill">' +
            roleDot(a.role) +
            " " +
            (a.role ? cap(a.role) : "Pending") +
            "</span>";

          var avatarEl = item.querySelector('[data-avatar-id="' + a.id + '"]');
          applyAvatarToEl(avatarEl, avatarCache[a.id]);

          item.addEventListener("click", function () {
            activeAdminId = a.id;
            var rows = document.querySelectorAll("#adminList .item");
            for (var i = 0; i < rows.length; i++) {
              rows[i].classList.remove("active");
            }
            item.classList.add("active");
            renderDetails(a);
            maybeOpenMobileModal(a);
          });

          adminList.appendChild(item);
        });
      }

      function renderDetails(admin) {
        var when = new Date(admin.created_at).toLocaleString();
        var roleLabel = admin.role ? cap(admin.role) : "Pending";
        var roleBadge = roleDot(admin.role) + " " + roleLabel;
        var youHeaderBadge =
          admin.id === (currentUser ? currentUser.id : "")
            ? ' <span class="pill you">This is you</span>'
            : "";

        detailsPane.innerHTML =
          '<div class="head">' +
          '<div class="avatar" id="detailAvatar" style="width:72px; height:72px; font-size:1.2rem;">' +
          initials(admin.name || admin.email) +
          "</div>" +
          "<div>" +
          '<div class="name">' +
          (admin.name || "(no name)") +
          ' <span class="pill" id="statusPill">' +
          roleBadge +
          "</span>" +
          youHeaderBadge +
          "</div>" +
          '<div class="meta">Created: ' +
          when +
          "</div>" +
          "</div>" +
          "</div>" +
          '<div class="actions-row">' +
          (renderActionsFor(admin).join("") || "") +
          "</div>" +
          '<div class="grid-2">' +
          '<div class="card" style="grid-column: 1 / -1;">' +
          "<h4>Basic Information</h4>" +
          '<div class="info-list">' +
          '<div><span class="label">Full Name</span>' +
          (admin.name || "—") +
          "</div>" +
          '<div><span class="label">Email</span>' +
          (admin.email || "—") +
          "</div>" +
          '<div><span class="label">Phone</span>' +
          (admin.phone || "—") +
          "</div>" +
          '<div><span class="label">Role</span>' +
          roleLabel +
          "</div>" +
          "</div>" +
          "</div>" +
          "</div>";

        var detailAvatarEl = detailsPane.querySelector("#detailAvatar");
        applyAvatarToEl(detailAvatarEl, avatarCache[admin.id]);

        wireActionsFor(admin);
      }

      function renderActionsFor(admin) {
        var actions = [];
        if (currentRole === "admin") {
          if ((admin.role || "pending") === "pending") {
            actions.push(
              '<button class="btn primary" id="approveBtn" title="Approve">Approve</button>'
            );
            actions.push(
              '<button class="btn reject" id="rejectBtn" title="Reject">Reject</button>'
            );
          }
        } else if (currentRole === "superadmin") {
          var ar = admin.role || "pending";
          if (ar === "pending") {
            actions.push(
              '<button class="btn primary" id="approveBtn" title="Approve to Admin">Approve (to Admin)</button>'
            );
            actions.push(
              '<button class="btn reject" id="rejectBtn" title="Reject">Reject</button>'
            );
          } else if (ar === "admin") {
            if (admin.id !== currentUser.id) {
              actions.push(
                '<button class="btn warn" id="demoteBtn" title="Demote to Pending">Demote to Pending</button>'
              );
              actions.push(
                '<button class="btn primary" id="promoteBtn" title="Promote to Super Admin">Promote to Super Admin</button>'
              );
            }
          } else if (ar === "superadmin") {
            // no actions
          }
        }
        return actions;
      }

      function wireActionsFor(admin) {
        var approveBtn = detailsPane.querySelector("#approveBtn");
        var rejectBtn = detailsPane.querySelector("#rejectBtn");
        var demoteBtn = detailsPane.querySelector("#demoteBtn");
        var promoteBtn = detailsPane.querySelector("#promoteBtn");

        if (approveBtn) {
          approveBtn.addEventListener("click", async function () {
            await setRole(admin.id, "admin");
          });
        }

        if (rejectBtn) {
          rejectBtn.addEventListener("click", async function () {
            var ok = confirm(
              "Reject this profile (" +
                admin.email +
                ")? This deletes the user from auth and removes their admin row."
            );
            if (!ok) return;
            await rejectProfileDeleteAuthUser(admin.id);
          });
        }

        if (demoteBtn) {
          demoteBtn.addEventListener("click", async function () {
            var ok = confirm("Demote " + admin.email + " to Pending?");
            if (!ok) return;
            await setRole(admin.id, "pending");
          });
        }

        if (promoteBtn) {
          promoteBtn.addEventListener("click", async function () {
            var ok = confirm(
              "Transfer SUPERADMIN to this user and become ADMIN yourself?"
            );
            if (!ok) return;
            await promoteToSuperadminSwapClientSide(admin.id);
          });
        }
      }

      function wireActionsForIn(container, admin) {
        var approveBtn = container.querySelector("#approveBtn");
        var rejectBtn = container.querySelector("#rejectBtn");
        var demoteBtn = container.querySelector("#demoteBtn");
        var promoteBtn = container.querySelector("#promoteBtn");

        if (approveBtn) {
          approveBtn.addEventListener("click", async function () {
            await setRole(admin.id, "admin");
            var updated =
              admins.find(function (x) {
                return x.id === admin.id;
              }) || admin;
            injectDetailsIntoModal(updated);
          });
        }

        if (rejectBtn) {
          rejectBtn.addEventListener("click", async function () {
            var ok = confirm(
              "Reject this profile (" +
                admin.email +
                ")? This deletes the user from auth and removes their admin row."
            );
            if (!ok) return;
            await rejectProfileDeleteAuthUser(admin.id);
            closeDetailsModal();
          });
        }

        if (demoteBtn) {
          demoteBtn.addEventListener("click", async function () {
            var ok = confirm("Demote " + admin.email + " to Pending?");
            if (!ok) return;
            await setRole(admin.id, "pending");
            var updated =
              admins.find(function (x) {
                return x.id === admin.id;
              }) || admin;
            injectDetailsIntoModal(updated);
          });
        }

        if (promoteBtn) {
          promoteBtn.addEventListener("click", async function () {
            var ok = confirm(
              "Transfer SUPERADMIN to this user and become ADMIN yourself?"
            );
            if (!ok) return;
            await promoteToSuperadminSwapClientSide(admin.id);
            var updated =
              admins.find(function (x) {
                return x.id === admin.id;
              }) || admin;
            injectDetailsIntoModal(updated);
          });
        }
      }

      async function setRole(id, role) {
        try {
          const { error } = await supabase
            .from("admin")
            .update({ role: role })
            .eq("id", id);
          if (error) {
            alert("Failed to set role: " + (error.message || "Unknown error"));
            return;
          }

          var keepId = activeAdminId;
          await refreshAdmins();
          var updated =
            admins.find(function (a) {
              return a.id === keepId;
            }) || admins[0];

          if (updated) {
            activeAdminId = updated.id;
            renderDetails(updated);
            if (isMobile() && detailsModal.classList.contains("open")) {
              injectDetailsIntoModal(updated);
            }
          }

          alert("Role updated to " + role.toUpperCase() + ".");
        } catch (e) {
          alert("Unexpected error: " + (e && e.message ? e.message : e));
        }
      }

      async function reloadMyRole() {
        const res = await supabase
          .from("admin")
          .select("role")
          .eq("id", currentUser.id)
          .maybeSingle();
        if (!res.error && res.data) {
          currentRole = res.data.role || null;
        }
      }

      async function promoteToSuperadminSwapClientSide(targetId) {
        const r1 = await supabase
          .from("admin")
          .update({ role: "admin" })
          .eq("id", currentUser.id);

        if (r1.error) {
          alert("Could not demote yourself: " + r1.error.message);
          return;
        }

        const r2 = await supabase
          .from("admin")
          .update({ role: "superadmin" })
          .eq("id", targetId);

        if (r2.error) {
          const restore = await supabase
            .from("admin")
            .update({ role: "superadmin" })
            .eq("id", currentUser.id);

          if (restore.error) {
            alert(
              "Promotion failed (" +
                r2.error.message +
                ") and restoring your superadmin role also failed (" +
                restore.error.message +
                "). Please check roles manually."
            );
          } else {
            alert(
              "Promotion failed: " +
                r2.error.message +
                ". Your superadmin role was restored."
            );
          }

          await reloadMyRole();
          await refreshAdmins();
          return;
        }

        await reloadMyRole();
        await refreshAdmins();

        var selected =
          admins.find(function (a) {
            return a.id === targetId;
          }) || admins[0];

        if (selected) {
          activeAdminId = selected.id;
          renderDetails(selected);
          if (isMobile() && detailsModal.classList.contains("open")) {
            injectDetailsIntoModal(selected);
          }
        }

        alert("Superadmin role transferred.");
      }

      async function rejectProfileDeleteAuthUser(userId) {
        const { data, error } = await supabase.functions.invoke(
          "admin-delete-user",
          { body: { user_id: userId } }
        );

        if (error) {
          alert(
            "Failed to delete auth user: " +
              (error.message || JSON.stringify(error))
          );
          return;
        }

        const payload = typeof data === "string" ? JSON.parse(data) : data;

        if (payload && payload.ok === true) {
          await refreshAdmins();
          detailsPane.innerHTML =
            '<div class="empty-state">Select a profile on the left to review full details.</div>';
          alert("User rejected and removed from authentication.");
        } else {
          alert(
            "Auth deletion did not report success. Response: " +
              JSON.stringify(payload)
          );
        }
      }

      function maybeOpenMobileModal(admin) {
        if (isMobile()) {
          injectDetailsIntoModal(admin);
          openDetailsModal();
        }
      }

      function injectDetailsIntoModal(admin) {
        detailsModalBody.innerHTML = detailsPane.innerHTML;

        var modalAvatar = detailsModalBody.querySelector("#detailAvatar");
        applyAvatarToEl(modalAvatar, avatarCache[admin.id]);

        wireActionsForIn(detailsModalBody, admin);
      }

      function openDetailsModal() {
        detailsModal.classList.add("open");
        detailsModal.setAttribute("aria-hidden", "false");
        if (
          detailsModalClose &&
          typeof detailsModalClose.focus === "function"
        ) {
          detailsModalClose.focus();
        }
      }

      function closeDetailsModal() {
        detailsModal.classList.remove("open");
        detailsModal.setAttribute("aria-hidden", "true");
      }
    </script>
  </body>
</html>
