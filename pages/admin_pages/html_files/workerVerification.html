<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="../css_files/sideBar.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <title>Worker Verification</title>

  <style>
    :root {
      --ink: #1c2430;
      --muted: #6c7a8a;
      --line: #e7edf3;
      --brand: #20a44c;
      --warn: #f59e0b;
      --danger: #e53935;
      --bg: #f8fbfd;
      --card: #ffffff;
      --pill: #eef6ff;
      --radius: 14px;
      --modal-bg: #ffffff;
      --modal-head: #f7fbff;
      --shadow-xl: 0 24px 60px rgba(16, 24, 40, .18);
      --shadow-lg: 0 12px 30px rgba(16, 24, 40, .12);
      /* Skeleton */
      --skel-base: #eef3f7;
      --skel-sheen: #f7fafc;
    }

    .workers-wrap {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 1rem;
    }

    @media (max-width:980px) {
      .workers-wrap {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
    }

    .panel h3 {
      margin: 0 0 .5rem 0;
      font-size: 1rem;
      font-weight: bold;
    }

    .search {
      position: relative;
      margin-bottom: .6rem;
    }

    .search input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px 10px 36px;
      outline: none;
      background: #fcfeff;
    }

    .search .material-icons-sharp {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--muted);
    }

    .worker-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 70vh;
      overflow: auto;
    }

    .worker-item {
      display: grid;
      grid-template-columns: 40px 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      cursor: pointer;
      transition: background .15s, transform .06s;
      background: #fff;
    }

    .worker-item:hover {
      background: #f6fafc;
    }

    .worker-item:active {
      transform: scale(.997);
    }

    .worker-item.active {
      outline: 2px solid var(--brand);
      background: #f3fdf7;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--line);
    }

    .pill {
      font-size: .75rem;
      background: var(--pill);
      padding: 4px 8px;
      border-radius: 999px;
      color: #2463a6;
      border: 1px solid #d6e9ff;
      white-space: nowrap;
    }

    .details {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: clip;
    }

    .details .head {
      display: flex;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--line);
      align-items: center;
      background: linear-gradient(180deg, #f9fbff, #ffffff);
      
    }

    .details .head img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
    }

    .details .head .name {
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0 0 2px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .meta .kv {
      font-size: .85rem;
      color: var(--muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 16px;
    }

    @media (max-width:980px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .card h4 {
      margin: 0 0 .6rem;
      font-size: .95rem;
    }

    .info-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      font-size: .95rem;
    }

    @media (max-width:640px) {
      .info-list {
        grid-template-columns: 1fr;
      }
    }

    .info-list .label {
      color: var(--muted);
      font-size: .85rem;
      display: block;
    }

    .doc-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 10px;
    }

    .doc {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 6px;
      background: #fcfeff;
    }

    .doc .doc-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .doc .actions {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
      line-height: 1;
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
      transition: box-shadow .2s, transform .06s, background .2s;
    }

    .btn:hover {
      box-shadow: var(--shadow-lg);
      background: #fafcff;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.primary {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    .btn.reject {
      background: #fff5f5;
      color: var(--danger);
      border-color: #ffd7d7;
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .status-dot {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .85rem;
      color: var(--muted);
    }

    .status-dot .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #cbd5e1;
    }

    .status-dot.approved .dot {
      background: var(--brand);
    }

    .status-dot.rejected .dot {
      background: var(--danger);
    }

    .status-dot.pending .dot {
      background: #94a3b8;
    }

    .status-dot.missing .dot {
      background: #cbd5e1;
    }

    .hint {
      font-size: .85rem;
      color: var(--muted);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(14, 25, 42, .5);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
      opacity: 0;
      transition: opacity .2s;
    }

    .modal.open {
      display: flex;
      opacity: 1;
    }

    .modal-card {
      width: min(1080px, 96vw);
      height: min(80vh, 900px);
      background: var(--modal-bg);
      border-radius: 16px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      box-shadow: var(--shadow-xl);
      border: 1px solid #eef2f7;
      animation: zoomIn .18s ease-out;
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: var(--modal-head);
    }

    .modal-head h4 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .modal-body {
      background: #fff;
      position: relative;
    }

    .modal-body iframe,
    .modal-body img {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    @keyframes zoomIn {
      from {
        transform: scale(.98);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @media (max-width:980px) {
      .worker-item {
        grid-template-columns: 40px 1fr 24px;
        padding: 8px;
      }

      .worker-item .pill {
        justify-self: end;
      }

      .worker-item div:nth-child(2) div:nth-child(2) {
        font-size: .78rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 60vw;
      }

      .details {
        display: none;
      }

      .details.as-modal {
        display: grid;
        position: fixed;
        inset: 0;
        z-index: 900;
        background: var(--modal-bg);
        border-radius: 16px;
        border: 1px solid #eef2f7;
        box-shadow: var(--shadow-xl);
        grid-template-rows: auto 1fr;
        overflow: hidden;
        animation: slideUp .18s ease-out;
      }

      .details.as-modal .head {
        position: sticky;
        top: 0;
        z-index: 2;
        background: linear-gradient(180deg, #f9fbff, #ffffff);
        border-bottom: 1px solid var(--line);
        padding: 12px;
      }

      .details.as-modal .scroll-body {
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        background: #fff;
      }

      @keyframes slideUp {
        from {
          transform: translateY(8px);
          opacity: 0;
        }

        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .mobile-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(14, 25, 42, .45);
        backdrop-filter: blur(2px);
        z-index: 880;
        display: none;
        opacity: 0;
        transition: opacity .2s;
      }

      .mobile-backdrop.show {
        display: block;
        opacity: 1;
      }

      .btn {
        font-size: 0;
        padding: 10px;
      }

      .btn .material-icons-sharp {
        font-size: 20px;
      }

      .btn .btn-text {
        display: none;
      }

      .card {
        padding: 10px;
      }

      .grid-2 {
        padding: 12px;
        gap: 10px;
      }
    }

    @media (max-width:420px) {
      .doc-list {
        grid-template-columns: 1fr;
      }

      .details .head img {
        width: 56px;
        height: 56px;
      }

      .details .head .name {
        font-size: 1rem;
      }

      .pill {
        font-size: .7rem;
        padding: 3px 6px;
      }

      .modal-card {
        width: 94vw;
        height: 78vh;
      }
    }

    .empty-state {
      padding: 24px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      background: #fbfeff;
      text-align: center;
      color: var(--muted);
    }

    /* ========== SKELETON CONTROL & STYLES ========== */
    /* Default: hide skeleton, show real */
    #loadingSkeleton {
      display: none;
    }

    /* When loading: force skeleton visible and real UI hidden */
    body.is-loading #loadingSkeleton {
      display: grid !important;
    }

    body.is-loading .workers-wrap {
      display: none !important;
    }

    body.is-loaded #loadingSkeleton {
      display: none !important;
    }

    body.is-loaded .workers-wrap {
      display: grid !important;
    }

    #loadingSkeleton {
      grid-template-columns: 340px 1fr;
      gap: 1rem;
    }

    @media (max-width:980px) {
      #loadingSkeleton {
        grid-template-columns: 1fr;
      }
    }

    .skel-panel,
    .skel-card,
    .skel-details {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
    }

    .skel-block {
      position: relative;
      background: var(--skel-base);
      overflow: hidden;
      border-radius: 8px;
    }

    .skel-circle {
      border-radius: 999px;
    }

    .skel-animate::before {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, var(--skel-sheen) 50%, rgba(255, 255, 255, 0) 100%);
      animation: skel-sheen 1.2s infinite;
    }

    @keyframes skel-sheen {
      100% {
        transform: translateX(100%);
      }
    }

    .skel-panel {
      padding: 12px;
    }

    .skel-title {
      width: 40%;
      height: 16px;
    }

    .skel-search {
      margin: 10px 0;
      height: 38px;
      border-radius: 10px;
    }

    .skel-chip {
      width: 30%;
      height: 36px;
      margin-bottom: 8px;
      border-radius: 10px;
    }

    .skel-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 70vh;
      overflow: hidden;
    }

    .skel-row {
      display: grid;
      grid-template-columns: 40px 1fr 60px;
      gap: 10px;
      align-items: center;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }

    .skel-avatar {
      width: 40px;
      height: 40px;
    }

    .skel-line {
      height: 12px;
    }

    .skel-line.w70 {
      width: 70%;
    }

    .skel-line.w50 {
      width: 50%;
    }

    .skel-pill {
      width: 60px;
      height: 22px;
      border-radius: 999px;
    }

    .skel-details .skel-head {
      display: flex;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, #f9fbff, #ffffff);
    }

    .skel-details .skel-avatar-lg {
      width: 72px;
      height: 72px;
    }

    .skel-details .skel-head-lines {
      flex: 1;
      display: grid;
      gap: 8px;
    }

    .skel-actions {
      display: flex;
      gap: 8px;
    }

    .skel-btn {
      width: 120px;
      height: 36px;
      border-radius: 10px;
    }

    .skel-body {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width:980px) {
      .skel-body {
        grid-template-columns: 1fr;
      }
    }

    .skel-card {
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .skel-card .skel-section-title {
      width: 35%;
      height: 14px;
    }

    .skel-kv {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
    }

    .skel-kv .skel-key {
      width: 60%;
      height: 10px;
    }

    .skel-kv .skel-val {
      width: 80%;
      height: 12px;
    }

    .skel-docs {
      margin: 0 16px 16px;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      display: grid;
      gap: 10px;
    }

    .skel-doc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 10px;
    }

    .skel-doc-tile {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .skel-doc-title {
      width: 70%;
      height: 12px;
    }

    .skel-doc-btn {
      width: 90px;
      height: 30px;
      border-radius: 8px;
    }

    .skel-doc-status {
      width: 50%;
      height: 10px;
      border-radius: 6px;
    }

    @media (max-width:980px) {
      .skel-row {
        grid-template-columns: 40px 1fr 24px;
      }

      .skel-pill {
        width: 24px;
        height: 24px;
        border-radius: 8px;
      }

      .skel-actions .skel-btn {
        width: 44px;
      }
    }
  </style>
</head>

<!-- Start in loading state -->

<body class="is-loading">
  <div class="container">
    <aside>
      <div class="toggle">
        <div class="logo">
          <img src="../../../img/simpHappyMascotLogo.png" alt="logo" />
          <h2>SIMP<span class="danger">Project</span></h2>
        </div>
        <div class="close" id="close-btn">
          <span class="material-icons-sharp">close</span>
        </div>
      </div>

      <div class="sidebar">
        <a href="dashboard.html"><span class="material-icons-sharp">dashboard</span>
          <h3>Dashboard</h3>
        </a>
        <a href="workerVerification.html" class="active"><span class="material-icons-sharp">engineering</span>
          <h3>Workers<br />Verification</h3>
        </a>
        <a href="jobVerification.html"><span class="material-icons-sharp">work</span>
          <h3>Jobs<br />Verification</h3>
        </a>
        <a href="jobApplicationVerification.html"><span class="material-icons-sharp">approval</span>
          <h3>Application<br />Verification</h3>
        </a>
        <a href="adminVerification.html"><span class="material-icons-sharp">shield</span>
          <h3>Admin<br />Verification</h3>
        </a>
        <a href="manageShop.html"><span class="material-icons-sharp">shop</span>
          <h3>Manage<br />Shop</h3>
        </a>
        <a href="paymentsRequest.html"><span class="material-icons-sharp">payments</span>
          <h3>Payments<br />Request</h3>
        </a>
        <a href="courses.html"><span class="material-icons-sharp">school</span>
          <h3>Course<br />Publisher</h3>
        </a>
        <a href="settings.html"><span class="material-icons-sharp">settings</span>
          <h3>Settings</h3>
        </a>
        <a href="#" id="logout-btn"><span class="material-icons-sharp">logout</span>
          <h3>Logout</h3>
        </a>
      </div>
    </aside>

    <main>
      <section id="tab-workers">
        <!-- SKELETON -->
        <div id="loadingSkeleton" aria-hidden="true">
          <!-- Left panel skeleton -->
          <div class="skel-panel">
            <div class="skel-block skel-title skel-animate"></div>
            <div class="skel-block skel-search skel-animate"></div>
            <div class="skel-block skel-chip skel-animate"></div>

            <div class="skel-list">
              <!-- Repeat rows -->
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
              <div class="skel-row">
                <div class="skel-block skel-circle skel-avatar skel-animate"></div>
                <div>
                  <div class="skel-block skel-line w70 skel-animate" style="margin-bottom:6px;"></div>
                  <div class="skel-block skel-line w50 skel-animate"></div>
                </div>
                <div class="skel-block skel-pill skel-animate"></div>
              </div>
            </div>
          </div>

          <!-- Right details skeleton -->
          <div class="skel-details">
            <div class="skel-head">
              <div class="skel-block skel-circle skel-avatar-lg skel-animate"></div>
              <div class="skel-head-lines">
                <div class="skel-block skel-line skel-animate" style="width:40%;height:16px;"></div>
                <div class="skel-block skel-line skel-animate" style="width:70%;height:12px;"></div>
                <div class="skel-block skel-line skel-animate" style="width:55%;height:12px;"></div>
              </div>
              <div class="skel-actions">
                <div class="skel-block skel-btn skel-animate"></div>
                <div class="skel-block skel-btn skel-animate"></div>
              </div>
            </div>

            <div class="skel-body">
              <div class="skel-card">
                <div class="skel-block skel-section-title skel-animate"></div>
                <div class="skel-kv">
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                </div>
              </div>
              <div class="skel-card">
                <div class="skel-block skel-section-title skel-animate"></div>
                <div class="skel-kv">
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                  <div class="skel-key skel-block skel-animate"></div>
                  <div class="skel-val skel-block skel-animate"></div>
                </div>
              </div>
            </div>

            <div class="skel-docs">
              <div class="skel-block skel-section-title skel-animate" style="width:30%;"></div>
              <div class="skel-doc-grid">
                <div class="skel-doc-tile">
                  <div class="skel-block skel-doc-title skel-animate"></div>
                  <div class="skel-block skel-doc-btn skel-animate"></div>
                  <div class="skel-block skel-doc-status skel-animate"></div>
                </div>
                <div class="skel-doc-tile">
                  <div class="skel-block skel-doc-title skel-animate"></div>
                  <div class="skel-block skel-doc-btn skel-animate"></div>
                  <div class="skel-block skel-doc-status skel-animate"></div>
                </div>
                <div class="skel-doc-tile">
                  <div class="skel-block skel-doc-title skel-animate"></div>
                  <div class="skel-block skel-doc-btn skel-animate"></div>
                  <div class="skel-block skel-doc-status skel-animate"></div>
                </div>
                <div class="skel-doc-tile">
                  <div class="skel-block skel-doc-title skel-animate"></div>
                  <div class="skel-block skel-doc-btn skel-animate"></div>
                  <div class="skel-block skel-doc-status skel-animate"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- REAL CONTENT -->
        <div class="workers-wrap">
          <div class="panel">
            <h3>New Sign-Ups</h3>
            <div class="search">
              <span class="material-icons-sharp">search</span>
              <input id="searchInput" type="text" placeholder="Search name, email, phone…" />
            </div>
            <div style="margin-bottom:.6rem">
              <select id="statusFilter"
                style="width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fcfeff;outline:none;">
                <option value="">All statuses</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div id="workerList" class="worker-list"></div>
            <div id="emptyWorkers" class="empty-state" style="display:none">No workers found.</div>
          </div>

          <div class="details" id="detailsPane">
            <div class="empty-state">Select a worker on the left to review their profile & documents.</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="mobileBackdrop" class="mobile-backdrop"></div>

  <div id="docModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="docTitle">
    <div class="modal-card">
      <div class="modal-head">
        <h4 id="docTitle">Document</h4>
        <button class="btn" id="closeModal" aria-label="Close document"><span
            class="material-icons-sharp">close</span></button>
      </div>
      <div class="modal-body" id="docBody"></div>
    </div>
  </div>

  <script src="../../general_files/index.js"></script>
  <script type="module" src="../../general_files/session.js"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script type="module">
    const { createClient } = supabase;
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");
    const workerList = document.getElementById("workerList");
    const emptyWorkers = document.getElementById("emptyWorkers");
    const detailsPane = document.getElementById("detailsPane");
    const docModal = document.getElementById("docModal");
    const docBody = document.getElementById("docBody");
    const docTitle = document.getElementById("docTitle");
    const mobileBackdrop = document.getElementById("mobileBackdrop");

    let WORKERS = [];
    let ACTIVE_ID = null;
    const DOC_REVIEW = new Map();

    function startLoading() { document.body.classList.add('is-loading'); document.body.classList.remove('is-loaded'); }
    function stopLoading() { document.body.classList.remove('is-loading'); document.body.classList.add('is-loaded'); }

    const cap = (s = "") => (s ? s[0].toUpperCase() + s.slice(1) : s);
    function pravatar(id) { const num = (Math.abs([...String(id)].reduce((a, c) => a + c.charCodeAt(0), 0)) % 70) + 1; return `https://i.pravatar.cc/150?img=${num}`; }
    function withOwnerPrefix(path, ownerId) { if (!path) return ""; let key = String(path).replace(/^\/+/, ""); if (ownerId && !key.startsWith(ownerId + "/")) key = `${ownerId}/${key}`; return key; }
    async function getSignedUrlWithOwner(path, ownerId, expiresIn = 3600) { if (!path) return ""; if (/^https?:\/\//i.test(path)) return path; const key = withOwnerPrefix(path, ownerId); const { data, error } = await sb.storage.from("documents_review").createSignedUrl(key, expiresIn, { download: false }); if (error) { console.error("Signed URL error:", error, "for", key); return ""; } return data?.signedUrl || ""; }
    function fmtDateISO(d) { if (!d) return ""; const dt = new Date(d); if (isNaN(+dt)) return ""; return dt.toLocaleString(); }
    function parseStorageUrl(u) { try { if (typeof u !== "string") return null; if (/^https?:\/\//i.test(u)) return { bucket: null, key: null, https: u }; const m = u.match(/^storage:\/\/([^/]+)\/(.+)$/i); if (!m) return null; return { bucket: m[1], key: m[2] }; } catch { return null } }
    async function signFromBucket(bucket, key, expiresIn = 3600) { try { const { data, error } = await sb.storage.from(bucket).createSignedUrl(key, expiresIn, { download: false }); if (!error && data?.signedUrl) return data.signedUrl; const { data: pub } = sb.storage.from(bucket).getPublicUrl(key); return pub?.publicUrl || ""; } catch (e) { console.error("Avatar signing error:", e); const { data: pub } = sb.storage.from(bucket).getPublicUrl(key); return pub?.publicUrl || ""; } }
    async function resolveProfileAvatar(profilePicUrl, ownerId) { if (!profilePicUrl) return pravatar(ownerId); const parsed = parseStorageUrl(profilePicUrl); if (!parsed) return /^https?:\/\//i.test(profilePicUrl) ? profilePicUrl : pravatar(ownerId); if (parsed.https) return parsed.https; let key = parsed.key; if (ownerId && !key.startsWith(ownerId + "/")) key = `${ownerId}/${key.replace(/^\/+/, "")}`; const url = await signFromBucket(parsed.bucket, key); return url || pravatar(ownerId); }

    async function fetchWorkers() {
      startLoading();
      try {
        const { data: docsRows, error: docsErr } = await sb
          .from("installer_documents")
          .select(`
              installer_id,
              nbi, nbi_status,
              police, police_status,
              resume, resume_status,
              portfolio, portfolio_status,
              certificates, certificates_status,
              tor, tor_status,
              status, uploaded_at, updated_at
            `)
          .order("uploaded_at", { ascending: false });

        if (docsErr) {
          console.error("installer_documents error:", docsErr);
          workerList.innerHTML = ""; emptyWorkers.style.display = "block";
          detailsPane.innerHTML = `<div class="empty-state">Could not load workers: ${docsErr.message}</div>`;
          return;
        }

        if (!docsRows || docsRows.length === 0) {
          WORKERS = []; renderWorkerList();
          detailsPane.innerHTML = `<div class="empty-state">No workers to review.</div>`;
          return;
        }

        const ids = [...new Set(docsRows.map(r => r.installer_id))];
        const { data: profiles, error: profErr } = await sb
          .from("installer")
          .select('id, email, name, birthdate, age, phone, profession, "highestQualification", "employmentStatus", "mainIncomeSource", "bankName", "accountNumber", "accountHolder", "createdAt", profile_pic_url')
          .in("id", ids);
        if (profErr) console.error("installer error:", profErr);
        const profById = new Map((profiles || []).map(p => [p.id, p]));

        WORKERS = docsRows.map(r => {
          const p = profById.get(r.installer_id) || {};
          return {
            id: r.installer_id,
            avatar: pravatar(r.installer_id),
            fullName: p.name || "(No name)",
            birthdate: p.birthdate || "",
            age: p.age ?? "",
            phone: p.phone || "",
            email: p.email || "",
            role: "worker",
            profession: p.profession || "",
            highestQualification: p.highestQualification || "",
            employmentStatus: p.employmentStatus || "",
            mainIncomeSource: p.mainIncomeSource || "",
            bankName: p.bankName || "",
            accountHolder: p.accountHolder || "",
            accountNumber: p.accountNumber || "",
            createdAt: r.uploaded_at || p.createdAt || null,
            profileStatus: String(r.status || "Pending").toLowerCase(),
            _rawDocs: r,
            _profilePicUrl: p.profile_pic_url || null,
          };
        });

        for (const w of WORKERS) { DOC_REVIEW.set(w.id, buildDocRows(w._rawDocs)); }
        await Promise.all(WORKERS.map(w => signAllDocsForInstaller(w.id)));
        await Promise.all(WORKERS.map(async w => {
          try { if (w._profilePicUrl) { const url = await resolveProfileAvatar(w._profilePicUrl, w.id); if (url) w.avatar = url; } } catch (e) { console.warn("Avatar resolve failed for", w.id, e); }
        }));

        renderWorkerList();
        if (WORKERS.length) {
          const keep = WORKERS.find(w => w.id === ACTIVE_ID) ? ACTIVE_ID : WORKERS[0].id;
          ACTIVE_ID = keep;
          const found = WORKERS.find(w => w.id === ACTIVE_ID);
          renderDetails(found);
          markActiveTile(ACTIVE_ID);
        }
      } finally {
        stopLoading();
      }
    }

    function buildDocRows(raw) {
      const ownerId = raw?.installer_id || "";
      const rows = [];
      const singleDocs = [
        ["resume", "Resume", "resume_status"],
        ["nbi", "NBI Clearance", "nbi_status"],
        ["police", "Police Clearance", "police_status"],
        ["tor", "Transcript of Records (TOR)", "tor_status"],
        ["portfolio", "Portfolio", "portfolio_status"],
      ];
      for (const [key, label, statusKey] of singleDocs) {
        const path = raw?.[key] || null;
        const st = String(raw?.[statusKey] || (path ? "pending" : "missing")).toLowerCase();
        rows.push({ key, type: label, path: path ? withOwnerPrefix(path, ownerId) : "", url: "", status: path ? st : "missing" });
      }
      const certs = Array.isArray(raw?.certificates) ? raw.certificates : [];
      const certStatuses = Array.isArray(raw?.certificates_status) ? raw.certificates_status : [];
      if (certs.length === 0) {
        rows.push({ key: "certificates", type: "Certificates (none)", path: "", url: "", status: "missing" });
      } else {
        certs.forEach((c, idx) => {
          const st = String(certStatuses[idx] || "pending").toLowerCase();
          rows.push({ key: `certificates[${idx}]`, type: `Certificate #${idx + 1}`, path: withOwnerPrefix(c, ownerId), url: "", status: st });
        });
      }
      return rows;
    }

    async function signAllDocsForInstaller(installerId) {
      const list = (DOC_REVIEW.get(installerId) || []).slice();
      if (!list.length) return;
      const signed = await Promise.all(list.map(async item => {
        if (!item.path) return { ...item, url: "" };
        const owner = installerId;
        const url = await getSignedUrlWithOwner(item.path.replace(new RegExp("^" + owner + "/"), ""), owner);
        return { ...item, url };
      }));
      DOC_REVIEW.set(installerId, signed);
    }

    function renderWorkerList(filter = "") {
      workerList.innerHTML = "";
      const selectedStatus = (statusFilter?.value || "").toLowerCase();
      const q = filter.trim().toLowerCase();

      const filtered = WORKERS.filter(w => {
        const inText = !q || w.fullName.toLowerCase().includes(q) || w.email.toLowerCase().includes(q) || (w.phone || "").toLowerCase().includes(q);
        const wStatus = (w.profileStatus || "pending").toLowerCase();
        const inStatus = !selectedStatus || (selectedStatus === "approved" ? (wStatus === "approved" || wStatus === "verified") : wStatus === selectedStatus);
        return inText && inStatus;
      });

      emptyWorkers.style.display = filtered.length ? "none" : "block";

      filtered.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
        .forEach(w => {
          const item = document.createElement("div");
          item.className = "worker-item";
          item.dataset.id = w.id;
          if (w.id === ACTIVE_ID) item.classList.add("active");
          item.innerHTML = `
              <img class="avatar" src="${w.avatar}" alt="${w.fullName}">
              <div>
                <div style="font-weight:700">${w.fullName}</div>
                <div style="font-size:.85rem;color:var(--muted)">${w.email}</div>
              </div>
              <span class="pill">${cap(w.profileStatus || "pending")}</span>
            `;
          item.addEventListener("click", async () => {
            ACTIVE_ID = w.id;
            markActiveTile(ACTIVE_ID);
            await signAllDocsForInstaller(w.id);
            renderDetails(w);
            if (window.matchMedia("(max-width: 980px)").matches) { openMobileDetails(); }
          });
          workerList.appendChild(item);
        });
    }

    function markActiveTile(id) {
      document.querySelectorAll(".worker-item").forEach(i => i.classList.remove("active"));
      const el = document.querySelector(`.worker-item[data-id="${id}"]`);
      if (el) el.classList.add("active");
    }

    searchInput.addEventListener("input", (e) => renderWorkerList(e.target.value));
    statusFilter.addEventListener("change", () => renderWorkerList(searchInput.value));

    function renderDetails(worker) {
      if (!worker) { detailsPane.innerHTML = `<div class="empty-state">Select a worker to review.</div>`; return; }

      const docs = DOC_REVIEW.get(worker.id) || [];
      const status = (worker.profileStatus || "pending").toLowerCase();
      const isPending = status === "pending";

      let actionsHTML = "";
      if (status === "pending") {
        actionsHTML = `
            <button class="btn reject" id="rejectProfileBtn" aria-label="Reject profile">
              <span class="material-icons-sharp">thumb_down</span> <span class="btn-text">Reject Profile</span>
            </button>
            <button class="btn primary" id="approveProfileBtn" aria-label="Approve installer">
              <span class="material-icons-sharp">thumb_up</span> <span class="btn-text">Approve Installer</span>
            </button>
          `;
      } else {
        actionsHTML = `
            <button class="btn" id="revertPendingBtn" title="Set overall status back to Pending" aria-label="Revert to pending">
              <span class="material-icons-sharp">history</span> <span class="btn-text">Revert to Pending</span>
            </button>
          `;
      }

      const isMobile = window.matchMedia("(max-width: 980px)").matches;
      const closeMobileBtn = isMobile ? `<button class="btn" id="closeDetailsMobile" aria-label="Close details"><span class="material-icons-sharp">close</span><span class="btn-text">Close</span></button>` : "";

      detailsPane.innerHTML = `
          <div class="head">
            <img src="${worker.avatar}" alt="${worker.fullName}">
            <div>
              <div class="name">
                ${worker.fullName}
                <span class="pill" id="profileStatusPill">${cap(worker.profileStatus || "pending")}</span>
              </div>
              <div class="meta">
                <span class="kv"><strong>Uploaded:</strong> ${fmtDateISO(worker.createdAt) || "—"}</span>
                <span class="kv"><strong>Birthdate:</strong> ${worker.birthdate || "—"}</span>
                <span class="kv"><strong>Age:</strong> ${worker.age || "—"}</span>
                <span class="kv"><strong>Phone:</strong> ${worker.phone || "—"}</span>
                <span class="kv"><strong>Email:</strong> ${worker.email || "—"}</span>
                <span class="kv"><strong>Role:</strong> Worker</span>
              </div>
            </div>

            <div style="display:flex; gap:8px; margin-left:auto; align-items:center;">
              ${actionsHTML}
              ${closeMobileBtn}
            </div>
          </div>

          <div class="scroll-body">
            <div class="grid-2">
              <div class="card">
                <h4>Basic Information</h4>
                <div class="info-list">
                  <div><span class="label">Full Name</span>${worker.fullName}</div>
                  <div><span class="label">Profession</span>${worker.profession || "—"}</div>
                  <div><span class="label">Highest Qualification</span>${worker.highestQualification || "—"}</div>
                  <div><span class="label">Employment Status</span>${worker.employmentStatus || "—"}</div>
                  <div><span class="label">Main Income Source</span>${worker.mainIncomeSource || "—"}</div>
                </div>
              </div>

              <div class="card">
                <h4>Bank Details</h4>
                <div class="info-list">
                  <div><span class="label">Bank Name</span>${worker.bankName || "—"}</div>
                  <div><span class="label">Account Holder</span>${worker.accountHolder || "—"}</div>
                  <div><span class="label">Account Number</span>${worker.accountNumber || "—"}</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin: 0 16px 16px">
              <h4>Submitted Documents</h4>
              <p class="hint">Click a document to preview. Approve/Reject each individually. All present documents must be <b>Approved</b> to enable "Approve Installer". Missing files block approval.</p>
              <div class="doc-list">
                ${docs.map((d, idx) => `
                  <div class="doc" data-doc="${idx}">
                    <div class="doc-title"><span class="material-icons-sharp">description</span> ${d.type}</div>
                    <button class="btn" data-view="${idx}" ${d.url ? "" : "disabled"} aria-label="Preview ${d.type}">
                      <span class="material-icons-sharp" style="font-size:18px;">visibility</span> <span class="btn-text">Preview</span>
                    </button>
                    <div class="status-dot ${d.status}">
                      <span class="dot"></span>
                      <span class="label">${cap(d.status)}</span>
                    </div>
                    <div class="actions" ${status === "pending" ? "" : 'style="display:none"'}>
                      <button class="btn primary" data-approve="${idx}" ${d.path ? "" : "disabled"} aria-label="Approve ${d.type}">
                        <span class="material-icons-sharp">check</span> <span class="btn-text">Approve</span>
                      </button>
                      <button class="btn reject" data-reject="${idx}" ${d.path ? "" : "disabled"} aria-label="Reject ${d.type}">
                        <span class="material-icons-sharp">close</span> <span class="btn-text">Reject</span>
                      </button>
                    </div>
                  </div>
                `).join("")}
              </div>
            </div>
          </div>
        `;

      detailsPane.querySelectorAll("[data-view]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const idx = Number(btn.dataset.view);
          const item = (DOC_REVIEW.get(worker.id) || [])[idx];
          if (!item) return;
          if (!item.url && item.path) {
            const freshUrl = await getSignedUrlWithOwner(item.path.replace(new RegExp("^" + worker.id + "/"), ""), worker.id);
            item.url = freshUrl;
            DOC_REVIEW.set(worker.id, (DOC_REVIEW.get(worker.id) || []).map((x, i) => i === idx ? item : x));
            if (freshUrl) { openDoc(item.type, freshUrl); btn.disabled = false; return; }
          }
          if (!item.url) { alert("Preview unavailable. File missing or you lack permission."); return; }
          openDoc(item.type, item.url);
        });
      });

      detailsPane.querySelectorAll("[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => { const idx = Number(btn.dataset.approve); await setDocStatus(worker.id, idx, "approved"); });
      });
      detailsPane.querySelectorAll("[data-reject]").forEach(btn => {
        btn.addEventListener("click", async () => { const idx = Number(btn.dataset.reject); await setDocStatus(worker.id, idx, "rejected"); });
      });

      const approveBtn = detailsPane.querySelector("#approveProfileBtn");
      const rejectBtn = detailsPane.querySelector("#rejectProfileBtn");
      const revertBtn = detailsPane.querySelector("#revertPendingBtn");

      if (approveBtn) {
        approveBtn.disabled = !allPresentDocsApproved(docs);
        approveBtn.addEventListener("click", async () => {
          if (!allPresentDocsApproved(docs)) { alert("You must Approve all present documents first."); return; }
          await setOverallStatus(worker.id, "approved");
        });
      }
      if (rejectBtn) { rejectBtn.addEventListener("click", async () => { await setOverallStatus(worker.id, "rejected"); }); }
      if (revertBtn) { revertBtn.addEventListener("click", async () => { await setOverallStatus(worker.id, "pending"); }); }

      const closeMobile = document.getElementById("closeDetailsMobile");
      if (closeMobile) closeMobile.addEventListener("click", closeMobileDetails);
    }

    function allPresentDocsApproved(docs) { for (const d of docs) { if (d.status !== "approved") return false; } return docs.length > 0; }

    async function setDocStatus(installerId, docIndex, status) {
      const list = DOC_REVIEW.get(installerId) || [];
      const item = list[docIndex]; if (!item) return;
      item.status = status; DOC_REVIEW.set(installerId, list);
      const w = WORKERS.find(x => x.id === installerId); if (w) renderDetails(w);

      try {
        await persistDocStatus(installerId, item.key, status);
        const { data, error } = await sb
          .from("installer_documents")
          .select(`
              installer_id,
              nbi, nbi_status,
              police, police_status,
              resume, resume_status,
              portfolio, portfolio_status,
              certificates, certificates_status,
              tor, tor_status,
              status, uploaded_at, updated_at
            `).eq("installer_id", installerId).maybeSingle();
        if (!error && data) {
          const freshRows = buildDocRows(data);
          DOC_REVIEW.set(installerId, freshRows);
          await signAllDocsForInstaller(installerId);
          if (w) { w._rawDocs = data; renderDetails(w); }
        }
      } catch (e) { alert("Failed to update document status: " + (e.message || e)); }
    }

    async function persistDocStatus(installerId, docKey, toStatus) {
      const singleStatusCols = { resume: "resume_status", nbi: "nbi_status", police: "police_status", tor: "tor_status", portfolio: "portfolio_status" };
      const certMatch = String(docKey).match(/^certificates\[(\d+)\]$/);

      if (singleStatusCols[docKey]) {
        const column = singleStatusCols[docKey];
        const payload = {}; payload[column] = toStatus; payload["updated_at"] = new Date().toISOString();
        const { error } = await sb.from("installer_documents").update(payload).eq("installer_id", installerId);
        if (error) throw error; return;
      }

      if (certMatch) {
        const idx = Number(certMatch[1]);
        const { data, error } = await sb.from("installer_documents").select("certificates_status").eq("installer_id", installerId).maybeSingle();
        if (error) throw error;
        const current = Array.isArray(data?.certificates_status) ? data.certificates_status.slice() : [];
        while (current.length <= idx) current.push("pending");
        current[idx] = toStatus;
        const { error: upErr } = await sb.from("installer_documents").update({ certificates_status: current, updated_at: new Date().toISOString() }).eq("installer_id", installerId);
        if (upErr) throw upErr; return;
      }
    }

    async function setOverallStatus(installerId, toStatus) {
      try {
        const { data: row, error: fetchErr } = await sb.from("installer_documents").select(`
            nbi, nbi_status, police, police_status, resume, resume_status,
            portfolio, portfolio_status, certificates, certificates_status, tor, tor_status
          `).eq("installer_id", installerId).maybeSingle();
        if (fetchErr) throw fetchErr;

        const updatePayload = { status: toStatus, updated_at: new Date().toISOString() };
        if (toStatus === "rejected" || toStatus === "pending") {
          const map = [["resume", "resume_status"], ["nbi", "nbi_status"], ["police", "police_status"], ["tor", "tor_status"], ["portfolio", "portfolio_status"]];
          for (const [fileCol, statusCol] of map) { if (row && row[fileCol]) updatePayload[statusCol] = toStatus; }
          if (row && Array.isArray(row.certificates) && row.certificates.length) { updatePayload["certificates_status"] = row.certificates.map(() => toStatus); }
        }

        const { error: upErr } = await sb.from("installer_documents").update(updatePayload).eq("installer_id", installerId);
        if (upErr) throw upErr;

        const { data: fresh, error: refetchErr } = await sb.from("installer_documents").select(`
            installer_id, nbi, nbi_status, police, police_status, resume, resume_status,
            portfolio, portfolio_status, certificates, certificates_status, tor, tor_status,
            status, uploaded_at, updated_at
          `).eq("installer_id", installerId).maybeSingle();
        if (refetchErr) throw refetchErr;

        const w = WORKERS.find(x => x.id === installerId);
        if (w && fresh) {
          w.profileStatus = String(fresh.status || "pending").toLowerCase();
          w._rawDocs = fresh;
          DOC_REVIEW.set(installerId, buildDocRows(fresh));
          await signAllDocsForInstaller(installerId);
          renderWorkerList(searchInput.value);
          renderDetails(w);
        } else {
          await fetchWorkers();
        }

        alert(`Installer marked as ${cap(toStatus)}.`);
      } catch (err) {
        alert(`Failed to set status: ${err.message || err}`);
      }
    }

    function openDoc(title, url) {
      if (!url) { alert("Preview unavailable."); return; }
      docTitle.textContent = title || "Document";
      docBody.innerHTML = "";
      const isImage = /\.(png|jpe?g|gif|webp|bmp|svg)($|\?)/i.test(url);
      if (isImage) { const img = document.createElement("img"); img.src = url; img.alt = title; docBody.appendChild(img); }
      else { const frame = document.createElement("iframe"); frame.src = url; docBody.appendChild(frame); }
      docModal.classList.add("open");
    }
    function closeDoc() { docModal.classList.remove("open"); docBody.innerHTML = ""; }
    document.getElementById("closeModal").addEventListener("click", closeDoc);
    document.getElementById("docModal").addEventListener("click", (e) => { if (e.target.id === "docModal") closeDoc(); });

    function openMobileDetails() { detailsPane.classList.add("as-modal"); mobileBackdrop.classList.add("show"); document.documentElement.style.overflow = "hidden"; document.body.style.overflow = "hidden"; }
    function closeMobileDetails() { detailsPane.classList.remove("as-modal"); mobileBackdrop.classList.remove("show"); document.documentElement.style.overflow = ""; document.body.style.overflow = ""; }
    mobileBackdrop.addEventListener("click", closeMobileDetails);
    window.addEventListener("resize", () => { if (!window.matchMedia("(max-width: 980px)").matches) { closeMobileDetails(); } });

    document.addEventListener("DOMContentLoaded", () => { startLoading(); fetchWorkers(); });
  </script>
</body>

</html>