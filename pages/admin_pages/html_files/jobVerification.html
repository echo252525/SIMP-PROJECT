<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
    <title>Jobs Verification</title>

    <style>
      :root {
        --ink: #1c2430;
        --muted: #6c7a8a;
        --line: #e7edf3;
        --brand: #20a44c;
        --warn: #f59e0b;
        --danger: #e53935;
        --bg: #f8fbfd;
        --card: #ffffff;
        --pill: #eef6ff;
        --radius: 14px;
      }

      main { margin-top: 1.4rem; }

      .two-col-wrap {
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 1rem;
      }
      @media (max-width: 980px) {
        .two-col-wrap { grid-template-columns: 1fr; }
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 12px;
      }
      .panel h3 { margin: 0 0 0.5rem 0; font-size: 1rem; }

      .search { position: relative; margin-bottom: 0.6rem; }
      .search input {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px 10px 36px;
        outline: none;
        background: #fcfeff;
      }
      .search .material-icons-sharp {
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        font-size: 20px; color: var(--muted);
      }

      .list {
        display: flex; flex-direction: column; gap: 8px;
        max-height: 70vh; overflow: auto;
      }

      .item {
        display: grid;
        grid-template-columns: 48px 1fr auto;
        align-items: center; gap: 10px; padding: 10px;
        border: 1px solid var(--line); border-radius: 12px;
        cursor: pointer; transition: background .15s ease; background: #fff;
      }
      .item:hover { background: #f6fafc; }
      .item.active { outline: 2px solid var(--brand); }
      .item.read { background: #fff !important; }
      .item.pending { background: #f0f4f9 !important; }

      .thumb {
        width: 48px; height: 48px; border-radius: 8px; object-fit: cover;
        border: 1px solid var(--line);
      }

      .pill {
        font-size: 0.75rem; background: var(--pill); padding: 4px 8px;
        border-radius: 999px; color: #2463a6; border: 1px solid #d6e9ff; white-space: nowrap;
      }

      .details {
        background: var(--card); border: 1px solid var(--line);
        border-radius: var(--radius); overflow: clip;
      }
      .details .head {
        display: flex; gap: 16px; padding: 16px; border-bottom: 1px solid var(--line);
        align-items: center; background: linear-gradient(180deg, #f9fbff, #ffffff);
      }
      .details .head img {
        width: 20%; height: auto; border-radius: 12px; object-fit: cover;
        border: 1px solid var(--line); background: #fff;
      }
      .details .head .name { font-size: 1.1rem; font-weight: 700; margin: 0 0 2px; }

      .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
      .meta .kv { font-size: 0.85rem; color: var(--muted); }

      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; }
      @media (max-width: 980px) { .grid-2 { grid-template-columns: 1fr; } }

      .card { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: #fff; }
      .card h4 { margin: 0 0 0.6rem 0; font-size: 0.95rem; }

      .info-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; font-size: 0.95rem; }
      @media (max-width: 640px) { .info-list { grid-template-columns: 1fr; } }
      .info-list .label { color: var(--muted); font-size: 0.85rem; display: block; }

      .actions-row {
        display: flex; gap: 10px; padding: 12px 16px 16px;
        border-top: 1px solid var(--line); justify-content: flex-end; background: #fff;
      }
      .btn {
        appearance: none; border: 1px solid var(--line); background: #fff;
        border-radius: 10px; padding: 9px 12px; cursor: pointer;
        display: inline-flex; align-items: center; gap: 0.5rem; font-weight: 600;
      }
      .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
      .btn.reject { background: #fff5f5; color: #e53935; border-color: #ffd7d7; }
      .btn.warn { background: #fff8e1; color: #8a6d0a; border-color: #fde68a; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }

      .empty-state {
        padding: 24px; border: 1px dashed var(--line); border-radius: 12px; background: #fbfeff;
        text-align: center; color: var(--muted);
      }

      .toast {
        position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%);
        background: #111827; color: #fff; padding: 10px 14px; border-radius: 10px;
        font-size: 0.9rem; display: none; z-index: 1000;
      }
      .toast.show { display: block; }
    </style>
  </head>

  <body>
    <div class="container">
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="../img/simpLogo.png" alt="logo" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>

        <div class="sidebar">
          <a href="dashboard.html"><span class="material-icons-sharp">dashboard</span><h3>Dashboard</h3></a>
          <a href="workerVerification.html"><span class="material-icons-sharp">engineering</span><h3>Workers<br />Verification</h3></a>
          <a href="jobVerification.html" class="active"><span class="material-icons-sharp">work</span><h3>Jobs<br />Verification</h3></a>
          <a href="jobApplicationVerification.html"><span class="material-icons-sharp">approval</span><h3>Application<br />Verification</h3></a>
          <a href="adminVerification.html"><span class="material-icons-sharp">shield</span><h3>Admin<br />Verification</h3></a>
          <a href="manageShop.html"><span class="material-icons-sharp">shop</span><h3>Manage<br />Shop</h3></a>
          <a href="paymentsRequest.html"><span class="material-icons-sharp">payments</span><h3>Payments<br />Request</h3></a>
          <a href="courses.html"><span class="material-icons-sharp">school</span><h3>Course<br />Publisher</h3></a>
          <a href="settings.html"><span class="material-icons-sharp">settings</span><h3>Settings</h3></a>
          <a href="#" id="logout-btn"><span class="material-icons-sharp">logout</span><h3>Logout</h3></a>
        </div>
      </aside>

      <main>
        <section id="tab-jobs">
          <div class="two-col-wrap">
            <div class="panel">
              <h3>Jobs for Verification</h3>
              <div class="search">
                <span class="material-icons-sharp">search</span>
                <input id="jobSearchInput" type="text" placeholder="Search title, category, locationâ€¦" />
              </div>
              <div style="margin-bottom: 0.6rem">
                <select
                  id="jobStatusFilter"
                  style="width: 100%; border: 1px solid var(--line); border-radius: 10px; padding: 10px 12px; background: #fcfeff; outline: none;"
                >
                  <option value="">All statuses</option>
                  <option value="pending">Pending</option>
                  <option value="viewed">Viewed</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                  <option value="done">Done</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>
              <div id="jobList" class="list"></div>
              <div id="emptyJobs" class="empty-state" style="display: none">No jobs pending review.</div>
            </div>

            <div class="details" id="jobDetailsPane">
              <div class="empty-state">Select a job on the left to review its details.</div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="toast" class="toast"></div>

    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script type="module">
      // ========= CONFIG =========
      var DEFAULT_JOB_PICS_BUCKET = 'jobs';

      // ========= Supabase client =========
      var createClient = supabase.createClient;
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
      var sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ========= DOM refs =========
      var jobSearchInput = document.getElementById("jobSearchInput");
      var jobStatusFilter = document.getElementById("jobStatusFilter");
      var jobList = document.getElementById("jobList");
      var emptyJobs = document.getElementById("emptyJobs");
      var jobDetailsPane = document.getElementById("jobDetailsPane");
      var toastEl = document.getElementById("toast");

      // ========= State =========
      var ALL_JOBS = [];
      var activeJobId = null;

      // ========= Utils =========
      function showToast(msg, ms) {
        if (typeof ms !== "number") ms = 2400;
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(function () { toastEl.classList.remove("show"); }, ms);
      }

      function esc(s) {
        var str = (s === undefined || s === null) ? "" : String(s);
        return str.replace(/[&<>"']/g, function (c) {
          var map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
          return map[c];
        });
      }

      function peso(n) {
        var v = typeof n === "string" ? parseFloat(n) : n;
        if (isNaN(v)) return "0.00";
        return v.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function fmtDate(d) {
        if (!d) return "";
        return new Date(d + "T00:00:00").toLocaleDateString();
      }

      function fmtTime(t) { return t ? String(t).slice(0, 5) : ""; }

      function nice(status) {
        var s = (status || "").toLowerCase();
        if (!s) return "Pending";
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      // ========= Signed URL helpers =========
      function parsePublicBucketAndPath(publicUrl){
        try{
          var marker = '/storage/v1/object/public/';
          var i = publicUrl.indexOf(marker);
          if (i === -1) return null;
          var rest = publicUrl.substring(i + marker.length);
          var slash = rest.indexOf('/');
          if (slash === -1) return null;
          var bucket = rest.substring(0, slash);
          var path = rest.substring(slash + 1);
          try { path = decodeURIComponent(path); } catch(e){}
          path = path.replace(/^\/+/, '');
          return { bucket: bucket, path: path };
        }catch(e){ return null; }
      }

      function parseStorageRef(ref){
        if (!ref) return null;
        var s = String(ref).trim();
        if (/^https?:\/\//i.test(s)){
          var parsed = parsePublicBucketAndPath(s);
          return parsed || null;
        }
        var bi = s.indexOf('::');
        if (bi > 0){
          var p1 = s.slice(bi + 2);
          try { p1 = decodeURIComponent(p1); } catch(e){}
          p1 = p1.replace(/^\/+/, '');
          return { bucket: s.slice(0, bi), path: p1 };
        }
        var p2 = s;
        try { p2 = decodeURIComponent(p2); } catch(e){}
        p2 = p2.replace(/^\/+/, '');
        return { bucket: DEFAULT_JOB_PICS_BUCKET, path: p2 };
      }

      async function createSignedUrl(bucket, path, expires){
        if (typeof expires !== "number") expires = 3600;
        var out = await sb.storage.from(bucket).createSignedUrl(path, expires);
        if (out.error) throw out.error;
        return out.data.signedUrl;
      }

      async function resolveJobPictureSignedUrl(job_picture_url){
        if (!job_picture_url) return null;
        if (/^https?:\/\//i.test(job_picture_url) && job_picture_url.indexOf('/storage/v1/object/') === -1){
          return job_picture_url;
        }
        var ref = parseStorageRef(job_picture_url);
        if (!ref) return null;
        try {
          return await createSignedUrl(ref.bucket, ref.path, 3600);
        } catch (e){
          if (/^https?:\/\//i.test(job_picture_url)) return job_picture_url;
          return null;
        }
      }

      // ========= Status updates =========
      async function updateJobStatus(jobId, desiredStatus) {
        var payload = desiredStatus
          ? { job_status: desiredStatus, updated_at: new Date().toISOString() }
          : { job_status: null, updated_at: new Date().toISOString() };

        var r1 = await sb.schema("jobs").from("job").update(payload).eq("job_id", jobId);
        if (!r1.error) return { ok: true, stored: desiredStatus || null };

        var enumErr = /enum|invalid input value/i.test(r1.error.message || "");
        var wantsFallback = desiredStatus && (desiredStatus === "viewed" || desiredStatus === "pending");
        if (enumErr && wantsFallback) {
          var r2 = await sb
            .schema("jobs")
            .from("job")
            .update({ job_status: null, updated_at: new Date().toISOString() })
            .eq("job_id", jobId);
          if (!r2.error) return { ok: true, stored: null, note: "fallback-null" };
          return { ok: false, error: r2.error };
        }

        return { ok: false, error: r1.error };
      }

      // ========= Load + Render =========
      async function loadJobs() {
        jobList.innerHTML = "";
        emptyJobs.style.display = "none";
        jobDetailsPane.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';

        var res = await sb
          .schema("jobs")
          .from("job")
          .select("job_id, posted_by, job_title, job_description, job_difficulty, job_category, job_location, job_date, job_time, job_pay, job_picture_url, job_status, created_at")
          .order("created_at", { ascending: false });

        if (res.error) {
          jobDetailsPane.innerHTML = '<div class="empty-state">Failed to load jobs.</div>';
          emptyJobs.style.display = "block";
          showToast(res.error.message || "Load error");
          return;
        }

        var jobs = res.data || [];
        var signedUrls = await Promise.all(jobs.map(function (j) {
          return resolveJobPictureSignedUrl(j.job_picture_url);
        }));

        ALL_JOBS = jobs.map(function (j, idx) {
          return {
            id: j.job_id,
            photo: signedUrls[idx] || "../images/profile-4.jpg",
            title: j.job_title,
            category: j.job_category,
            difficulty: j.job_difficulty,
            pay: j.job_pay,
            datetime: fmtDate(j.job_date) + " " + fmtTime(j.job_time),
            location: j.job_location,
            status: j.job_status || "",
            createdAt: j.created_at
          };
        });

        renderJobList("");

        if (ALL_JOBS.length) {
          var first = ALL_JOBS[0];
          activeJobId = first.id;
          await ensureViewed(first);
          renderJobDetails(first);
          setTimeout(function () {
            var el = document.querySelector('#jobList .item[data-id="' + first.id + '"]');
            if (el) el.classList.add("active", "read");
          }, 0);
        } else {
          jobDetailsPane.innerHTML = '<div class="empty-state">No jobs found.</div>';
        }
      }

      function renderJobList(filter) {
        if (typeof filter !== "string") filter = "";
        jobList.innerHTML = "";
        var q = filter.trim().toLowerCase();
        var selectedStatus = (jobStatusFilter && jobStatusFilter.value ? jobStatusFilter.value : "").toLowerCase();

        var filtered = (ALL_JOBS || []).filter(function (j) {
          var hay = ((j.title || "") + "|" + (j.category || "") + "|" + (j.location || "")).toLowerCase();
          var hit = !q || hay.indexOf(q) !== -1;
          var statusForFilter = (j.status || "pending").toLowerCase();
          var statusOk = !selectedStatus || statusForFilter === selectedStatus;
          return hit && statusOk;
        });

        emptyJobs.style.display = filtered.length ? "none" : "block";

        filtered.forEach(function (j) {
          var item = document.createElement("div");
          item.className = "item";
          item.setAttribute("data-id", j.id);
          if (j.id === activeJobId) item.classList.add("active");

          var s = (j.status || "").toLowerCase();
          if (s === "viewed") item.classList.add("read");
          else if (!s || s === "pending") item.classList.add("pending");

          item.innerHTML =
            '<img class="thumb" src="' + j.photo + '" alt="' + esc(j.title) + '" onerror="this.onerror=null;this.src=\'../images/profile-4.jpg\';">' +
            '<div>' +
              '<div style="font-weight:700">' + esc(j.title) + '</div>' +
              '<div style="font-size:.85rem;color:var(--muted)">' + esc(j.category || "Uncategorized") + ' Â· ' + esc(j.location || "â€”") + '</div>' +
            '</div>' +
            '<span class="pill">' + esc(nice(j.status || "pending")) + '</span>';

          item.addEventListener("click", function () {
            activeJobId = j.id;
            var rows = document.querySelectorAll("#jobList .item");
            for (var i = 0; i < rows.length; i++) rows[i].classList.remove("active");
            item.classList.add("active");

            ensureViewed(j).then(function () {
              item.classList.remove("pending");
              item.classList.add("read");
              var pill = item.querySelector(".pill");
              if (pill) pill.textContent = nice(j.status || "pending");
              renderJobDetails(j);
            });
          });

          jobList.appendChild(item);
        });

        if (!filtered.length) {
          jobDetailsPane.innerHTML = '<div class="empty-state">Nothing matches your filters.</div>';
        }
      }

      function renderJobDetails(job) {
        jobDetailsPane.innerHTML =
          '<div class="head" style="display:block; padding:0;">' +
            '<img src="' + job.photo + '" alt="' + esc(job.title) + '" ' +
                 'style="width:100%; height:240px; object-fit:cover; border-radius:12px 12px 0 0; margin-bottom:12px;" ' +
                 'onerror="this.onerror=null;this.src=\'../images/profile-4.jpg\';">' +
            '<div style="padding:0 16px 12px;">' +
              '<div class="name">' + esc(job.title) + '</div>' +
              '<div class="meta">' +
                '<span class="kv"><strong>Category:</strong> ' + esc(job.category || "Uncategorized") + '</span>' +
                '<span class="kv"><strong>Difficulty:</strong> ' + esc(job.difficulty != null ? job.difficulty : "â€”") + '</span>' +
                '<span class="kv"><strong>Pay:</strong> â‚±' + peso(job.pay) + '</span>' +
              '</div>' +
            '</div>' +
          '</div>' +

          '<div class="grid-2">' +
            '<div class="card">' +
              '<h4>Schedule</h4>' +
              '<div class="info-list">' +
                '<div><span class="label">Date / Time</span>' + esc(job.datetime || "â€”") + '</div>' +
                '<div><span class="label">Status</span><span class="pill" id="jobStatusPill">' + esc(nice(job.status || "pending")) + '</span></div>' +
              '</div>' +
            '</div>' +

            '<div class="card">' +
              '<h4>Location</h4>' +
              '<div class="info-list">' +
                '<div style="grid-column: 1 / -1;"><span class="label">Address</span>' + esc(job.location || "Not specified") + '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +

          '<div class="actions-row" id="actionsRow"></div>';

        var actionsRow = document.getElementById("actionsRow");
        actionsRow.innerHTML = "";

        var s = (job.status || "pending").toLowerCase();

        // If already done or overdue, do not show any action buttons
        if (s === "done" || s === "overdue") {
          return;
        }

        if (s !== "approved") {
          var approveBtn = document.createElement("button");
          approveBtn.className = "btn primary";
          approveBtn.textContent = "Approve";
          approveBtn.addEventListener("click", function () { changeStatus(job, "approved"); });
          actionsRow.appendChild(approveBtn);
        }

        if (s !== "rejected") {
          var rejectBtn = document.createElement("button");
          rejectBtn.className = "btn reject";
          rejectBtn.textContent = "Reject";
          rejectBtn.addEventListener("click", function () { changeStatus(job, "rejected"); });
          actionsRow.appendChild(rejectBtn);
        }

        if (s === "rejected") {
          var revertBtn = document.createElement("button");
          revertBtn.className = "btn warn";
          revertBtn.textContent = "Revert to Viewed";
          revertBtn.addEventListener("click", function () { changeStatus(job, "viewed"); });
          actionsRow.appendChild(revertBtn);
        }
      }

      async function changeStatus(job, target) {
        var prev = job.status;
        job.status = target; // optimistic
        updateActiveRowBadge(job);
        renderJobDetails(job);

        var res = await updateJobStatus(job.id, target);
        if (!res.ok) {
          job.status = prev; // rollback
          updateActiveRowBadge(job);
          renderJobDetails(job);
          var msg = (res.error && res.error.message) ? res.error.message : "Update failed (check RLS/enum)";
          showToast(msg);
          return;
        }

        if (target === "viewed" && res.stored === null) {
          job.status = "viewed";
        }

        renderJobList(jobSearchInput ? jobSearchInput.value : "");
        showToast("Status updated to " + nice(job.status));
      }

      function updateActiveRowBadge(job) {
        var row = document.querySelector('#jobList .item[data-id="' + job.id + '"]');
        if (row) {
          var pill = row.querySelector(".pill");
          if (pill) pill.textContent = nice(job.status || "pending");
          row.classList.remove("pending");
          row.classList.remove("read");
          var s = (job.status || "").toLowerCase();
          if (s === "viewed") row.classList.add("read");
          else if (!s || s === "pending") row.classList.add("pending");
        }
        var pill2 = document.getElementById("jobStatusPill");
        if (pill2) pill2.textContent = nice(job.status || "pending");
      }

      async function ensureViewed(job) {
        var s = (job.status || "").toLowerCase();
        if (!s || s === "pending") {
          var prev = job.status || "";
          job.status = "viewed";
          updateActiveRowBadge(job);
          var res = await updateJobStatus(job.id, "viewed");
          if (!res.ok) {
            job.status = prev;
            updateActiveRowBadge(job);
          }
        }
      }

      // ========= Events =========
      if (jobSearchInput) {
        jobSearchInput.addEventListener("input", function (e) { renderJobList(e.target.value); });
      }
      if (jobStatusFilter) {
        jobStatusFilter.addEventListener("change", function () {
          renderJobList(jobSearchInput ? jobSearchInput.value : "");
        });
      }

      document.addEventListener("DOMContentLoaded", function () { loadJobs(); });
    </script>
  </body>
</html>
