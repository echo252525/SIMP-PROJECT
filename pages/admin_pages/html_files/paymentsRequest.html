<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <title>PaymentsRequest</title>
    <style>
      main {
        margin-top: 1.4rem;
      }

      /* Header */
      main .payments-header h1 {
        margin: 0;
        color: #1c2430;
        font-weight: 700;
      }
      main .payments-header p {
        margin: 0.2rem 0 1rem;
        color: #6c7a8a;
      }
      main .search-filter input {
        width: 40%;
      }

      /* Search & Filter */
      main .search-filter {
        display: flex;
        gap: 0.8rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }
      main .search-filter input,
      main .search-filter select,
      main .search-filter button {
        padding: 0.6rem 0.75rem;
        border: 1px solid #e7edf3;
        border-radius: 8px;
        font-size: 0.9rem;
      }
      main .search-filter button {
        background: #20a44c;
        color: #fff;
        cursor: pointer;
        border: none;
      }
      main .search-filter button:hover {
        background: #188a3e;
      }
      main .search-filter .clear {
        background: #e7edf3;
        color: #1c2430;
      }
      main .search-filter .clear:hover {
        background: #d7e6ee;
      }

      /* Summary Cards */
      main .summary-cards {
        display: grid;
        grid-template-columns: repeat(3, minmax(180px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      main .summary-cards .card {
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      main .summary-cards .card h3 {
        margin: 0;
        font-size: 0.9rem;
        color: #6c7a8a;
        font-weight: 600;
      }
      main .summary-cards .card p {
        margin: 0.4rem 0 1rem 0;
        font-size: 1.25rem;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      main .summary-cards .paid p {
        color: #20a44c;
      }
      main .summary-cards .unpaid p {
        color: #e53935;
      }

      /* Tabs */
      .payout-tabs {
        display: flex;
        gap: 0.4rem;
        margin: 0.6rem 0 0.6rem;
        border-bottom: 1px solid #e7edf3;
        flex-wrap: wrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      .payout-tabs button {
        appearance: none;
        background: transparent;
        border: none;
        padding: 0.65rem 1rem;
        font-weight: 700;
        color: #6c7a8a;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
      }
      .payout-tabs button.active {
        color: #1c2430;
        border-color: #20a44c;
      }
      /* icon & label for tabs */
      .payout-tabs .tab-icon {
        font-size: 1.15rem;
        display: inline-flex;
      }
      .payout-tabs .tab-label {
        display: inline;
      }

      /* NEW: tiny notification badge */
      .badge {
        display: inline-grid;
        place-items: center;
        min-width: 22px;
        height: 20px;
        padding: 0 0.4rem;
        border-radius: 999px;
        background: #e91e63;
        color: #fff;
        font-size: 0.72rem;
        font-weight: 800;
        line-height: 1;
        box-shadow: 0 2px 6px rgba(233, 30, 99, 0.25);
      }
      .badge[hidden] {
        display: none !important;
      }

      /* Table */
      main .payments-table table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      main .payments-table th,
      main .payments-table td {
        padding: 0.9rem;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
      }
      main .payments-table th {
        background: #f8fbfd;
        color: #1c2430;
        font-weight: 700;
      }
      main .payments-table .col-select {
        width: 40px;
        text-align: center;
      }
      main .payments-table .col-select input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      main .status {
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 700;
      }
      main .status.paid {
        background: #e6f6ec;
        color: #1d8e45;
      }
      main .status.not-paid {
        background: #fdecea;
        color: #c62828;
      }
      main .status.pending {
        background: #fff7ed;
        color: #b45309;
      }

      main .mark-paid,
      .do-payout,
      .do-payout-group,
      .do-payout-batch {
        background: #20a44c;
        color: #fff;
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      main .mark-paid:hover,
      .do-payout:hover,
      .do-payout-group:hover,
      .do-payout-batch:hover {
        background: #188a3e;
      }
      main button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Batch / Bulk bar */
      main .batch-bar {
        position: sticky;
        top: 0;
        z-index: 5;
        display: flex;
        gap: 0.6rem;
        align-items: center;
        margin: 0.8rem 0;
        background: #ffffff;
        border: 1px solid #e7edf3;
        border-radius: 10px;
        padding: 0.7rem 0.9rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
      }
      main .batch-bar .pill {
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        background: #f8fbfd;
        border: 1px solid #e7edf3;
        font-weight: 700;
        color: #1c2430;
      }
      main .batch-bar .create {
        background: #1e7bcb;
        border: none;
        color: #fff;
        padding: 0.55rem 0.85rem;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      main .batch-bar .create:hover {
        background: #1868a9;
      }
      main .batch-bar .select-all-wrap {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        margin-right: 0.4rem;
      }

      /* Keep old button hidden (per your note) */
      #createPayoutBtn {
        display: none !important;
      }

      /* Bulk mark-as-paid button */
      #bulkMarkPaidBtn {
        background: #20a44c;
        border: none;
        color: #fff;
        padding: 0.55rem 0.85rem;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      #bulkMarkPaidBtn:hover {
        background: #188a3e;
      }

      /* Requests table */
      .requests-table {
        display: none;
        margin-top: 0.6rem;
      }
      .requests-table table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .requests-table th,
      .requests-table td {
        padding: 0.9rem;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
      }
      .requests-table th {
        background: #f8fbfd;
        color: #1c2430;
        font-weight: 700;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }
      .sub {
        color: #6c7a8a;
      }

      /* ====== Bank Confirmation Modal (UPDATED) ====== */
      .bank-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(17, 24, 39, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10050;
        padding: 12px;
      }
      .bank-modal-overlay.show {
        display: flex;
      }
      .bank-modal {
        width: min(720px, 96vw);
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 24px 64px rgba(0, 0, 0, 0.35);
        overflow: hidden;
      }
      .bank-modal .bm-header {
        padding: 12px 14px;
        background: linear-gradient(180deg, #f8fbfd, #eef4f9);
        border-bottom: 1px solid #e7edf3;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .bank-modal .bm-header h3 {
        margin: 0;
        font-size: 1.05rem;
        color: #1c2430;
      }
      .bank-modal .bm-body {
        padding: 12px 14px;
        max-height: 64vh;
        overflow: auto;
      }
      .bank-modal .bm-body table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0.6rem;
      }
      .bank-modal .bm-body th,
      .bank-modal .bm-body td {
        padding: 0.65rem 0.6rem;
        border-bottom: 1px solid #eef2f7;
        text-align: left;
      }
      .bank-modal .bm-body th {
        background: #f8fbfd;
        color: #1c2430;
        font-weight: 800;
        position: sticky;
        top: 0;
      }
      .bank-modal .bm-ref {
        display: grid;
        gap: 0.4rem;
        padding: 0.2rem 0 0.4rem;
      }
      .bank-modal .bm-ref label {
        font-weight: 800;
        color: #1c2430;
      }
      .bank-modal .bm-ref input {
        border: 1px solid #e7edf3;
        border-radius: 10px;
        padding: 0.6rem 0.7rem;
        font: inherit;
      }
      .bank-modal .bm-ref small {
        color: #6c7a8a;
      }

      .bank-modal .bm-footer {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        flex-wrap: wrap;
        padding: 12px 14px;
        border-top: 1px solid #e7edf3;
        background: #fff;
      }
      .bm-btn {
        border: none;
        border-radius: 10px;
        padding: 0.6rem 0.85rem;
        font-weight: 800;
        cursor: pointer;
      }
      .bm-cancel {
        background: #e7edf3;
        color: #1c2430;
      }
      .bm-confirm {
        background: #20a44c;
        color: #fff;
      }
      .bm-cancel:hover {
        background: #dbe7ef;
      }
      .bm-confirm:hover {
        background: #188a3e;
      }
      .bm-error {
        color: #c62828;
        font-size: 0.85rem;
      }

      /* =========================
         RESPONSIVE ENHANCEMENTS
         ========================= */
      @media (max-width: 980px) {
        /* Search/filter stacks */
        main .search-filter {
          gap: 0.6rem;
        }
        main .search-filter input {
          width: 100%;
          min-width: 220px;
          flex: 1 1 100%;
        }
        main .search-filter select,
        main .search-filter button {
          flex: 1 1 calc(50% - 0.6rem);
        }

        /* Summary cards 2 columns */
        main .summary-cards {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 0.8rem;
        }

        /* Batch bar wraps neatly */
        main .batch-bar {
          flex-wrap: wrap;
          gap: 0.5rem 0.6rem;
        }
        main .batch-bar .pill {
          font-size: 0.85rem;
        }

        /* Tabs: shrink padding, allow scroll, show icons+labels (labels will hide below 680px) */
        .payout-tabs button {
          padding: 0.55rem 0.75rem;
        }

        /* Make tables horizontally scrollable fallback (kept) */
        main .payments-table table {
          display: block;
          overflow-x: auto;
        }
      }

      @media (max-width: 720px) {
        /* Tabs: icons only — hide labels, keep badges */
        .payout-tabs .tab-label {
          display: none;
        }
        .payout-tabs .tab-icon {
          display: inline-flex;
        }

        /* Summary cards single column */
        main .summary-cards {
          grid-template-columns: 1fr;
        }

        /* Action buttons full width inside rows/cards */
        main .mark-paid,
        .do-payout,
        .do-payout-group,
        .do-payout-batch {
          width: 100%;
        }

        /* Turn main payments table into cards */
        .payments-table thead {
          display: none;
        }
        .payments-table tbody tr {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 6px 12px;
          padding: 10px 12px;
          border-bottom: 1px solid #eef2f7;
        }
        .payments-table tbody tr td {
          white-space: normal;
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          padding: 6px 0;
          border-bottom: none;
        }
        .payments-table tbody tr td::before {
          content: attr(data-col);
          font-weight: 700;
          color: #6c7a8a;
          flex: 0 0 auto;
        }
        /* Make some cells span full row for clarity */
        .payments-table tbody tr td[data-col="Job Title"],
        .payments-table tbody tr td[data-col="Status"],
        .payments-table tbody tr td[data-col="Action"] {
          grid-column: 1 / -1;
        }
        /* Select column small */
        .payments-table tbody tr td[data-col="Select"]::before {
          content: "Select";
        }
        .payments-table tbody tr td[data-col="Select"] {
          justify-content: flex-start;
          gap: 10px;
        }

        /* Requests table -> cards */
        .requests-table thead {
          display: none;
        }
        .requests-table tbody tr {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 6px 12px;
          padding: 10px 12px;
          border-bottom: 1px solid #eef2f7;
        }
        .requests-table tbody tr td {
          white-space: normal;
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          padding: 6px 0;
          border-bottom: none;
        }
        .requests-table tbody tr td::before {
          content: attr(data-col);
          font-weight: 700;
          color: #6c7a8a;
          flex: 0 0 auto;
        }
        .requests-table tbody tr td[data-col="Jobs"],
        .requests-table tbody tr td[data-col="Action"] {
          grid-column: 1 / -1;
        }

        /* Modal: taller on mobile */
        .bank-modal .bm-body {
          max-height: 70vh;
        }
      }

      @media (max-width: 480px) {
        /* Slightly smaller paddings/fonts for compactness */
        main .payments-header h1 {
          font-size: 1.25rem;
        }
        .payout-tabs button {
          padding: 0.5rem 0.6rem;
        }
        .badge {
          min-width: 20px;
          height: 18px;
          font-size: 0.68rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="../../../img/simpLogo.png" alt="SIMP Logo" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>

        <div class="sidebar">
          <a href="dashboard.html"
            ><span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3></a
          >
          <a href="workerVerification.html"
            ><span class="material-icons-sharp">engineering</span>
            <h3>Workers<br />Verification</h3></a
          >
          <a href="jobVerification.html"
            ><span class="material-icons-sharp">work</span>
            <h3>Jobs<br />Verification</h3></a
          >
          <a href="jobApplicationVerification.html"
            ><span class="material-icons-sharp">approval</span>
            <h3>Application<br />Verification</h3></a
          >
          <a href="adminVerification.html"
            ><span class="material-icons-sharp">shield</span>
            <h3>Admin<br />Verification</h3></a
          >
          <a href="manageShop.html"
            ><span class="material-icons-sharp">shop</span>
            <h3>Manage<br />Shop</h3></a
          >
          <a href="paymentsRequest.html" class="active"
            ><span class="material-icons-sharp">payments</span>
            <h3>Payments<br />Request</h3></a
          >
          <a href="courses.html"
            ><span class="material-icons-sharp">school</span>
            <h3>Course<br />Publisher</h3></a
          >
          <a href="settings.html"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3></a
          >
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3></a
          >
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- Main Content -->
      <main>
        <div class="payments-header">
          <h1>Payments Request</h1>
          <p>
            Manage and verify all payment requests from workers after job
            completion.
          </p>
        </div>

        <!-- Search & Filter -->
        <div class="search-filter">
          <input
            id="searchInput"
            type="text"
            placeholder="Search by Job ID, Worker, or Job Title..."
          />
          <select id="statusFilter">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="not-paid">Not Paid</option>
          </select>
          <button id="searchBtn" type="button">Search</button>
          <button id="clearBtn" class="clear" type="button">Clear</button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
          <div class="card total">
            <h3>Total (visible)</h3>
            <p id="totalCount">0</p>
          </div>
          <div class="card paid">
            <h3>Paid (visible)</h3>
            <p id="paidCount">0</p>
          </div>
          <div class="card unpaid">
            <h3>Not Paid (visible)</h3>
            <p id="unpaidCount">0</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="payout-tabs">
          <button id="tabAll" class="active" data-mode="all" type="button" aria-label="All Payments">
            <span class="material-icons-sharp tab-icon" aria-hidden="true">list_alt</span>
            <span class="tab-label">All Payments</span>
            <span id="badgeAll" class="badge" hidden>0</span>
          </button>
          <button id="tabRequests" data-mode="requests" type="button" aria-label="Payout Requests">
            <span class="material-icons-sharp tab-icon" aria-hidden="true">request_quote</span>
            <span class="tab-label">Payout Requests</span>
            <span id="badgeRequests" class="badge" hidden>0</span>
          </button>
          <button id="tabUnpaid" data-mode="unpaid" type="button" aria-label="Unpaid">
            <span class="material-icons-sharp tab-icon" aria-hidden="true">hourglass_empty</span>
            <span class="tab-label">Unpaid</span>
            <span id="badgeUnpaid" class="badge" hidden>0</span>
          </button>
          <button id="tabPaid" data-mode="paid" type="button" aria-label="Paid">
            <span class="material-icons-sharp tab-icon" aria-hidden="true">check_circle</span>
            <span class="tab-label">Paid</span>
            <span id="badgePaid" class="badge" hidden>0</span>
          </button>
          <button id="tabDisbursed" data-mode="disbursed" type="button" aria-label="Disbursed">
            <span class="material-icons-sharp tab-icon" aria-hidden="true">paid</span>
            <span class="tab-label">Disbursed</span>
            <span id="badgeDisbursed" class="badge" hidden>0</span>
          </button>
        </div>

        <!-- Batch / Bulk Bar -->
        <div class="batch-bar" id="batchBar">
          <div class="select-all-wrap">
            <input type="checkbox" id="selectAllVisible" />
            <label
              for="selectAllVisible"
              style="user-select: none; cursor: pointer"
              >Select all (visible same status)</label
            >
          </div>
          <span class="pill" id="selCount">Selected: 0</span>
          <span class="pill" id="selTotal">Total: ₱0.00</span>
          <button
            id="createPayoutBtn"
            class="create disabled"
            type="button"
            disabled
          >
            Create Payout
          </button>
          <!-- Added bulk mark-paid -->
          <button
            id="bulkMarkPaidBtn"
            type="button"
            title="Mark all selected rows as Paid"
          >
            Mark Selected as Paid
          </button>
        </div>

        <!-- Payments Table -->
        <div class="payments-table" id="paymentsTableWrap">
          <table>
            <thead>
              <tr>
                <th class="col-select">
                  <span title="Select (same status)">Sel</span>
                </th>
                <th>Job ID</th>
                <th>Worker</th>
                <th>Job Title</th>
                <th>Amount</th>
                <th>Requested Date</th>
                <th>Status</th>
                <th style="width: 1%">Action</th>
              </tr>
            </thead>
            <tbody id="paymentsTbody"></tbody>
          </table>
        </div>

        <!-- Grouped Requests Table (Requests tab) -->
        <div class="requests-table" id="requestsTableWrap">
          <table>
            <thead>
              <tr>
                <th>Jobs</th>
                <th>Installer</th>
                <th># Payments</th>
                <th>Total Amount</th>
                <th>Requested Date</th>
                <th style="width: 1%">Action</th>
              </tr>
            </thead>
            <tbody id="requestsTbody"></tbody>
          </table>
        </div>

        <!-- Inline JS: filters, search, selection -->
        <script src="../../general_files/index.js"></script>
        <script type="module" src="../../general_files/session.js"></script>
        <script>
          (function () {
            const searchInput = document.getElementById("searchInput");
            const statusFilter = document.getElementById("statusFilter");
            const searchBtn = document.getElementById("searchBtn");
            const clearBtn = document.getElementById("clearBtn");
            const tbody = document.getElementById("paymentsTbody");

            const totalCount = document.getElementById("totalCount");
            const paidCount = document.getElementById("paidCount");
            const unpaidCount = document.getElementById("unpaidCount");

            const selCountEl = document.getElementById("selCount");
            const selTotalEl = document.getElementById("selTotal");
            const selectAllVisibleEl =
              document.getElementById("selectAllVisible");
            const createPayoutBtn = document.getElementById("createPayoutBtn");

            function rows() {
              return Array.from(tbody.querySelectorAll("tr"));
            }
            function normalize(s) {
              return (s || "").toString().trim().toLowerCase();
            }

            function rowMatchesSearch(row, q) {
              if (!q) return true;
              const job = row.querySelector(".col-jobid")?.textContent || "";
              const worker =
                row.querySelector(".col-worker")?.textContent || "";
              const title = row.querySelector(".col-title")?.textContent || "";
              const haystack = normalize(job + " " + worker + " " + title);
              return haystack.includes(normalize(q));
            }

            function rowMatchesStatus(row, status) {
              if (status === "all") return true;
              return row.dataset.status === status;
            }

            function updateSelectionSummary() {
              let count = 0;
              let total = 0;
              rows().forEach((r) => {
                if (r.style.display === "none") return;
                if (r.dataset.status !== "not-paid") return;
                const cb = r.querySelector(".row-select");
                if (cb && cb.checked) {
                  count++;
                  const amt = Number(r.dataset.amount || 0);
                  total += isNaN(amt) ? 0 : amt;
                }
              });
              const peso = (n) =>
                "₱" +
                (Number(n) || 0).toLocaleString("en-PH", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                });
              selCountEl.textContent = "Selected: " + count;
              selTotalEl.textContent = "Total: " + peso(total);

              if (count > 0) {
                createPayoutBtn.classList.remove("disabled");
                createPayoutBtn.disabled = false;
              } else {
                createPayoutBtn.classList.add("disabled");
                createPayoutBtn.disabled = true;
              }
            }

            function applyFilters() {
              const q = searchInput.value;
              const f = statusFilter.value;
              let visible = 0,
                visPaid = 0,
                visUnpaid = 0;

              rows().forEach((row) => {
                const show =
                  rowMatchesSearch(row, q) && rowMatchesStatus(row, f);
                row.style.display = show ? "" : "none";
                if (show) {
                  visible++;
                  if (row.dataset.status === "paid") visPaid++;
                  if (row.dataset.status === "not-paid") visUnpaid++;
                }
              });

              totalCount.textContent = String(visible);
              paidCount.textContent = String(visPaid);
              unpaidCount.textContent = String(visUnpaid);

              const mode = window.__tabMode || "all";
              rows().forEach((row) => {
                if (row.style.display === "none") return;
                if (mode === "all") return;
                if (
                  mode === "requests" &&
                  row.dataset.status !== "pending_payout"
                ) {
                  row.style.display = "none";
                  return;
                }
                if (mode === "unpaid" && row.dataset.status !== "not-paid") {
                  row.style.display = "none";
                  return;
                }
                if (mode === "paid" && row.dataset.status !== "paid") {
                  row.style.display = "none";
                  return;
                }
                if (
                  mode === "disbursed" &&
                  row.dataset.status !== "disbursed"
                ) {
                  row.style.display = "none";
                  return;
                }
              });

              updateSelectionSummary();
            }

            function onMarkPaidClick(e) {
              const btn = e.target.closest(".mark-paid");
              if (!btn) return;
              const row = btn.closest("tr");
              if (!row || row.dataset.status === "paid") return;

              row.dataset.status = "paid";
              const statusEl = row.querySelector(".status");
              if (statusEl) {
                statusEl.textContent = "Paid";
                statusEl.classList.remove("not-paid", "pending");
                statusEl.classList.add("paid");
              }
              btn.textContent = "Paid";
              btn.disabled = true;

              const cb = row.querySelector(".row-select");
              if (cb) cb.checked = false;

              applyFilters();
            }

            tbody.addEventListener("change", (e) => {
              const cb = e.target.closest(".row-select");
              if (!cb) return;
              const row = cb.closest("tr");
              if (row && row.dataset.status !== "not-paid") {
                cb.checked = false;
              }
              updateSelectionSummary();
            });

            selectAllVisibleEl.addEventListener("change", () => {
              const check = !!selectAllVisibleEl.checked;
              let targetStatus = null;
              const statusSel =
                document.getElementById("statusFilter")?.value || "all";
              if (statusSel !== "all") {
                targetStatus = statusSel;
              } else {
                const firstSelectable = rows().find(
                  (r) =>
                    r.style.display !== "none" &&
                    r.querySelector(".row-select") &&
                    !r.querySelector(".row-select").disabled
                );
                if (firstSelectable)
                  targetStatus = firstSelectable.dataset.status;
              }

              rows().forEach((r) => {
                if (r.style.display === "none") return;
                const cb = r.querySelector(".row-select");
                if (!cb || cb.disabled) return;
                if (!targetStatus || r.dataset.status !== targetStatus) return;
                cb.checked = check;
              });

              updateSelectionSummary();
            });

            tbody.addEventListener("click", onMarkPaidClick);
            searchInput.addEventListener("input", applyFilters);
            statusFilter.addEventListener("change", applyFilters);
            searchBtn.addEventListener("click", applyFilters);
            clearBtn.addEventListener("click", () => {
              searchInput.value = "";
              statusFilter.value = "all";
              applyFilters();
            });

            window.__tabMode = "all";
            applyFilters();

            const paymentsTableWrap =
              document.getElementById("paymentsTableWrap");
            const requestsTableWrap =
              document.getElementById("requestsTableWrap");
            const setActive = (id) => {
              document
                .querySelectorAll(".payout-tabs button")
                .forEach((b) => b.classList.remove("active"));
              document.getElementById(id).classList.add("active");
            };
            const showRequests = (on) => {
              requestsTableWrap.style.display = on ? "" : "none";
              paymentsTableWrap.style.display = on ? "none" : "";
              if (on && window.__buildRequests) window.__buildRequests();
            };

            document.getElementById("tabAll").addEventListener("click", () => {
              window.__tabMode = "all";
              setActive("tabAll");
              applyFilters();
              showRequests(false);
            });
            document
              .getElementById("tabRequests")
              .addEventListener("click", () => {
                window.__tabMode = "requests";
                setActive("tabRequests");
                applyFilters();
                showRequests(true);
              });
            document
              .getElementById("tabUnpaid")
              .addEventListener("click", () => {
                window.__tabMode = "unpaid";
                setActive("tabUnpaid");
                applyFilters();
                showRequests(false);
              });
            document.getElementById("tabPaid").addEventListener("click", () => {
              window.__tabMode = "paid";
              setActive("tabPaid");
              applyFilters();
              showRequests(false);
            });
            document
              .getElementById("tabDisbursed")
              .addEventListener("click", () => {
                window.__tabMode = "disbursed";
                setActive("tabDisbursed");
                applyFilters();
                showRequests(false);
              });

            window.__paymentsUI = {
              updateSelectionSummary,
              applyFilters,
            };
          })();
        </script>

        <!-- Supabase client -->
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

        <!-- Data loader -->
        <script type="module">
          import {
            SUPABASE_URL,
            SUPABASE_ANON_KEY,
          } from "../../../supabase.js";
          const sbClient = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );
          window.__sb = sbClient;

          const tbodyPayments = document.getElementById("paymentsTbody");
          const searchBtnEl = document.getElementById("searchBtn");

          const peso = (n) =>
            "₱" +
            (Number(n) || 0).toLocaleString("en-PH", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          const fmtDate = (iso) => {
            try {
              return new Date(iso).toISOString().slice(0, 10);
            } catch {
              return "";
            }
          };
          const shortId = (id) =>
            id ? String(id).slice(0, 8).toUpperCase() : "";

          let __PAYMENTS = [];
          let __JOBS_BY_ID = {};
          let __INSTALLERS_BY_ID = {};

          function statusToUi(payment_status) {
            if (payment_status === "unpaid")
              return {
                ds: "not-paid",
                text: "Not Paid",
                cls: "status not-paid",
                action: "mark",
              };
            if (payment_status === "pending_payout")
              return {
                ds: "pending_payout",
                text: "Pending Payout",
                cls: "status pending",
                action: "payout",
              };
            if (payment_status === "disbursed")
              return {
                ds: "disbursed",
                text: "Disbursed",
                cls: "status paid",
                action: "none",
              };
            return {
              ds: "paid",
              text: "Paid",
              cls: "status paid",
              action: "none",
            };
          }

          async function loadPayments() {
            const { data: pays, error: payErr } = await sbClient
              .schema("earnings")
              .from("payments")
              .select(
                "id, installer_id, job_id, payment_status, payout_batch_no, first_created_at, updated_at"
              )
              .order("first_created_at", { ascending: false });

            if (payErr) {
              console.error(payErr);
              tbodyPayments.innerHTML =
                '<tr><td colspan="8" data-col="Notice" class="sub">Error loading payments.</td></tr>';
              return;
            }
            if (!pays || pays.length === 0) {
              __PAYMENTS = [];
              window.__PAYMENTS = __PAYMENTS; /* expose (ADDED) */
              tbodyPayments.innerHTML =
                '<tr><td colspan="8" data-col="Notice" class="sub">No payment requests yet.</td></tr>';
              if (window.__buildRequests) window.__buildRequests();
              return;
            }
            __PAYMENTS = pays;
            window.__PAYMENTS = __PAYMENTS; /* expose (ADDED) */

            // jobs
            const jobIds = [
              ...new Set(pays.map((p) => p.job_id).filter(Boolean)),
            ];
            __JOBS_BY_ID = {};
            if (jobIds.length) {
              const { data: jobs } = await sbClient
                .schema("jobs")
                .from("job")
                .select("job_id, job_code, job_title, job_pay")
                .in("job_id", jobIds);
              if (jobs)
                __JOBS_BY_ID = Object.fromEntries(
                  jobs.map((j) => [j.job_id, j])
                );
            }

            // installers
            const installerIds = [
              ...new Set(pays.map((p) => p.installer_id).filter(Boolean)),
            ];
            __INSTALLERS_BY_ID = {};
            if (installerIds.length) {
              const { data: installers } = await sbClient
                .from("installer")
                .select("id, name, email")
                .in("id", installerIds);
              if (installers)
                __INSTALLERS_BY_ID = Object.fromEntries(
                  installers.map((i) => [i.id, i])
                );
            }

            // Group pending_payout by batch
            const pendingGroups = new Map(); // key = payout_batch_no
            // Group disbursed by batch (NEW)
            const disbursedGroups = new Map(); // key = payout_batch_no

            for (const p of pays) {
              const job = __JOBS_BY_ID[p.job_id] || {};
              const amount = Number(job.job_pay) || 0;

              if (p.payment_status === "pending_payout" && p.payout_batch_no) {
                const k = p.payout_batch_no;
                if (!pendingGroups.has(k)) {
                  pendingGroups.set(k, {
                    key: k,
                    payment_ids: [],
                    job_labels: new Set(),
                    installers: new Set(),
                    installer_display: null,
                    count: 0,
                    total: 0,
                    requested_at: p.updated_at || p.first_created_at || null,
                  });
                }
                const g = pendingGroups.get(k);
                g.payment_ids.push(p.id);
                g.installers.add(p.installer_id);
                g.count += 1;
                g.total += amount;
                const jobDisplay = job.job_code
                  ? job.job_code
                  : `#${shortId(p.job_id)}`;
                g.job_labels.add(jobDisplay);
                const ts = (d) => (d ? new Date(d).getTime() : Infinity);
                if (
                  ts(p.updated_at || p.first_created_at) < ts(g.requested_at)
                ) {
                  g.requested_at = p.updated_at || p.first_created_at;
                }
              }

              if (p.payment_status === "disbursed" && p.payout_batch_no) {
                const k = p.payout_batch_no;
                if (!disbursedGroups.has(k)) {
                  disbursedGroups.set(k, {
                    key: k,
                    payment_ids: [],
                    job_labels: new Set(),
                    installers: new Set(),
                    installer_display: null,
                    count: 0,
                    total: 0,
                    requested_at: p.updated_at || p.first_created_at || null,
                  });
                }
                const g = disbursedGroups.get(k);
                g.payment_ids.push(p.id);
                g.installers.add(p.installer_id);
                g.count += 1;
                g.total += amount;
                const jobDisplay = job.job_code
                  ? job.job_code
                  : `#${shortId(p.job_id)}`;
                g.job_labels.add(jobDisplay);
                const ts = (d) => (d ? new Date(d).getTime() : Infinity);
                if (
                  ts(p.updated_at || p.first_created_at) < ts(g.requested_at)
                ) {
                  g.requested_at = p.updated_at || p.first_created_at;
                }
              }
            }

            // Determine installer display for groups
            const resolveInstallerDisplay = (set) => {
              if (set.size === 1) {
                const only = [...set][0];
                const inst = __INSTALLERS_BY_ID[only] || {};
                return inst.name || inst.email || shortId(only);
              }
              return "Multiple";
            };
            for (const g of pendingGroups.values())
              g.installer_display = resolveInstallerDisplay(g.installers);
            for (const g of disbursedGroups.values())
              g.installer_display = resolveInstallerDisplay(g.installers);

            // Build table rows
            const rowsHtml = [];
            const pesoFmt = (n) =>
              "₱" +
              (Number(n) || 0).toLocaleString("en-PH", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              });

            // Individual rows (skip pending_payout with batch; skip disbursed with batch because we'll group them)
            for (const p of pays) {
              if (
                (p.payment_status === "pending_payout" && p.payout_batch_no) ||
                (p.payment_status === "disbursed" && p.payout_batch_no)
              ) {
                continue;
              }

              const job = __JOBS_BY_ID[p.job_id] || {};
              const inst = __INSTALLERS_BY_ID[p.installer_id] || {};
              const ui = statusToUi(p.payment_status);

              const jobDisplay = job.job_code
                ? job.job_code
                : `#${shortId(p.job_id)}`;
              const workerDisplay =
                inst.name || inst.email || shortId(p.installer_id);
              const titleDisplay = job.job_title || "—";
              const amountNum = job.job_pay != null ? Number(job.job_pay) : 0;
              const amount = peso(amountNum);
              const reqDate = fmtDate(p.first_created_at);

              const selectable = ui.ds === "not-paid";
              const selectCell = `<input type="checkbox" class="row-select" ${
                selectable ? "" : "disabled"
              } />`;

              rowsHtml.push(
                `<tr data-status="${ui.ds}"
                     data-payment-id="${p.id}"
                     data-installer-id="${p.installer_id}"
                     data-amount="${amountNum}"
                     data-batch="${p.payout_batch_no || ""}">
                  <td class="col-select" style="text-align:center;" data-col="Select">${selectCell}</td>
                  <td class="col-jobid" data-col="Job ID">${jobDisplay}</td>
                  <td class="col-worker" data-col="Worker">${workerDisplay}</td>
                  <td class="col-title" data-col="Job Title">${titleDisplay}</td>
                  <td data-col="Amount">${amount}</td>
                  <td data-col="Requested Date">${reqDate}</td>
                  <td data-col="Status"><span class="${ui.cls}">${ui.text}</span></td>
                  <td data-col="Action">${
                    ui.action === "mark"
                      ? '<button class="mark-paid" type="button">Mark as Paid</button>'
                      : ui.action === "payout"
                      ? '<button class="do-payout" type="button">Payout</button>'
                      : '<button type="button" disabled>Paid</button>'
                  }</td>
                </tr>`
              );
            }

            // Grouped pending rows
            for (const g of pendingGroups.values()) {
              const reqDate = fmtDate(g.requested_at);
              const jobLabels = Array.from(g.job_labels);
              const jobsTitle =
                jobLabels.length > 1
                  ? `JOBS: ${jobLabels.join(", ")}`
                  : `JOB: ${jobLabels[0] || "—"}`;
              rowsHtml.push(
                `<tr data-status="pending_payout"
                     data-payment-id=""
                     data-installer-id=""
                     data-amount="${g.total}"
                     data-batch="${g.key}">
                  <td class="col-select" style="text-align:center;" data-col="Select">—</td>
                  <td class="col-jobid mono" data-col="Job ID">${jobsTitle}</td>
                  <td class="col-worker" data-col="Worker">${g.installer_display}</td>
                  <td class="col-title" data-col="Job Title">Batch Payout (${g.count} payments)</td>
                  <td class="mono" data-col="Amount">${pesoFmt(g.total)}</td>
                  <td data-col="Requested Date">${reqDate}</td>
                  <td data-col="Status"><span class="status pending">Pending Payout</span></td>
                  <td data-col="Action">
                    <button class="do-payout-batch" type="button"
                            data-batch="${g.key}"
                            data-payment-ids='${JSON.stringify(
                              g.payment_ids
                            ).replace(/'</g, "&apos;")}'>
                      Payout Batch
                    </button>
                  </td>
                </tr>`
              );
            }

            // Grouped disbursed rows (NEW)
            for (const g of disbursedGroups.values()) {
              const reqDate = fmtDate(g.requested_at);
              const jobLabels = Array.from(g.job_labels);
              const jobsTitle =
                jobLabels.length > 1
                  ? `JOBS: ${jobLabels.join(", ")}`
                  : `JOB: ${jobLabels[0] || "—"}`;
              rowsHtml.push(
                `<tr data-status="disbursed"
                     data-payment-id=""
                     data-installer-id=""
                     data-amount="${g.total}"
                     data-batch="${g.key}">
                  <td class="col-select" style="text-align:center;" data-col="Select">—</td>
                  <td class="col-jobid mono" data-col="Job ID">${jobsTitle}</td>
                  <td class="col-worker" data-col="Worker">${g.installer_display}</td>
                  <td class="col-title" data-col="Job Title">Batch Disbursed (${g.count} payments)</td>
                  <td class="mono" data-col="Amount">${pesoFmt(g.total)}</td>
                  <td data-col="Requested Date">${reqDate}</td>
                  <td data-col="Status"><span class="status paid">Disbursed</span></td>
                  <td data-col="Action"><button type="button" disabled>Paid</button></td>
                </tr>`
              );
            }

            tbodyPayments.innerHTML =
              rowsHtml.join("") ||
              '<tr><td colspan="8" data-col="Notice" class="sub">No payment requests yet.</td></tr>';

            // apply current filters/search
            searchBtnEl.click();

            // refresh grouped view in Requests tab
            if (window.__buildRequests) window.__buildRequests();
            if (window.__paymentsUI)
              window.__paymentsUI.updateSelectionSummary();
          }

          // Build Requests tab groups (pending only)
          const requestsTbody = document.getElementById("requestsTbody");
          window.__buildRequests = function buildRequests() {
            const pending = __PAYMENTS.filter(
              (p) => p.payment_status === "pending_payout"
            );
            const groups = new Map();

            for (const p of pending) {
              const key = p.payout_batch_no || "";
              if (!key) continue;
              const job = __JOBS_BY_ID[p.job_id] || {};
              const amount = Number(job.job_pay) || 0;

              if (!groups.has(key)) {
                groups.set(key, {
                  key,
                  installer_id: p.installer_id,
                  installer_display:
                    __INSTALLERS_BY_ID[p.installer_id]?.name ||
                    __INSTALLERS_BY_ID[p.installer_id]?.email ||
                    shortId(p.installer_id),
                  count: 0,
                  total: 0,
                  requested_at: p.updated_at || p.first_created_at || null,
                  payment_ids: [],
                  job_labels: new Set(),
                });
              }
              const g = groups.get(key);
              g.count += 1;
              g.total += amount;
              g.payment_ids.push(p.id);
              const jobDisplay = job.job_code
                ? job.job_code
                : `#${shortId(p.job_id)}`;
              g.job_labels.add(jobDisplay);

              const ts = (d) => (d ? new Date(d).getTime() : Infinity);
              if (ts(p.updated_at || p.first_created_at) < ts(g.requested_at)) {
                g.requested_at = p.updated_at || p.first_created_at;
              }
            }

            if (groups.size === 0) {
              requestsTbody.innerHTML =
                '<tr><td colspan="6" data-col="Notice" class="sub" style="padding:1rem;">No payout requests yet.</td></tr>';
              return;
            }

            const pesoFmt = (n) =>
              "₱" +
              (Number(n) || 0).toLocaleString("en-PH", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              });
            const fmt = (d) =>
              d ? new Date(d).toISOString().slice(0, 10) : "—";

            const rows = Array.from(groups.values())
              .map((g) => {
                const list = Array.from(g.job_labels);
                const jobsTitle =
                  list.length > 1
                    ? `JOBS: ${list.join(", ")}`
                    : `JOB: ${list[0] || "—"}`;
                return `<tr data-batch-key="${g.key}"
                     data-payment-ids='${JSON.stringify(g.payment_ids).replace(
                       /'</g,
                       "&apos;"
                     )}'>
                  <td class="mono" data-col="Jobs">${jobsTitle}</td>
                  <td data-col="Installer">${g.installer_display}</td>
                  <td data-col="# Payments">${g.count}</td>
                  <td class="mono" data-col="Total Amount">${pesoFmt(g.total)}</td>
                  <td data-col="Requested Date">${fmt(g.requested_at)}</td>
                  <td data-col="Action"><button class="do-payout-group" type="button">Disburse Group</button></td>
                </tr>`;
              })
              .join("");

            requestsTbody.innerHTML = rows;
          };

          // start
          await loadPayments();
          window.__reloadPayments = loadPayments;
        </script>

        <!-- Persist single actions -->
        <script type="module">
          const sbRef = window.__sb;
          const tableBodyEl = document.getElementById("paymentsTbody");
          const requestsBodyEl = document.getElementById("requestsTbody");

          // Single mark as paid
          tableBodyEl.addEventListener("click", async (e) => {
            const btn = e.target.closest(".mark-paid");
            if (!btn) return;

            const tr = btn.closest("tr");
            const paymentId = tr?.dataset?.paymentId;
            if (!paymentId) return;

            try {
              const { error } = await sbRef
                .schema("earnings")
                .from("payments")
                .update({ payment_status: "paid" })
                .eq("id", paymentId);

              if (error) throw error;
              // UI already flipped in earlier handler
            } catch (err) {
              console.error("Failed to mark as paid:", err);
              tr.dataset.status = "not-paid";
              const statusEl = tr.querySelector(".status");
              if (statusEl) {
                statusEl.textContent = "Not Paid";
                statusEl.classList.remove("paid");
                statusEl.classList.add("not-paid");
              }
              btn.textContent = "Mark as Paid";
              btn.disabled = false;
              alert(
                "Could not mark as paid: " + (err?.message || "Unknown error")
              );
            }
          });

          /* ====== UPDATED: SINGLE disburse asks for reference number via modal too ====== */
          tableBodyEl.addEventListener("click", async (e) => {
            const payBtn = e.target.closest(".do-payout");
            if (!payBtn) return;

            const tr = payBtn.closest("tr");
            const paymentId = tr?.dataset?.paymentId;
            if (!paymentId) return;

            // Show bank details + reference input for a single payment
            const okRef = await window.__confirmWithBankDetails(
              [paymentId],
              "single payment"
            );
            if (!okRef?.proceed) return;

            try {
              const { error } = await sbRef
                .schema("earnings")
                .from("payments")
                .update({
                  payment_status: "disbursed",
                  reference_number: okRef.reference,
                })
                .eq("id", paymentId);

              if (error) throw error;

              tr.dataset.status = "disbursed";
              const statusEl = tr.querySelector(".status");
              if (statusEl) {
                statusEl.textContent = "Disbursed";
                statusEl.classList.remove("not-paid", "pending");
                statusEl.classList.add("paid");
              }
              payBtn.textContent = "Paid";
              payBtn.disabled = true;

              if (window.__tabMode === "requests") tr.style.display = "none";
              if (window.__paymentsUI)
                window.__paymentsUI.updateSelectionSummary();
              if (window.__buildRequests) window.__buildRequests();
            } catch (err) {
              console.error("Failed to disburse:", err);
              alert(
                "Could not mark as disbursed: " +
                  (err?.message || "Unknown error")
              );
            }
          });

          /* ====== BATCH/GROUP CONFIRMATION WITH BANK DETAILS + REFERENCE INPUT (ADDED/UPDATED) ====== */

          // Helper: open confirmation modal listing installers' bank details + reference input for the given payment IDs.
          async function confirmWithBankDetails(
            paymentIds,
            contextLabel = "batch"
          ) {
            try {
              const allPays = Array.isArray(window.__PAYMENTS)
                ? window.__PAYMENTS
                : [];
              const instIds = [
                ...new Set(
                  allPays
                    .filter((p) => paymentIds.includes(p.id))
                    .map((p) => p.installer_id)
                    .filter(Boolean)
                ),
              ];

              if (!instIds.length) {
                const ref = prompt(
                  `Enter GCash Reference Number for this ${contextLabel}:`
                );
                if (!ref) return { proceed: false, reference: "" };
                return { proceed: true, reference: ref.trim() };
              }

              // Fetch bank fields for installers
              const { data: installers, error } = await sbRef
                .from("installer")
                .select(
                  'id, name, email, "bankName", "accountNumber", "accountHolder"'
                )
                .in("id", instIds);

              if (error) {
                console.warn("Bank details fetch error:", error);
              }

              // Fill UI
              const overlay = document.getElementById("bankConfirmModal");
              const tbody = document.getElementById("bankModalBody");
              const title = document.getElementById("bankModalTitle");
              const refInput = document.getElementById("bankRefInput");
              const refError = document.getElementById("bankRefError");
              const btnCancel = document.getElementById("bankCancelBtn");
              const btnOk = document.getElementById("bankConfirmBtn");

              title.textContent = `Confirm Disbursement (${contextLabel})`;
              tbody.innerHTML =
                (installers || [])
                  .map(
                    (i) => `
                <tr>
                  <td>${i.name || i.email || i.id}</td>
                  <td>${i.bankName || "—"}</td>
                  <td class="mono">${i.accountNumber || "—"}</td>
                  <td>${i.accountHolder || "—"}</td>
                </tr>
              `
                  )
                  .join("") ||
                `<tr><td colspan="4" class="sub">No bank details found.</td></tr>`;

              refInput.value = "";
              refError.textContent = "";

              return await new Promise((resolve) => {
                function cleanup(val) {
                  overlay.classList.remove("show");
                  btnCancel.removeEventListener("click", onCancel);
                  btnOk.removeEventListener("click", onOk);
                  overlay.removeEventListener("click", onBackdrop);
                  refInput.removeEventListener("input", onInput);
                  resolve(val);
                }
                function onCancel() {
                  cleanup({ proceed: false, reference: "" });
                }
                function onBackdrop(e) {
                  if (e.target === overlay)
                    cleanup({ proceed: false, reference: "" });
                }
                function onInput() {
                  refError.textContent = "";
                }
                function onOk() {
                  const ref = refInput.value.trim();
                  // Basic validation: 6–64 chars, letters/numbers/-/_
                  const ok = /^[A-Za-z0-9\-_]{6,64}$/.test(ref);
                  if (!ok) {
                    refError.textContent =
                      "Please enter a valid reference (6–64 chars, letters/numbers/-/_).";
                    refInput.focus();
                    return;
                  }
                  cleanup({ proceed: true, reference: ref });
                }

                btnCancel.addEventListener("click", onCancel);
                btnOk.addEventListener("click", onOk);
                overlay.addEventListener("click", onBackdrop);
                refInput.addEventListener("input", onInput);

                overlay.classList.add("show");
              });
            } catch (err) {
              console.error(err);
              const ref = prompt(
                `Enter GCash Reference Number for this ${contextLabel}:`
              );
              if (!ref) return { proceed: false, reference: "" };
              return { proceed: true, reference: ref.trim() };
            }
          }
          window.__confirmWithBankDetails = confirmWithBankDetails;

          // Disburse batch from main table (pending grouped row)
          tableBodyEl.addEventListener("click", async (e) => {
            const btn = e.target.closest(".do-payout-batch");
            if (!btn) return;

            let ids = [];
            try {
              ids = JSON.parse(btn.dataset.paymentIds || "[]");
            } catch {
              ids = [];
            }
            const batchKey = btn.dataset.batch || "";
            if (!ids.length || !batchKey) return;

            // Show bank details + reference input
            const ok = await confirmWithBankDetails(
              ids,
              `batch ${String(batchKey).toUpperCase().slice(0, 64)}`
            );
            if (!ok?.proceed) return;

            btn.disabled = true;
            const prevTxt = btn.textContent;
            btn.textContent = "Working...";

            try {
              const { error } = await sbRef
                .schema("earnings")
                .from("payments")
                .update({
                  payment_status: "disbursed",
                  reference_number: ok.reference,
                })
                .in("id", ids);

              if (error) throw error;

              if (window.__reloadPayments) window.__reloadPayments();
              alert("Batch disbursed successfully.");
            } catch (err) {
              console.error("Failed to disburse batch:", err);
              alert(
                "Could not disburse batch: " + (err?.message || "Unknown error")
              );
            } finally {
              btn.disabled = false;
              btn.textContent = prevTxt;
            }
          });

          // Disburse group from Requests tab
          requestsBodyEl.addEventListener("click", async (e) => {
            const btn = e.target.closest(".do-payout-group");
            if (!btn) return;
            const tr = btn.closest("tr");
            const key = tr?.dataset?.batchKey;
            const idsAttr = tr?.dataset?.paymentIds;
            if (!key || !idsAttr) return;

            let ids = [];
            try {
              ids = JSON.parse(idsAttr);
            } catch {
              ids = [];
            }
            if (!Array.isArray(ids) || ids.length === 0) return;

            // Show bank details + reference input
            const ok = await confirmWithBankDetails(
              ids,
              `group ${String(key).toUpperCase().slice(0, 64)}`
            );
            if (!ok?.proceed) return;

            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Working...";

            try {
              const { error } = await sbRef
                .schema("earnings")
                .from("payments")
                .update({
                  payment_status: "disbursed",
                  reference_number: ok.reference,
                })
                .in("id", ids);

              if (error) throw error;

              tr.remove();
              if (window.__reloadPayments) window.__reloadPayments();
              alert("Group disbursed successfully.");
            } catch (err) {
              console.error("Failed to disburse group:", err);
              alert(
                "Could not disburse group: " + (err?.message || "Unknown error")
              );
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
            }
          });
        </script>

        <!-- Batch payout integration (kept; button hidden) -->
        <script type="module">
          const sb = window.__sb;
          const tbody = document.getElementById("paymentsTbody");
          const selectAllVisibleEl =
            document.getElementById("selectAllVisible");
          const createPayoutBtn = document.getElementById("createPayoutBtn");

          function getVisibleUnpaidSelectedRows() {
            return Array.from(tbody.querySelectorAll("tr"))
              .filter(
                (r) =>
                  r.style.display !== "none" && r.dataset.status === "not-paid"
              )
              .filter((r) => r.querySelector(".row-select")?.checked);
          }

          function validateSameInstaller(rows) {
            const ids = new Set(rows.map((r) => r.dataset.installerId));
            if (ids.size <= 1) {
              return {
                ok: true,
                installerId: rows[0]?.dataset?.installerId || null,
              };
            }
            return { ok: false, installerId: null };
          }

          async function generateBatchNo() {
            try {
              const { data, error } = await sb.rpc("next_payout_batch", {
                prefix: "BATCH",
              });
              if (error) throw error;
              if (data && typeof data === "string" && data.length) return data;
            } catch (err) {
              console.warn(
                "RPC next_payout_batch failed, using client fallback:",
                err?.message || String(err)
              );
            }
            const d = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const rnd = (
              crypto.randomUUID
                ? crypto.randomUUID()
                : Math.random().toString(36).slice(2) +
                  Math.random().toString(36).slice(2)
            )
              .slice(0, 8)
              .toUpperCase();
            return `BATCH-${d}-${rnd}`;
          }

          async function createBatchPayout() {
            const selectedRows = getVisibleUnpaidSelectedRows();
            if (selectedRows.length === 0) return;

            const { ok } = validateSameInstaller(selectedRows);
            if (!ok) {
              alert("Selected rows must all belong to the same installer.");
              return;
            }

            const batchNo = await generateBatchNo();
            const paymentIds = selectedRows
              .map((r) => r.dataset.paymentId)
              .filter(Boolean);

            try {
              const { error } = await sb
                .schema("earnings")
                .from("payments")
                .update({
                  payout_batch_no: batchNo,
                  payment_status: "pending_payout",
                })
                .in("id", paymentIds);

              if (error) throw error;
            } catch (err) {
              console.error("Failed to update payments with batch:", err);
              alert(
                "Could not attach payments to batch: " +
                  (err?.message || "Unknown error")
              );
              return;
            }

            selectedRows.forEach((tr) => {
              tr.dataset.status = "pending_payout";
              tr.dataset.batch = batchNo;
              const statusEl = tr.querySelector(".status");
              if (statusEl) {
                statusEl.textContent = "Pending Payout";
                statusEl.classList.remove("not-paid", "paid");
                statusEl.classList.add("pending");
              }
              const actionCellBtn = tr.querySelector(".mark-paid");
              if (actionCellBtn) {
                actionCellBtn.classList.remove("mark-paid");
                actionCellBtn.classList.add("do-payout");
                actionCellBtn.textContent = "Payout";
                actionCellBtn.disabled = false;
              }
              const cb = tr.querySelector(".row-select");
              if (cb) cb.checked = false;
            });

            selectAllVisibleEl.checked = false;

            if (window.__reloadPayments) window.__reloadPayments();
            alert(`Payout created.\nBatch: ${batchNo}`);
          }

          createPayoutBtn.addEventListener("click", async () => {
            if (createPayoutBtn.disabled) return;
            await createBatchPayout();
          });
        </script>

        <!-- Bulk "Mark as Paid" -->
        <script type="module">
          const sbulk = window.__sb;
          const tbodyBulk = document.getElementById("paymentsTbody");
          const bulkBtn = document.getElementById("bulkMarkPaidBtn");
          const selectAllVisible = document.getElementById("selectAllVisible");

          function getSelectedUnpaidRows() {
            return Array.from(tbodyBulk.querySelectorAll("tr"))
              .filter(
                (r) =>
                  r.style.display !== "none" && r.dataset.status === "not-paid"
              )
              .filter((r) => r.querySelector(".row-select")?.checked);
          }

          bulkBtn.addEventListener("click", async () => {
            const rows = getSelectedUnpaidRows();
            if (rows.length === 0) {
              alert('Select at least one "Not Paid" row first.');
              return;
            }

            const ids = rows.map((r) => r.dataset.paymentId).filter(Boolean);
            if (!ids.length) return;

            const ok = confirm(
              `Mark ${ids.length} selected payment(s) as PAID?`
            );
            if (!ok) return;

            bulkBtn.disabled = true;
            const prevText = bulkBtn.textContent;
            bulkBtn.textContent = "Working...";

            try {
              const { error } = await sbulk
                .schema("earnings")
                .from("payments")
                .update({ payment_status: "paid" })
                .in("id", ids);

              if (error) throw error;

              rows.forEach((tr) => {
                tr.dataset.status = "paid";
                const chip = tr.querySelector(".status");
                if (chip) {
                  chip.textContent = "Paid";
                  chip.classList.remove("not-paid", "pending");
                  chip.classList.add("paid");
                }
                const btn = tr.querySelector(".mark-paid");
                if (btn) {
                  btn.textContent = "Paid";
                  btn.disabled = true;
                }
                const cb = tr.querySelector(".row-select");
                if (cb) cb.checked = false;
              });

              if (selectAllVisible) selectAllVisible.checked = false;

              if (window.__paymentsUI) {
                window.__paymentsUI.applyFilters();
                window.__paymentsUI.updateSelectionSummary();
              }

              alert("Selected payments marked as PAID.");
            } catch (err) {
              console.error("Bulk mark-as-paid failed:", err);
              alert(
                "Could not update selected payments: " +
                  (err?.message || "Unknown error")
              );
            } finally {
              bulkBtn.disabled = false;
              bulkBtn.textContent = prevText;
            }
          });
        </script>

        <!-- ===== NEW: Realtime updates → bump tab badges ===== -->
        <script type="module">
          const supa = window.__sb;

          // Badge elements
          const bAll = document.getElementById("badgeAll");
          const bReq = document.getElementById("badgeRequests");
          const bUnp = document.getElementById("badgeUnpaid");
          const bPaid = document.getElementById("badgePaid");
          const bDis = document.getElementById("badgeDisbursed");

          // Counters
          const counts = {
            all: 0,
            requests: 0,
            unpaid: 0,
            paid: 0,
            disbursed: 0,
          };

          function cap(n) {
            return n > 99 ? "99+" : String(n);
          }
          function renderBadges() {
            // All
            if (counts.all > 0) {
              bAll.hidden = false;
              bAll.textContent = cap(counts.all);
            } else {
              bAll.hidden = true;
            }
            // Requests
            if (counts.requests > 0) {
              bReq.hidden = false;
              bReq.textContent = cap(counts.requests);
            } else {
              bReq.hidden = true;
            }
            // Unpaid
            if (counts.unpaid > 0) {
              bUnp.hidden = false;
              bUnp.textContent = cap(counts.unpaid);
            } else {
              bUnp.hidden = true;
            }
            // Paid
            if (counts.paid > 0) {
              bPaid.hidden = false;
              bPaid.textContent = cap(counts.paid);
            } else {
              bPaid.hidden = true;
            }
            // Disbursed
            if (counts.disbursed > 0) {
              bDis.hidden = false;
              bDis.textContent = cap(counts.disbursed);
            } else {
              bDis.hidden = true;
            }
          }

          // Reset helper on tab click (doesn't interfere with your existing listeners)
          document.getElementById("tabAll").addEventListener("click", () => {
            counts.all = 0;
            renderBadges();
          });
          document
            .getElementById("tabRequests")
            .addEventListener("click", () => {
              counts.requests = 0;
              renderBadges();
            });
          document.getElementById("tabUnpaid").addEventListener("click", () => {
            counts.unpaid = 0;
            renderBadges();
          });
          document.getElementById("tabPaid").addEventListener("click", () => {
            counts.paid = 0;
            renderBadges();
          });
          document
            .getElementById("tabDisbursed")
            .addEventListener("click", () => {
              counts.disbursed = 0;
              renderBadges();
            });

          // Map DB status to tab bucket
          function bucketForStatus(status) {
            switch (status) {
              case "pending_payout":
                return "requests";
              case "unpaid":
                return "unpaid";
              case "paid":
                return "paid";
              case "disbursed":
                return "disbursed";
              default:
                return null;
            }
          }

          // Debounced reload to avoid thrashing on bursts
          let reloadTimer = null;
          function scheduleReload() {
            if (reloadTimer) return;
            reloadTimer = setTimeout(async () => {
              reloadTimer = null;
              try {
                if (window.__reloadPayments) await window.__reloadPayments();
              } catch (e) {
                console.error("reload failed", e);
              }
            }, 400);
          }

          // Subscribe to all changes on earnings.payments
          const channel = supa
            .channel("payments_request_live")
            .on(
              "postgres_changes",
              { event: "*", schema: "earnings", table: "payments" },
              (payload) => {
                // count for "All"
                counts.all += 1;

                // try to use NEW status; if not available, fallback to OLD
                const st =
                  (payload.new && payload.new.payment_status) ||
                  (payload.old && payload.old.payment_status) ||
                  "";
                const bucket = bucketForStatus(st);
                if (bucket && counts[bucket] != null) counts[bucket] += 1;

                renderBadges();
                scheduleReload();
              }
            )
            .subscribe();

          // Clean up (optional)
          window.addEventListener("beforeunload", () => {
            if (channel) supa.removeChannel(channel);
          });
        </script>
      </main>
    </div>

    <!-- ===== Bank Confirmation Modal (HTML updated: reference input added, GCash removed) ===== -->
    <div id="bankConfirmModal" class="bank-modal-overlay" aria-hidden="true">
      <div
        class="bank-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="bankModalTitle"
      >
        <div class="bm-header">
          <h3 id="bankModalTitle">Confirm Disbursement</h3>
          <button
            id="bankCancelBtn"
            class="bm-btn bm-cancel"
            type="button"
            title="Close"
          >
            Close
          </button>
        </div>
        <div class="bm-body">
          <table>
            <thead>
              <tr>
                <th>Installer</th>
                <th>Bank Name</th>
                <th>Account Number</th>
                <th>Account Holder</th>
              </tr>
            </thead>
            <tbody id="bankModalBody">
              <tr>
                <td colspan="4" class="sub">Loading…</td>
              </tr>
            </tbody>
          </table>

          <div class="bm-ref">
            <label for="bankRefInput">GCash Reference Number</label>
            <input id="bankRefInput" type="text" placeholder="e.g. 9AB12C34" />
            <small
              >Enter the GCash transaction reference you received. Allowed:
              letters, numbers, dash and underscore (6–64 chars).</small
            >
            <div id="bankRefError" class="bm-error"></div>
          </div>
        </div>
        <div class="bm-footer">
          <button id="bankConfirmBtn" class="bm-btn bm-confirm" type="button">
            Confirm Disbursement
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
