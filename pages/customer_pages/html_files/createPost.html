<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/png"
      href="../../../img/simpHappyMascotLogo.png"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <title>Create Post</title>
    <style>
      /* ====== SKELETON (added) ====== */
      .skeleton {
        display: none;
        padding: 24px;
      }

      main {
        margin-top: 1.4rem;
        padding: 1rem;
      }

      body.loading .skeleton {
        display: block;
      }

      body.loading main {
        display: none;
      }

      .sk-card {
        background: var(--card, #fff);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .sk-title {
        height: 28px;
        width: clamp(200px, 40%, 340px);
        border-radius: 8px;
      }

      .sk-sub {
        height: 14px;
        width: clamp(240px, 55%, 520px);
        border-radius: 7px;
        margin-top: 10px;
      }

      .sk-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        margin-top: 20px;
      }

      @media (max-width: 900px) {
        .sk-grid {
          grid-template-columns: 1fr;
        }
      }

      .sk-field {
        display: grid;
        gap: 10px;
      }

      .sk-label {
        height: 14px;
        width: 120px;
        border-radius: 6px;
      }

      .sk-input {
        height: 44px;
        border-radius: 12px;
      }

      .sk-textarea {
        height: 110px;
        border-radius: 12px;
      }

      .sk-row-2 {
        grid-column: span 2;
      }

      @media (max-width: 900px) {
        .sk-row-2 {
          grid-column: auto;
        }
      }

      .sk-map {
        height: 320px;
        border-radius: 12px;
      }

      .sk-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 14px;
      }

      .sk-btn {
        height: 44px;
        width: 120px;
        border-radius: 12px;
      }

      .sk {
        position: relative;
        overflow: hidden;
        background: #f1f5f9;
        border: 1px solid var(--line, #e5e7eb);
      }

      .sk::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0.6) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        animation: sk-shimmer 1.25s infinite;
      }

      @keyframes sk-shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      /* ====== ORIGINAL PAGE STYLES (unchanged) ====== */
      main {
        margin-top: 1.4rem;
      }

      section.card {
        background: white;
        padding: 24px;
        border-radius: 14px;
        margin-bottom: 30px;
        border: 1px solid #ccc;
        animation: fadeIn 0.6s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hidden {
        display: none;
      }

      .form-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      @media (max-width: 900px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .field.inline {
        flex-direction: row;
        align-items: center;
        gap: 12px;
      }

      .field label {
        font-size: 0.92rem;
        color: #111827;
        font-weight: 600;
      }

      .hint {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .ctrl {
        position: relative;
        display: flex;
        align-items: center;
        background: #f9fafb;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      }

      .ctrl:focus-within {
        border-color: var(--brand);
        box-shadow: 0 0 0 4px var(--ring);
        background: #fff;
      }

      .ctrl input,
      .ctrl textarea,
      .ctrl select {
        border: none;
        outline: none;
        background: transparent;
        width: 100%;
        font-size: 1rem;
      }

      .ctrl textarea {
        min-height: 110px;
        resize: vertical;
      }

      .affix {
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
        color: #6b7280;
      }

      .affix.left {
        margin-right: 10px;
      }

      .affix.right {
        margin-left: 10px;
      }

      .row-2 {
        grid-column: span 2;
      }

      @media (max-width: 900px) {
        .row-2 {
          grid-column: auto;
        }
      }

      .slider-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      input[type="range"] {
        width: 100%;
      }

      .badge {
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-weight: 600;
        font-size: 0.85rem;
      }

      .dropzone {
        border: 1.5px dashed #cbd5e1;
        border-radius: 12px;
        padding: 14px;
        text-align: center;
        background: #f9fafb;
        transition: border 0.15s, background 0.15s;
      }

      .dropzone:hover {
        border-color: var(--brand);
        background: #fff;
      }

      .dropzone input {
        display: none;
      }

      .dz-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .dz-thumb {
        margin-top: 12px;
        display: none;
      }

      .dz-thumb img {
        max-width: 100%;
        border-radius: 10px;
        border: 1px solid var(--line);
      }

      /* Keep the action buttons visible while scrolling */
      .actions {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 10px;
        padding-top: 10px;
        padding-bottom: 10px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0) 0%,
          #ffffff 30%
        );
        border-top: 1px solid #eef2f7;
        z-index: 3;
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        background: var(--brand);
        color: #fff;
        transition: transform 0.04s ease, background 0.15s ease;
      }

      .btn:hover {
        background: var(--brand-ink);
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn.ghost {
        background: #eef2ff;
        color: #3730a3;
      }

      .btn.ghost:hover {
        background: #e0e7ff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eef2f7;
        text-align: left;
        font-size: 0.95rem;
      }

      th {
        color: #0f172a;
        background: #f8fafc;
        font-weight: 700;
      }

      #job-map {
        height: 320px;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 6px;
        border: 1px solid var(--line);
      }

      .loc-hint {
        color: #6b7280;
        font-size: 0.88rem;
        margin: 0.2rem 0 0.6rem;
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .loc-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .loc-row .btn {
        white-space: nowrap;
      }

      .hr {
        height: 1px;
        background: var(--line);
        margin: 12px 0;
        border-radius: 1px;
        opacity: 0.7;
      }

      /* --- Compact SweetAlert (added) --- */
      .swal2-compact-popup {
        padding: 14px 16px !important;
        border-radius: 14px !important;
        max-width: min(92vw, 420px) !important;
      }
      .swal2-compact-title {
        font-size: 18px !important;
        margin: 2px 0 6px !important;
        line-height: 1.2 !important;
        font-weight: 800 !important;
        color: #0f172a !important;
      }
      .swal2-compact-html {
        font-size: 14px !important;
        line-height: 1.45 !important;
        color: #334155 !important;
      }
      .swal2-compact-confirm,
      .swal2-compact-cancel {
        background: #20a44c;
        color: #fff;
        border: 0;
        border-radius: 999px;
        padding: 9px 16px;
        font-weight: 800;
        margin: 6px 4px;
      }
      .swal2-compact-cancel {
        background: #e5e7eb;
        color: #111827;
      }
      .swal2-icon {
        margin: 8px auto !important;
      }
      .swal2-actions {
        margin-top: 8px !important;
      }
      .swal2-timer-progress-bar {
        background: rgba(32, 100, 124, 0.25) !important;
      }

      /* Prevent layout jump when modal opens by keeping scrollbar space */
      html {
        overflow-y: scroll;
      }

      /* ====== REQUIRED FIELD INDICATORS (added) ====== */
      .req-star {
        color: #ef4444;
        font-weight: 900;
        margin-left: 4px;
      }

      .required-hint {
        margin: 0.35rem 0 1rem;
        color: #64748b;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .field-error {
        display: none;
        margin-top: 6px;
        font-size: 0.85rem;
        color: #b91c1c;
      }

      .field.invalid label {
        color: #b91c1c;
      }

      .ctrl.invalid {
        border-color: #ef4444 !important;
        background: #fff !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.12) !important;
      }

      .field.invalid .field-error {
        display: block;
      }
    </style>
  </head>

  <!-- Initial 'loading' to show skeleton first -->

  <body class="loading">
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="../../../img/simpHappyMascotLogo.png" alt="logo" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>

        <div class="sidebar">
          <a href="myJobPosts.html"
            ><span class="material-icons-sharp">cases</span>
            <h3>My Job Posts</h3>
          </a>
          <a href="createPost.html" class="active" id="nav-create"
            ><span class="material-icons-sharp">add</span>
            <h3>Create a post</h3>
          </a>
          <a href="settings.html" id="nav-create"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3>
          </a>
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3>
          </a>
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- ====== SKELETON UI (added) ====== -->
      <div class="skeleton">
        <section class="sk-card">
          <div class="sk sk-title"></div>
          <div class="sk sk-sub"></div>

          <div class="sk-grid">
            <div class="sk-field sk-row-2">
              <div class="sk sk-label"></div>
              <div class="sk sk-input" style="height: 48px"></div>
            </div>

            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>
            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>
            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>
            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>
            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>
            <div class="sk-field">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
            </div>

            <div class="sk-field sk-row-2">
              <div class="sk sk-label"></div>
              <div class="sk sk-textarea"></div>
            </div>

            <div class="sk-field sk-row-2">
              <div class="sk sk-label"></div>
              <div class="sk sk-input"></div>
              <div class="sk sk-map"></div>
            </div>
          </div>

          <div class="sk-actions">
            <div class="sk sk-btn"></div>
            <div class="sk sk-btn" style="width: 140px"></div>
          </div>
        </section>
      </div>

      <!--MAIN CONTENT-->
      <main>
        <!-- Create/Edit Post -->
        <h1 id="form-title">Create a Job Post</h1>
        <p class="sub" id="form-sub">
          Keep it short, clear, and accurate—workers decide fast.
        </p>

        <!-- REQUIRED HINT (added) -->
        <p class="required-hint">
          <span class="req-star" aria-hidden="true">*</span> Required fields
        </p>

        <section class="card" id="create-post">
          <form id="jobForm" novalidate>
            <div class="form-grid">
              <!-- Title -->
              <div class="field row-2">
                <label for="job_title"
                  >Job Title<span class="req-star" aria-hidden="true"
                    >*</span
                  ></label
                >
                <div class="ctrl">
                  <input
                    type="text"
                    id="job_title"
                    placeholder="e.g., Aircon cleaning for studio unit"
                    required
                  />
                </div>
                <div class="field-error" aria-live="polite"></div>
              </div>

              <!-- Category -->
              <div class="field">
                <label for="job_category">Category</label>
                <div class="ctrl">
                  <select id="job_category">
                    <option value="">Select a category</option>
                    <option>Cleaning</option>
                    <option>Electrical</option>
                    <option>Plumbing</option>
                    <option>Delivery</option>
                    <option>IT Support</option>
                    <option>General Help</option>
                  </select>
                </div>
                <div class="hint">Choose the closest fit.</div>
              </div>

              <!-- Difficulty -->
              <div class="field">
                <label for="job_difficulty_range">Difficulty</label>
                <div class="ctrl">
                  <div class="slider-wrap">
                    <input
                      type="range"
                      id="job_difficulty_range"
                      min="1"
                      max="10"
                      step="1"
                      value="3"
                    />
                    <span class="badge" id="diffBadge">3/10</span>
                  </div>
                </div>
                <input type="hidden" id="job_difficulty" value="3" />
                <div class="hint">1 = very easy, 10 = expert-level.</div>
              </div>

              <!-- Pay -->
              <div class="field">
                <label for="job_pay"
                  >Pay<span class="req-star" aria-hidden="true">*</span></label
                >
                <div class="ctrl">
                  <span class="affix left">₱</span>
                  <input
                    type="number"
                    id="job_pay"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="e.g., 1500.00"
                    required
                  />
                </div>
                <div class="hint">Set a fair, competitive rate.</div>
                <div class="field-error" aria-live="polite"></div>
              </div>

              <!-- Date -->
              <div class="field">
                <label for="job_date"
                  >Date<span class="req-star" aria-hidden="true">*</span></label
                >
                <div class="ctrl">
                  <input type="date" id="job_date" required />
                </div>
                <div class="field-error" aria-live="polite"></div>
              </div>

              <!-- Time -->
              <div class="field">
                <label for="job_time"
                  >Start Time<span class="req-star" aria-hidden="true"
                    >*</span
                  ></label
                >
                <div class="ctrl">
                  <span
                    class="affix left material-icons-sharp"
                    aria-hidden="true"
                    >schedule</span
                  >
                  <input type="time" id="job_time" required />
                </div>
                <div class="field-error" aria-live="polite"></div>
              </div>

              <!-- Duration (Hours) -->
              <div class="field">
                <label for="job_duration"
                  >Estimated Duration<span class="req-star" aria-hidden="true"
                    >*</span
                  ></label
                >
                <div class="ctrl">
                  <input
                    type="number"
                    id="job_duration"
                    min="1"
                    step="1"
                    placeholder="e.g., 3"
                    required
                  />
                  <span class="affix right">hours</span>
                </div>
                <div class="field-error" aria-live="polite"></div>
              </div>

              <!-- Picture / Dropzone -->
              <div class="field">
                <label>Photo (optional)</label>
                <div class="dropzone" id="dz">
                  <div>
                    Drag & drop a photo here, or
                    <label
                      for="job_picture"
                      style="
                        color: var(--brand);
                        cursor: pointer;
                        font-weight: 700;
                      "
                      >browse</label
                    >
                  </div>
                  <input type="file" id="job_picture" accept="image/*" />
                  <div class="dz-actions hint">
                    Clear, well-lit photos help workers decide faster.
                  </div>
                  <div class="dz-thumb" id="dzThumb">
                    <img id="dzImg" alt="Preview" />
                  </div>
                </div>
              </div>

              <!-- Description -->
              <div class="field row-2">
                <label for="job_description">Details / Instructions</label>
                <div class="ctrl">
                  <textarea
                    id="job_description"
                    placeholder="Key tasks, tools available, building rules, parking, contact person…"
                  ></textarea>
                </div>
              </div>

              <!-- Location -->
              <div class="field row-2">
                <label for="job_location"
                  >Location<span class="req-star" aria-hidden="true">*</span></label
                >
                <div class="ctrl">
                  <input
                    type="text"
                    id="job_location"
                    placeholder="Type an address or use the map"
                    required
                  />
                </div>
                <div class="field-error" aria-live="polite"></div>
                <div class="loc-row">
                  <button type="button" class="btn ghost" id="btnLocate">
                    <span
                      class="material-icons-sharp"
                      style="vertical-align: middle"
                      >my_location</span
                    >
                    Locate me
                  </button>
                  <span class="hint"
                    >Click on the map or drag the pin to set the exact
                    spot.</span
                  >
                </div>
                <div id="job-map"></div>
                <input type="hidden" id="job_lat" />
                <input type="hidden" id="job_lng" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="actions">
              <button type="reset" class="btn ghost" id="btnReset">
                Reset
              </button>
              <button type="submit" class="btn" id="submitBtn">Post Job</button>
            </div>
          </form>
        </section>

        <!-- View My Posts (optional, unchanged) -->
        <section class="card hidden" id="view-posts">
          <h1>My Job Posts</h1>
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Date</th>
                <th>Pay</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody id="postsTable"></tbody>
          </table>
        </section>
      </main>
    </div>

    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SweetAlert2 (added) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      /* ---------- Scroll freeze helpers to prevent page jump on modal (with scrollbar compensation) ---------- */
      let __scrollY = 0;
      let __bodyPadRight = "";
      function getScrollbarWidth() {
        const d = document.createElement("div");
        d.style.width = "100px";
        d.style.height = "100px";
        d.style.overflow = "scroll";
        d.style.position = "absolute";
        d.style.top = "-9999px";
        document.body.appendChild(d);
        const w = d.offsetWidth - d.clientWidth;
        document.body.removeChild(d);
        return w;
      }
      function lockBodyScroll() {
        __scrollY = window.scrollY || window.pageYOffset || 0;
        const pad = getScrollbarWidth();
        __bodyPadRight = document.body.style.paddingRight || "";
        if (pad > 0) document.body.style.paddingRight = pad + "px";
        document.body.style.position = "fixed";
        document.body.style.top = `-${__scrollY}px`;
        document.body.style.left = "0";
        document.body.style.right = "0";
        document.body.style.width = "100%";
      }
      function unlockBodyScroll() {
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        document.body.style.paddingRight = __bodyPadRight;
        window.scrollTo(0, __scrollY);
      }

      /* ---------- SweetAlert base + toast (compact) ---------- */
      const swalBase = Swal.mixin({
        customClass: {
          popup: "swal2-compact-popup",
          confirmButton: "swal2-compact-confirm",
          cancelButton: "swal2-compact-cancel",
          title: "swal2-compact-title",
          htmlContainer: "swal2-compact-html",
        },
        buttonsStyling: false,
        allowOutsideClick: false,
        allowEscapeKey: true,
        backdrop: true,
        heightAuto: false,
        returnFocus: false,
        willOpen: lockBodyScroll,
        didClose: unlockBodyScroll,
      });

      const toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 2200,
        timerProgressBar: true,
        customClass: { popup: "swal2-compact-popup" },
        returnFocus: false,
      });

      /* ---------- Friendly error mapping (non-technical) ---------- */
      function prettyError(err) {
        const message = err?.message || String(err || "");
        const raw = message.toLowerCase();

        if (raw.includes("unauthorized") || raw.includes("not logged")) {
          return "Please sign in to continue.";
        }
        if (
          raw.includes("user already") ||
          raw.includes("duplicate") ||
          raw.includes("exists")
        ) {
          return "This looks like a duplicate. Try changing the title or try again.";
        }
        if (
          raw.includes("bucket") ||
          raw.includes("storage") ||
          raw.includes("not found")
        ) {
          return "We couldn’t save your photo right now. Please try again in a moment.";
        }
        if (
          raw.includes("file too large") ||
          raw.includes("payload too large") ||
          raw.includes("limit")
        ) {
          return "That image is a bit too large. Choose a smaller file.";
        }
        if (
          raw.includes("network") ||
          raw.includes("fetch") ||
          raw.includes("timeout")
        ) {
          return "We couldn’t connect. Please check your internet and try again.";
        }
        if (raw.includes("permission") || raw.includes("forbidden")) {
          return "You don’t have access to do that.";
        }
        if (!message) {
          return "Something went wrong. Please try again.";
        }
        // Default: show a softened version of the original, without tech jargon
        return "Something went wrong. Please try again.";
      }

      /* ---------- Unified notice wrapper (modals for primary feedback) ---------- */
      async function showNotice(msg, type = "info", opts = {}) {
        const common = { html: msg, ...opts };
        if (type === "success") {
          return swalBase.fire({
            icon: "success",
            title: "Success",
            ...common,
            confirmButtonText: "OK",
          });
        } else if (type === "error") {
          return swalBase.fire({
            icon: "error",
            title: "There was a problem",
            ...common,
            confirmButtonText: "OK",
          });
        } else if (type === "warning") {
          return swalBase.fire({
            icon: "warning",
            title: "Please check",
            ...common,
            confirmButtonText: "OK",
          });
        } else if (type === "info-modal") {
          return swalBase.fire({
            icon: "info",
            title: "Heads up",
            ...common,
            confirmButtonText: "OK",
          });
        } else {
          // Lightweight info remains a toast
          return toast.fire({ icon: "info", title: msg });
        }
      }

      // === Private storage bucket for job pictures (must exist & be "private") ===
      const JOB_PICS_BUCKET = "jobs"; // change if your bucket name is different

      // ====== LOADING GATES (added) ======
      let mapLoaded = false;
      let editLoaded = false;
      function tryFinishLoading() {
        if (mapLoaded && editLoaded) {
          document.body.classList.remove("loading");
          setTimeout(() => map.invalidateSize(), 0);
        }
      }

      // ========= Helpers for INTERVAL <-> hours =========
      function intervalToHours(v) {
        if (v == null) return null;
        if (typeof v === "number" && isFinite(v))
          return Math.max(0, Math.round(v));
        const s = String(v).trim();

        let m = /^(\d{1,2}):([0-5]?\d)(?::([0-5]?\d))?$/.exec(s);
        if (m) {
          const h = parseInt(m[1] || "0", 10),
            min = parseInt(m[2] || "0", 10);
          return Math.max(0, Math.round(h + min / 60));
        }
        m = /(?:(\d+)\s+day[s]?\s*)?(\d{1,2}):([0-5]?\d)(?::([0-5]?\d))?/i.exec(
          s
        );
        if (m) {
          const d = parseInt(m[1] || "0", 10),
            h = parseInt(m[2] || "0", 10),
            min = parseInt(m[3] || "0", 10);
          return Math.max(0, Math.round(d * 24 + h + min / 60));
        }
        m = /^P(T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)$/i.exec(s);
        if (m) {
          const h = parseInt(m[2] || "0", 10),
            min = parseInt(m[3] || "0", 10);
          return Math.max(0, Math.round(h + min / 60));
        }
        if (/^\d+$/.test(s)) return Math.max(0, parseInt(s, 10));
        return null;
      }
      function hoursToInterval(hours) {
        const h = Math.max(0, parseInt(hours, 10) || 0);
        return `${String(h).padStart(2, "0")}:00:00`;
      }

      // ========= Signed URL helpers for Supabase Storage =========
      function parsePublicBucketAndPath(publicUrl) {
        try {
          const marker = "/storage/v1/object/public/";
          const i = publicUrl.indexOf(marker);
          if (i === -1) return null;
          const rest = publicUrl.substring(i + marker.length);
          const slash = rest.indexOf("/");
          if (slash === -1) return null;
          const bucket = rest.substring(0, slash);
          const path = rest.substring(slash + 1);
          return { bucket, path };
        } catch {
          return null;
        }
      }
      function parseStorageRef(ref) {
        if (!ref) return null;
        const s = String(ref).trim();
        if (/^https?:\/\//i.test(s)) {
          const parsed = parsePublicBucketAndPath(s);
          return parsed || null;
        }
        const bi = s.indexOf("::");
        if (bi > 0) return { bucket: s.slice(0, bi), path: s.slice(bi + 2) };
        return { bucket: JOB_PICS_BUCKET, path: s };
      }
      async function createSignedUrl(bucket, path, expires = 3600) {
        const { data, error } = await supabase.storage
          .from(bucket)
          .createSignedUrl(path, expires);
        if (error) throw error;
        return data.signedUrl;
      }
      async function resolveSignedUrl(ref) {
        if (!ref) return null;
        if (/^https?:\/\//i.test(ref) && !ref.includes("/storage/v1/object/"))
          return ref;
        const parsed = parseStorageRef(ref);
        if (!parsed) return null;
        try {
          return await createSignedUrl(parsed.bucket, parsed.path, 3600);
        } catch (e) {
          console.warn("Failed to create signed URL:", e.message);
          if (/^https?:\/\//i.test(ref)) return ref;
          return null;
        }
      }

      // ========= DOM hooks =========
      const form = document.getElementById("jobForm");
      const postsTable = document.getElementById("postsTable");

      const diffRange = document.getElementById("job_difficulty_range");
      const diffHidden = document.getElementById("job_difficulty");
      const diffBadge = document.getElementById("diffBadge");

      const dz = document.getElementById("dz");
      const fileInput = document.getElementById("job_picture");
      const dzThumb = document.getElementById("dzThumb");
      const dzImg = document.getElementById("dzImg");
      const btnReset = document.getElementById("btnReset");

      const inputLocation = document.getElementById("job_location");
      const inputLat = document.getElementById("job_lat");
      const inputLng = document.getElementById("job_lng");
      const btnLocate = document.getElementById("btnLocate");

      const inputDate = document.getElementById("job_date");
      const inputTitle = document.getElementById("job_title");
      const inputCategory = document.getElementById("job_category");
      const inputPay = document.getElementById("job_pay");
      const inputTime = document.getElementById("job_time");
      const inputDuration = document.getElementById("job_duration");
      const inputDesc = document.getElementById("job_description");

      const formTitle = document.getElementById("form-title");
      const formSub = document.getElementById("form-sub");
      const submitBtn = document.getElementById("submitBtn");

      /* ====== REQUIRED FIELD HIGHLIGHTING (added) ====== */
      const REQUIRED_FIELDS = [
        { input: inputTitle, name: "Job Title" },
        { input: inputPay, name: "Pay" },
        { input: inputDate, name: "Date" },
        { input: inputTime, name: "Start Time" },
        { input: inputDuration, name: "Estimated Duration" },
        { input: inputLocation, name: "Location" },
      ];

      function getFieldEl(input) {
        return input?.closest?.(".field") || null;
      }
      function getCtrlEl(input) {
        return input?.closest?.(".ctrl") || null;
      }
      function getErrorEl(fieldEl) {
        if (!fieldEl) return null;
        let el = fieldEl.querySelector(".field-error");
        if (!el) {
          el = document.createElement("div");
          el.className = "field-error";
          el.setAttribute("aria-live", "polite");
          fieldEl.appendChild(el);
        }
        return el;
      }
      function clearInvalid(input) {
        const field = getFieldEl(input);
        const ctrl = getCtrlEl(input);
        if (field) field.classList.remove("invalid");
        if (ctrl) ctrl.classList.remove("invalid");
        const err = field ? field.querySelector(".field-error") : null;
        if (err) err.textContent = "";
      }
      function setInvalid(input, message = "This field is required.") {
        const field = getFieldEl(input);
        const ctrl = getCtrlEl(input);
        if (field) field.classList.add("invalid");
        if (ctrl) ctrl.classList.add("invalid");
        const err = getErrorEl(field);
        if (err) err.textContent = message;
      }
      function clearAllInvalid() {
        REQUIRED_FIELDS.forEach(({ input }) => clearInvalid(input));
      }
      function validMoney(v) {
        const n = parseFloat(v);
        return Number.isFinite(n) && n > 0;
      }
      function validHours(v) {
        const n = parseInt(v, 10);
        return Number.isFinite(n) && n >= 1;
      }
      function validateRequiredUIOnly() {
        clearAllInvalid();
        const missing = [];

        if (!inputTitle.value.trim()) {
          setInvalid(inputTitle, "Please enter a job title.");
          missing.push("Job Title");
        }
        if (!validMoney(inputPay.value)) {
          setInvalid(inputPay, "Please enter a valid amount.");
          missing.push("Pay");
        }
        if (!inputDate.value) {
          setInvalid(inputDate, "Please choose a date.");
          missing.push("Date");
        }
        if (!inputTime.value) {
          setInvalid(inputTime, "Please choose a start time.");
          missing.push("Start Time");
        }
        if (!validHours(inputDuration.value)) {
          setInvalid(inputDuration, "Please enter hours (minimum 1).");
          missing.push("Estimated Duration");
        }
        if (!inputLocation.value.trim()) {
          setInvalid(inputLocation, "Please enter a location.");
          missing.push("Location");
        }

        return missing;
      }

      // Clear red state as user fixes inputs
      REQUIRED_FIELDS.forEach(({ input }) => {
        ["input", "change", "blur"].forEach((evt) => {
          input.addEventListener(evt, () => {
            // Only clear if the field becomes valid
            if (input === inputPay && validMoney(input.value)) clearInvalid(input);
            else if (input === inputDuration && validHours(input.value)) clearInvalid(input);
            else if (
              input !== inputPay &&
              input !== inputDuration &&
              String(input.value || "").trim()
            )
              clearInvalid(input);
          });
        });
      });

      // ========= UX bits =========
      diffRange.addEventListener("input", () => {
        diffBadge.textContent = `${diffRange.value}/10`;
        diffHidden.value = diffRange.value;
      });

      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        dz.style.borderColor = "#6366f1";
      });
      dz.addEventListener("dragleave", () => {
        dz.style.borderColor = "#cbd5e1";
      });
      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.style.borderColor = "#cbd5e1";
        if (e.dataTransfer.files?.length) {
          fileInput.files = e.dataTransfer.files;
          previewImage(fileInput.files[0]);
        }
      });
      fileInput.addEventListener("change", () => {
        if (fileInput.files?.length) previewImage(fileInput.files[0]);
      });
      function previewImage(file) {
        const reader = new FileReader();
        reader.onload = () => {
          dzImg.src = reader.result;
          dzThumb.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      // ========= MAP =========
      const DEFAULT_CENTER = [14.5995, 120.9842]; // Manila
      const DEFAULT_ZOOM = 12;

      const map = L.map("job-map").setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors',
      }).addTo(map);
      let marker = L.marker(DEFAULT_CENTER, { draggable: true }).addTo(map);

      map.whenReady(() => {
        mapLoaded = true;
        tryFinishLoading();
      });

      async function reverseGeocode(lat, lng) {
        try {
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
          const res = await fetch(url, {
            headers: {
              "Accept-Language": "en-PH",
              "User-Agent": "SIMPProject/1.0 (contact@example.com)",
            },
          });
          if (!res.ok) throw new Error("Reverse geocoding failed");
          const data = await res.json();
          return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        } catch {
          return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
      }
      async function setFromCoords(lat, lng, zoom = 16) {
        inputLocation.value = "Resolving address…";
        const addr = await reverseGeocode(lat, lng);
        inputLocation.value = addr;
        inputLat.value = lat;
        inputLng.value = lng;
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], zoom);
      }
      setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);
      map.on("click", (e) => setFromCoords(e.latlng.lat, e.latlng.lng, 17));
      marker.on("dragend", async () => {
        const { lat, lng } = marker.getLatLng();
        await setFromCoords(lat, lng, map.getZoom());
      });
      btnLocate.addEventListener("click", () => {
        if (!navigator.geolocation) {
          showNotice("Your browser can’t find your location.", "warning");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude: lat, longitude: lng, accuracy } = pos.coords;
            await setFromCoords(lat, lng, accuracy && accuracy < 60 ? 17 : 16);
            toast.fire({ icon: "success", title: "Location set" });
          },
          (err) =>
            showNotice(
              `We couldn’t get your location. ${err?.message || ""}`.trim(),
              "error"
            ),
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
        );
      });

      // ========= Date min (today) =========
      function todayYYYYMMDD() {
        const d = new Date(),
          y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }
      const TODAY_STR = todayYYYYMMDD();
      inputDate.setAttribute("min", TODAY_STR);

      // ========= Edit mode detection & loader =========
      const url = new URL(location.href);
      const jobId = url.searchParams.get("job_id");
      let EDIT_MODE = Boolean(jobId);
      let ORIGINAL_JOB = null;

      async function loadEditJob() {
        if (!EDIT_MODE) {
          editLoaded = true;
          tryFinishLoading();
          return;
        }
        formTitle.textContent = "Edit Job Post";
        formSub.textContent = "Update details, then save your changes.";
        submitBtn.textContent = "Save Changes";

        try {
          const cached = sessionStorage.getItem("edit_job_cache");
          if (cached) {
            const j = JSON.parse(cached);
            if (j && j.job_id === jobId) ORIGINAL_JOB = j;
          }
        } catch {}

        if (!ORIGINAL_JOB) {
          const { data, error } = await supabase
            .schema("jobs")
            .from("job")
            .select(
              "job_id, job_code, job_title, job_description, job_difficulty, job_category, job_location, job_date, job_time, job_pay, job_picture_url, job_duration, posted_by"
            )
            .eq("job_id", jobId)
            .maybeSingle();
          if (error) {
            showNotice(
              "We couldn’t load this post for editing. Please refresh and try again.",
              "error"
            );
            editLoaded = true;
            tryFinishLoading();
            return;
          }
          ORIGINAL_JOB = data;
        }

        if (ORIGINAL_JOB) {
          inputTitle.value = ORIGINAL_JOB.job_title || "";
          inputCategory.value = ORIGINAL_JOB.job_category || "";
          const diff = Number(ORIGINAL_JOB.job_difficulty || 3);
          diffRange.value = String(diff);
          diffHidden.value = String(diff);
          diffBadge.textContent = `${diff}/10`;

          inputPay.value = ORIGINAL_JOB.job_pay ?? "";
          inputDate.value = ORIGINAL_JOB.job_date ?? "";
          inputTime.value = ORIGINAL_JOB.job_time ?? "";

          const hrs = intervalToHours(ORIGINAL_JOB.job_duration);
          inputDuration.value = hrs ?? 1;

          inputDesc.value = ORIGINAL_JOB.job_description || "";
          inputLocation.value = ORIGINAL_JOB.job_location || "";

          if (ORIGINAL_JOB.job_picture_url) {
            try {
              const signed = await resolveSignedUrl(
                ORIGINAL_JOB.job_picture_url
              );
              if (signed) {
                dzImg.src = signed;
                dzThumb.style.display = "block";
              }
            } catch {}
          }
        }
        editLoaded = true;
        tryFinishLoading();
      }

      await loadEditJob();

      // ========= Reset behavior =========
      btnReset.addEventListener("click", () => {
        dzThumb.style.display = "none";
        dzImg.src = "";
        diffRange.value = "3";
        diffBadge.textContent = "3/10";
        diffHidden.value = "3";
        inputDate.setAttribute("min", TODAY_STR);
        setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);
        clearAllInvalid(); // (added)
        toast.fire({ icon: "info", title: "Form cleared" });
      });

      // ========= Submit (create or update) =========
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) {
          showNotice("Please sign in to post a job.", "warning");
          return;
        }

        const picked = inputDate.value;
        if (!picked || picked < TODAY_STR) {
          // (added) also highlight Date field if invalid/missing
          if (!picked) setInvalid(inputDate, "Please choose a date.");
          else setInvalid(inputDate, "Please choose today or a future date.");
          showNotice("Please choose today or a future date.", "warning");
          return;
        }

        let pictureRef = ORIGINAL_JOB?.job_picture_url || null;

        if (fileInput.files && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
          const safeName = file.name.replace(/[^\w.\-]/g, "_");
          const filePath = `${user.id}/${Date.now()}_${safeName}.${ext}`;
          const { error: upErr } = await supabase.storage
            .from(JOB_PICS_BUCKET)
            .upload(filePath, file, { upsert: true });
          if (upErr) {
            showNotice(
              `We couldn’t upload your photo. ${prettyError(upErr)}`,
              "error"
            );
            return;
          }
          pictureRef = filePath;

          try {
            const previewUrl = await resolveSignedUrl(pictureRef);
            if (previewUrl) {
              dzImg.src = previewUrl;
              dzThumb.style.display = "block";
            }
          } catch {}
        }

        const job_duration_interval = hoursToInterval(
          document.getElementById("job_duration").value
        );

        const payload = {
          job_title: inputTitle.value.trim(),
          job_description: inputDesc.value.trim(),
          job_difficulty: parseInt(diffHidden.value, 10),
          job_category: inputCategory.value || null,
          job_location: inputLocation.value.trim(),
          job_date: inputDate.value,
          job_time: inputTime.value,
          job_duration: job_duration_interval,
          job_pay: parseFloat(inputPay.value),
          job_picture_url: pictureRef,
        };

        /* ====== REQUIRED FIELDS: show exactly which inputs are required (added) ====== */
        const missing = validateRequiredUIOnly();
        if (missing.length) {
          await showNotice(
            `Please complete the required fields: <b>${missing.join(
              ", "
            )}</b>.`,
            "warning"
          );
          // Scroll to the first invalid field for convenience
          const firstInvalid = document.querySelector(".field.invalid");
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
          }
          return;
        }

        if (
          !payload.job_title ||
          !payload.job_location ||
          !payload.job_date ||
          !payload.job_time ||
          !payload.job_pay
        ) {
          showNotice("Please complete the required fields.", "warning");
          return;
        }

        if (!EDIT_MODE) {
          function genCode() {
            const L = Array.from({ length: 4 }, () =>
              String.fromCharCode(65 + Math.floor(Math.random() * 26))
            ).join("");
            const N = String(Math.floor(Math.random() * 10000)).padStart(
              4,
              "0"
            );
            return `${L}-${N}`;
          }
          const job_code = genCode();
          const insertPayload = { ...payload, job_code, posted_by: user.id };
          const { error } = await supabase
            .schema("jobs")
            .from("job")
            .insert([insertPayload]);
          if (error) {
            showNotice(prettyError(error), "error");
            return;
          }
          await showNotice("Your job has been posted.", "success");
          form.reset();
          dzThumb.style.display = "none";
          dzImg.src = "";
          diffRange.value = "3";
          diffBadge.textContent = "3/10";
          diffHidden.value = "3";
          inputDate.setAttribute("min", TODAY_STR);
          setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);
          clearAllInvalid(); // (added)
        } else {
          const { error } = await supabase
            .schema("jobs")
            .from("job")
            .update({ ...payload, updated_at: new Date().toISOString() })
            .eq("job_id", jobId)
            .eq("posted_by", user.id);
          if (error) {
            showNotice(prettyError(error), "error");
            return;
          }
          await showNotice("Your changes have been saved.", "success");
          window.location.href = "myJobPosts.html";
        }
      });

      // ====== Optional: View posts (unchanged demo) ======
      const navCreate = document.getElementById("nav-create");
      const navView = document.getElementById("nav-view");
      const sectionCreate = document.getElementById("create-post");
      const sectionView = document.getElementById("view-posts");
      if (navCreate && navView && sectionCreate && sectionView) {
        function ensureMapSize() {
          setTimeout(() => map.invalidateSize(), 0);
        }
        navCreate.addEventListener("click", (e) => {
          e.preventDefault();
          navCreate.classList.add("active");
          navView.classList.remove("active");
          sectionCreate.classList.remove("hidden");
          sectionView.classList.add("hidden");
          ensureMapSize();
        });
        navView.addEventListener("click", async (e) => {
          e.preventDefault();
          navView.classList.add("active");
          navCreate.classList.remove("active");
          sectionView.classList.remove("hidden");
          sectionCreate.classList.add("hidden");
          const {
            data: { user },
          } = await supabase.auth.getUser();
          if (!user) return;
          const { data } = await supabase
            .schema("jobs")
            .from("job")
            .select("job_title, job_date, job_pay, job_difficulty")
            .eq("posted_by", user.id);
          postsTable.innerHTML = "";
          (data || []).forEach((job) => {
            postsTable.innerHTML += `<tr>
              <td>${job.job_title}</td>
              <td>${job.job_date}</td>
              <td>₱${Number(job.job_pay).toLocaleString("en-PH", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}</td>
              <td>${job.job_difficulty}</td>
            </tr>`;
          });
        });
      }
    </script>
  </body>
</html>
