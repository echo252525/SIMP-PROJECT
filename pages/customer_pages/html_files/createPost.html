<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <title>Create Post</title>
    <style>
      main {
        margin-top: 1.4rem;
      }
      section.card {
        background: var(--card);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        animation: fadeIn 0.6s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .hidden {
        display: none;
      }

      /* Minimal Form */
      .form-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      @media (max-width: 900px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .field.inline {
        flex-direction: row;
        align-items: center;
        gap: 12px;
      }
      .field label {
        font-size: 0.92rem;
        color: #111827;
        font-weight: 600;
      }
      .hint {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .ctrl {
        position: relative;
        display: flex;
        align-items: center;
        background: #f9fafb;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      }
      .ctrl:focus-within {
        border-color: var(--brand);
        box-shadow: 0 0 0 4px var(--ring);
        background: #fff;
      }
      .ctrl input,
      .ctrl textarea,
      .ctrl select {
        border: none;
        outline: none;
        background: transparent;
        width: 100%;
        font-size: 1rem;
      }
      .ctrl textarea {
        min-height: 110px;
        resize: vertical;
      }

      .affix {
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.95rem;
        color: #6b7280;
      }
      .affix.left {
        margin-right: 10px;
      }
      .affix.right {
        margin-left: 10px;
      }

      .row-2 {
        grid-column: span 2;
      }
      @media (max-width: 900px) {
        .row-2 {
          grid-column: auto;
        }
      }

      /* Slider */
      .slider-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      input[type="range"] {
        width: 100%;
      }
      .badge {
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: #4338ca;
        font-weight: 600;
        font-size: 0.85rem;
      }

      /* File dropzone */
      .dropzone {
        border: 1.5px dashed #cbd5e1;
        border-radius: 12px;
        padding: 14px;
        text-align: center;
        background: #f9fafb;
        transition: border 0.15s, background 0.15s;
      }
      .dropzone:hover {
        border-color: var(--brand);
        background: #fff;
      }
      .dropzone input {
        display: none;
      }
      .dz-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .dz-thumb {
        margin-top: 12px;
        display: none;
      }
      .dz-thumb img {
        max-width: 100%;
        border-radius: 10px;
        border: 1px solid var(--line);
      }

      /* Buttons */
      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .btn {
        appearance: none;
        border: none;
        border-radius: 12px;
        padding: 12px 16px;
        font-weight: 700;
        cursor: pointer;
        background: var(--brand);
        color: #fff;
        transition: transform 0.04s ease, background 0.15s ease;
      }
      .btn:hover {
        background: var(--brand-ink);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.ghost {
        background: #eef2ff;
        color: #3730a3;
      }
      .btn.ghost:hover {
        background: #e0e7ff;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eef2f7;
        text-align: left;
        font-size: 0.95rem;
      }
      th {
        color: #0f172a;
        background: #f8fafc;
        font-weight: 700;
      }

      /* Map */
      #job-map {
        height: 320px;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 6px;
        border: 1px solid var(--line);
      }
      .loc-hint {
        color: #6b7280;
        font-size: 0.88rem;
        margin: 0.2rem 0 0.6rem;
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .loc-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .loc-row .btn {
        white-space: nowrap;
      }

      /* Tiny separators */
      .hr {
        height: 1px;
        background: var(--line);
        margin: 12px 0;
        border-radius: 1px;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="#" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>

        <div class="sidebar">
          <a href="dashboard.html">
            <span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3>
          </a>
          <a href="createPost.html" class="active" id="nav-create">
            <span class="material-icons-sharp">add</span>
            <h3>Create a post</h3>
          </a>
        
          <a href="#" id="logout-btn">
            <span class="material-icons-sharp">logout</span>
            <h3>Logout</h3>
          </a>
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!--MAIN CONTENT-->
      <main>
        <!-- Create Post -->
        <section class="card" id="create-post">
          <h1>Create a Job Post</h1>
          <p class="sub">
            Keep it short, clear, and accurateâ€”workers decide fast.
          </p>

          <form id="jobForm" novalidate>
            <div class="form-grid">
              <!-- Title -->
              <div class="field row-2">
                <label for="job_title">Job Title</label>
                <div class="ctrl">
                  <input
                    type="text"
                    id="job_title"
                    placeholder="e.g., Aircon cleaning for studio unit"
                    required
                  />
                </div>
              </div>

              <!-- Category -->
              <div class="field">
                <label for="job_category">Category</label>
                <div class="ctrl">
                  <select id="job_category">
                    <option value="">Select a category</option>
                    <option>Cleaning</option>
                    <option>Electrical</option>
                    <option>Plumbing</option>
                    <option>Delivery</option>
                    <option>IT Support</option>
                    <option>General Help</option>
                  </select>
                </div>
                <div class="hint">Choose the closest fit.</div>
              </div>

              <!-- Difficulty -->
              <div class="field">
                <label for="job_difficulty_range">Difficulty</label>
                <div class="ctrl">
                  <div class="slider-wrap">
                    <input
                      type="range"
                      id="job_difficulty_range"
                      min="1"
                      max="10"
                      step="1"
                      value="3"
                    />
                    <span class="badge" id="diffBadge">3/10</span>
                  </div>
                </div>
                <input type="hidden" id="job_difficulty" value="3" />
                <div class="hint">1 = very easy, 10 = expertâ€‘level.</div>
              </div>

              <!-- Pay -->
              <div class="field">
                <label for="job_pay">Pay</label>
                <div class="ctrl">
                  <span class="affix left">â‚±</span>
                  <input
                    type="number"
                    id="job_pay"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="e.g., 1500.00"
                    required
                  />
                </div>
                <div class="hint">Set a fair, competitive rate.</div>
              </div>

              <!-- Date -->
              <div class="field">
                <label for="job_date">Date</label>
                <div class="ctrl">
                  <input type="date" id="job_date" required />
                </div>
              </div>

              <!-- Time -->
              <div class="field">
                <label for="job_time">Start Time</label>
                <div class="ctrl">
                  <span
                    class="affix left material-icons-sharp"
                    aria-hidden="true"
                    >schedule</span
                  >
                  <input type="time" id="job_time" required />
                </div>
              </div>

              <!-- Duration -->
              <div class="field">
                <label for="job_duration">Estimated Duration</label>
                <div class="ctrl">
                  <input
                    type="number"
                    id="job_duration"
                    min="1"
                    step="1"
                    placeholder="e.g., 3"
                    required
                  />
                  <span class="affix right">hours</span>
                </div>
              </div>

              <!-- Picture / Dropzone -->
              <div class="field">
                <label>Photo (optional)</label>
                <div class="dropzone" id="dz">
                  <div>
                    Drag & drop a photo here, or
                    <label
                      for="job_picture"
                      style="
                        color: var(--brand);
                        cursor: pointer;
                        font-weight: 700;
                      "
                      >browse</label
                    >
                  </div>
                  <input type="file" id="job_picture" accept="image/*" />
                  <div class="dz-actions hint">
                    Clear, wellâ€‘lit photos help workers decide faster.
                  </div>
                  <div class="dz-thumb" id="dzThumb">
                    <img id="dzImg" alt="Preview" />
                  </div>
                </div>
              </div>

              <!-- Description -->
              <div class="field row-2">
                <label for="job_description">Details / Instructions</label>
                <div class="ctrl">
                  <textarea
                    id="job_description"
                    placeholder="Key tasks, tools available, building rules, parking, contact personâ€¦"
                  ></textarea>
                </div>
              </div>

              <!-- Location -->
              <div class="field row-2">
                <label for="job_location">Location</label>
                <div class="ctrl">
                  <input
                    type="text"
                    id="job_location"
                    placeholder="Type an address or use the map"
                    required
                  />
                </div>
                <div class="loc-row">
                  <button type="button" class="btn ghost" id="btnLocate">
                    <span
                      class="material-icons-sharp"
                      style="vertical-align: middle"
                      >my_location</span
                    >
                    Locate me
                  </button>
                  <span class="hint"
                    >Click on the map or drag the pin to set the exact
                    spot.</span
                  >
                </div>
                <div id="job-map"></div>
                <input type="hidden" id="job_lat" />
                <input type="hidden" id="job_lng" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="actions">
              <button type="reset" class="btn ghost" id="btnReset">
                Reset
              </button>
              <button type="submit" class="btn">Post Job</button>
            </div>
          </form>
        </section>

        <!-- View My Posts -->
        <section class="card hidden" id="view-posts">
          <h1>My Job Posts</h1>
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Date</th>
                <th>Pay</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody id="postsTable"></tbody>
          </table>
        </section>
      </main>
    </div>
    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  /* =========================
     CONFIG
     ========================= */
  const SUPABASE_URL = "https://gxydxmobwrccqagltlci.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4eWR4bW9id3JjY3FhZ2x0bGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDMzOTMsImV4cCI6MjA3MDcxOTM5M30.Zk2xUlmlPGbe-7rDsqC486Js9LGFMMOp-fytNZSwzBs";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Geocoding strategy:
  // - If you have a backend proxy that calls Nominatim with a proper User-Agent & adds CORS, enable it:
  const USE_PROXY = false;                       // <-- set to true when your proxy is ready
  const PROXY_BASE = "http://localhost:3000";   // <-- change to your proxy origin when available

  /* =========================
     DOM HOOKS
     ========================= */
  const form = document.getElementById("jobForm");
  const postsTable = document.getElementById("postsTable");

  const diffRange  = document.getElementById("job_difficulty_range");
  const diffHidden = document.getElementById("job_difficulty");
  const diffBadge  = document.getElementById("diffBadge");

  const dz        = document.getElementById("dz");
  const fileInput = document.getElementById("job_picture");
  const dzThumb   = document.getElementById("dzThumb");
  const dzImg     = document.getElementById("dzImg");
  const btnReset  = document.getElementById("btnReset");

  const inputLocation = document.getElementById("job_location");
  const inputLat = document.getElementById("job_lat");
  const inputLng = document.getElementById("job_lng");
  const btnLocate = document.getElementById("btnLocate");

  // Optional nav (guarded so missing elements won't crash)
  const navCreate = document.getElementById("nav-create");
  const navView   = document.getElementById("nav-view");
  const sectionCreate = document.getElementById("create-post");
  const sectionView   = document.getElementById("view-posts");

  /* =========================
     UX: Difficulty slider & Dropzone
     ========================= */
  diffRange.addEventListener("input", () => {
    diffBadge.textContent = `${diffRange.value}/10`;
    diffHidden.value = diffRange.value;
  });

  dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.style.borderColor="#6366f1"; });
  dz.addEventListener("dragleave", ()=>{ dz.style.borderColor="#cbd5e1"; });
  dz.addEventListener("drop", (e)=>{
    e.preventDefault(); dz.style.borderColor="#cbd5e1";
    if(e.dataTransfer.files?.length){ fileInput.files = e.dataTransfer.files; previewImage(fileInput.files[0]); }
  });
  fileInput.addEventListener("change", () => { if(fileInput.files?.length) previewImage(fileInput.files[0]); });
  function previewImage(file){
    const reader = new FileReader();
    reader.onload = () => { dzImg.src = reader.result; dzThumb.style.display="block"; };
    reader.readAsDataURL(file);
  }

  /* =========================
     MAP
     ========================= */
  const DEFAULT_CENTER = [14.5995, 120.9842]; // Manila
  const DEFAULT_ZOOM = 12;

  const map = L.map("job-map").setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
  }).addTo(map);

  let marker = L.marker(DEFAULT_CENTER, { draggable: true }).addTo(map);

  // -- Reverse geocode: coords -> address (via proxy if available)
  // -- Reverse geocode: coords -> human-readable address
async function reverseGeocode(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    const res = await fetch(url, {
      headers: {
        "Accept-Language": "en-PH",
        "User-Agent": "SIMPProject/1.0 (your-email@example.com)" // required by Nominatim
      }
    });
    if (!res.ok) throw new Error("Reverse geocoding failed");
    const data = await res.json();
    return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  } catch (e) {
    console.warn("reverseGeocode error:", e);
    return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }
}


  // -- Forward geocode: address -> coords (via proxy if available)
  async function forwardGeocode(query) {
    if (!query || query === "Resolving addressâ€¦") return null;
    try {
      if (USE_PROXY) {
        const res = await fetch(`${PROXY_BASE}/api/fwdgeo?q=${encodeURIComponent(query)}`);
        if (!res.ok) throw new Error("Proxy forward geocoding failed");
        const results = await res.json();
        if (!results.length) throw new Error("Address not found");
        const { lat, lon } = results[0];
        return [parseFloat(lat), parseFloat(lon)];
      } else {
        // Without proxy, skip calling remote API from browser.
        // Let the user keep the typed address; we won't move the pin automatically.
        return null;
      }
    } catch (e) {
      console.warn("forwardGeocode error:", e);
      return null;
    }
  }

  // -- Set from coords: write address -> hidden lat/lng -> move pin -> center
  async function setFromCoords(lat, lng, zoom = 16) {
  inputLocation.value = "Resolving addressâ€¦";
  const addr = await reverseGeocode(lat, lng);
  inputLocation.value = addr; // ðŸ‘ˆ this now shows full address
  inputLat.value = lat;
  inputLng.value = lng;
  marker.setLatLng([lat, lng]);
  map.setView([lat, lng], zoom);
}


  // Initial address
  setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);

  // Map click -> update address and pin
  map.on("click", (e) => setFromCoords(e.latlng.lat, e.latlng.lng, 17));

  // Drag pin -> update address and inputs
  marker.on("dragend", async () => {
    const { lat, lng } = marker.getLatLng();
    await setFromCoords(lat, lng, map.getZoom());
  });

  // Locate me: high-accuracy + brief refine, always updates input first
  btnLocate.addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Geolocation not supported by your browser."); return; }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        await setFromCoords(lat, lng, accuracy && accuracy < 60 ? 17 : 16);

        // Short refine for a tighter fix
        const watchId = navigator.geolocation.watchPosition(
          async (p) => {
            const { latitude, longitude, accuracy: acc } = p.coords;
            if (acc <= 30) {
              await setFromCoords(latitude, longitude, 17);
              navigator.geolocation.clearWatch(watchId);
            }
          },
          () => {},
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
        setTimeout(() => navigator.geolocation.clearWatch(watchId), 20000);
      },
      (err) => { alert(`Unable to get your location. (${err?.message || "Unknown error"})`); },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
    );
  });

  // Optional: typing an address moves the pin (only when proxy is enabled)
  inputLocation.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (!USE_PROXY) return; // avoid CORS without proxy
      const q = inputLocation.value.trim();
      const coords = await forwardGeocode(q);
      if (coords) await setFromCoords(coords[0], coords[1], 17);
    }
  });
  inputLocation.addEventListener("blur", async () => {
    if (!USE_PROXY) return;
    const q = inputLocation.value.trim();
    if (!q || q === "Resolving addressâ€¦") return;
    const coords = await forwardGeocode(q);
    if (coords) await setFromCoords(coords[0], coords[1], 17);
  });

  /* =========================
     Optional: Nav toggles (guarded)
     ========================= */
  if (navCreate && navView && sectionCreate && sectionView) {
    function ensureMapSize(){ setTimeout(()=> map.invalidateSize(), 0); }

    navCreate.addEventListener("click", (e) => {
      e.preventDefault();
      navCreate.classList.add("active");
      navView.classList.remove("active");
      sectionCreate.classList.remove("hidden");
      sectionView.classList.add("hidden");
      ensureMapSize();
    });

    navView.addEventListener("click", async (e) => {
      e.preventDefault();
      navView.classList.add("active");
      navCreate.classList.remove("active");
      sectionView.classList.remove("hidden");
      sectionCreate.classList.add("hidden");

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data } = await supabase
        .from("job")
        .select("job_title, job_date, job_pay, job_difficulty")
        .eq("posted_by", user.id);

      postsTable.innerHTML = "";
      (data || []).forEach((job) => {
        postsTable.innerHTML += `
          <tr>
            <td>${job.job_title}</td>
            <td>${job.job_date}</td>
            <td>â‚±${Number(job.job_pay).toLocaleString("en-PH", {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
            <td>${job.job_difficulty}</td>
          </tr>`;
      });
    });
  }

  /* =========================
     FORM SUBMIT
     ========================= */
  btnReset.addEventListener("click", ()=>{
    dzThumb.style.display="none"; dzImg.src="";
    diffRange.value = "3"; diffBadge.textContent="3/10"; diffHidden.value="3";
    setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert("You must be logged in to post a job."); return; }

    // Upload job picture (if provided)
    let pictureUrl = null;
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileExt = file.name.split(".").pop();
      const filePath = `${user.id}/${Date.now()}.${fileExt}`;

      const { error: uploadError } = await supabase.storage.from("jobs").upload(filePath, file);
      if (uploadError) { alert("Error uploading picture: " + uploadError.message); return; }
      const { data: publicUrlData } = supabase.storage.from("jobs").getPublicUrl(filePath);
      pictureUrl = publicUrlData.publicUrl;
    }

    function generateJobCode() {
      const letters = Array.from({ length: 4 }, () => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join("");
      const numbers = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
      return `${letters}-${numbers}`;
    }
    const job_code = generateJobCode();

    const jobData = {
      job_code,
      job_title: document.getElementById("job_title").value.trim(),
      job_description: document.getElementById("job_description").value.trim(),
      job_difficulty: parseInt(document.getElementById("job_difficulty").value, 10),
      job_category: document.getElementById("job_category").value,
      job_location: document.getElementById("job_location").value.trim(),
      job_date: document.getElementById("job_date").value,
      job_time: document.getElementById("job_time").value,
      job_duration: parseInt(document.getElementById("job_duration").value, 10),
      job_pay: parseFloat(document.getElementById("job_pay").value),
      job_picture_url: pictureUrl,
      posted_by: user.id,
      // If/when you enable storing exact coords:
      // lat: parseFloat(inputLat.value) || null,
      // lng: parseFloat(inputLng.value) || null,
    };

    if (!jobData.job_location || jobData.job_location === "Resolving addressâ€¦") {
      alert("Please set the job location by clicking/dragging the pin on the map (or type a full address).");
      return;
    }

    const { error } = await supabase.from("job").insert([jobData]);
    if (error) {
      console.error(error);
      alert("Error posting job: " + error.message);
    } else {
      alert("Job posted successfully!");
      form.reset();
      dzThumb.style.display="none"; dzImg.src="";
      diffRange.value = "3"; diffBadge.textContent="3/10"; diffHidden.value="3";
      setFromCoords(DEFAULT_CENTER[0], DEFAULT_CENTER[1], DEFAULT_ZOOM);
    }
  });
</script>

  </body>
</html>
