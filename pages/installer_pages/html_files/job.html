<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <title>Jobs</title>

    <style>
      /* ===== MAIN CONTENT (new) ===== */
      main {
        margin-top: 1.4rem;
      }
      .page-header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .page-header h1 {
        color: #1c2430;
      }
      .page-header p {
        font-size: 0.9rem;
      }

      /* Search + Filters row */
      .searchBarDiv {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: 1.5fr repeat(3, auto); /* search + price + category + level */
        gap: 0.6rem;
        align-items: center;
      }
      .searchDiv {
        background: var(--color-white);
        border-radius: 999px;
        box-shadow: var(--box-shadow);
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.8rem 1.2rem;
      }
      .searchDiv input {
        flex: 1;
        background: transparent;
        font: inherit;
        color: var(--color-dark);
        border: none;
        outline: none;
      }
      .searchDiv .material-icons-sharp {
        font-size: 1.2rem;
        color: var(--color-info-dark);
      }

      /* Dropdowns */
      .dropdown {
        position: relative;
      }
      .dropbtn {
        padding: 0.7rem 1rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        font-weight: 600;
      }
      .dropdown-content {
        position: absolute;
        top: 110%;
        right: 0;
        min-width: 220px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: var(--box-shadow);
        display: none;
        z-index: 10;
        padding: 0.4rem;
      }
      .dropdown.open .dropdown-content {
        display: block;
      }
      .dropdown-content a {
        display: block;
        padding: 0.6rem 0.8rem;
        border-radius: 10px;
        color: #1f2937;
        text-decoration: none;
        font-size: 0.92rem;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }

      /* Price range mini-form inside dropdown */
      .price-controls {
        padding: 0.6rem 0.8rem;
        display: grid;
        gap: 0.5rem;
      }
      .price-controls .row {
        display: flex;
        gap: 0.5rem;
      }
      .price-controls input {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.5rem 0.6rem;
      }
      .price-controls button {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        font-weight: 600;
        background: #3bbf67;
        color: #fff;
      }

      .cards {
        margin-top: 1.4rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.4rem;
      }
      @media (max-width: 900px) {
        .cards {
          grid-template-columns: 1fr;
        }
      }

      .job-card {
        background: var(--color-white);
        border-radius: 20px;
        box-shadow: var(--box-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .thumb img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .job-card .content {
        padding: 1rem 1.2rem;
      }
      .job-card .title {
        font-weight: 700;
      }
      .meta-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin: 0.6rem 0 0.2rem;
      }
      .pill {
        font-size: 0.72rem;
        line-height: 1;
        padding: 0.42rem 0.8rem;
        border-radius: 999px;
        background: #eef2f7;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }
      .info-grid {
        display: grid;
        gap: 0.6rem;
        margin: 0.6rem 0 0.8rem;
      }
      .info-grid .label {
        font-weight: 700;
      }
      .desc {
        font-size: 0.86rem;
        margin: 0.4rem 0 1rem;
      }
      .apply {
        margin: 0 1.2rem 1.2rem;
        border-radius: 999px;
        background: #3bbf67;
        color: #fff;
        font-weight: 600;
        padding: 0.8rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .apply:hover {
        filter: brightness(0.95);
      }
      .scroll-tip {
        text-align: center;
        color: var(--color-info-dark);
        margin: 1rem 0 2rem;
        font-size: 0.85rem;
      }

      /*JOB TITLE & CATEGORY SA ILALIM NG PIC*/
      .contentFirstRow {
        display: flex;
        grid-template-columns: 1fr 1fr;
        align-items: center;
        justify-content: space-between;
      }

      /* Tiny helper to show the current filter on the button */
      .dropbtn .current {
        color: #6b7280;
        font-weight: 500;
        margin-left: 0.3rem;
      }

      /* ===== Modal (Job Application) ===== */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(17, 24, 39, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal-backdrop.show {
        display: flex;
      }

      .job-modal {
        width: min(980px, 92vw);
        max-height: 86vh;
        border-radius: 22px;
        background: #fff;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: grid;
        grid-template-columns: 1.1fr 1fr;
      }
      @media (max-width: 900px) {
        .job-modal {
          grid-template-columns: 1fr;
          width: min(720px, 92vw);
        }
      }

      .job-modal .left {
        position: relative;
        background: #0b1220;
        color: #fff;
        display: grid;
        align-content: start;
      }
      .job-modal .left img {
        width: 100%;
        height: 320px;
        object-fit: cover;
        display: block;
      }
      .job-modal .left .left-meta {
        padding: 16px 18px 18px;
        display: grid;
        gap: 8px;
      }
      .job-modal .left .pills {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .job-modal .left .pill {
        background: #0f172a;
        color: #cbd5e1;
        border: 1px solid #1f2937;
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        font-size: 0.75rem;
      }

      .job-modal .right {
        padding: 18px 18px 22px;
        overflow: auto;
      }
      .job-modal h3 {
        margin: 0 0 6px;
      }
      .job-modal .tiny {
        color: #6b7280;
        font-size: 0.84rem;
      }
      .job-modal .desc {
        margin: 12px 0 10px;
        line-height: 1.5;
        font-size: 0.92rem;
        color: #1f2937;
      }

      .job-modal .resume {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        font-size: 0.9rem;
      }
      .job-modal .resume a {
        color: #15803d;
        text-decoration: none;
      }

      .job-modal .cta-row {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      .job-modal .btn {
        border: none;
        border-radius: 999px;
        padding: 0.8rem 1rem;
        font-weight: 700;
        cursor: pointer;
      }
      .job-modal .btn-apply {
        background: #22c55e;
        color: #fff;
      }
      .job-modal .btn-apply:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .job-modal .btn-cancel {
        background: #e5e7eb;
        color: #111827;
      }

      .job-modal .banner {
        background: #ecfdf5;
        color: #065f46;
        border-bottom: 1px solid #d1fae5;
        padding: 8px 12px;
        font-size: 0.86rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        z-index: 60;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        font-size: 0.9rem;
        display: none;
      }
      .toast.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="#" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>
        <div class="sidebar">
          <a href="dashboard.html"
            ><span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3></a
          >
          <a href="job.html" class="active"
            ><span class="material-icons-sharp">work</span>
            <h3>Jobs</h3></a
          >
          <a href="myApplication.html"
            ><span class="material-icons-sharp">receipt</span>
            <h3>My Application</h3></a
          >
          <a href="courses.html"
            ><span class="material-icons-sharp">school</span>
            <h3>Courses</h3></a
          >
          <a href="shop.html"
            ><span class="material-icons-sharp">shopping_cart</span>
            <h3>Shop</h3></a
          >
          <a href="#"
            ><span class="material-icons-sharp">account_balance</span>
            <h3>Earnings</h3></a
          >
          <a href="#"
            ><span class="material-icons-sharp">file_copy</span>
            <h3>Documents</h3></a
          >
          <a href="#"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3></a
          >
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3></a
          >
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- Main content column (center) -->
      <main>
        <div class="page-header">
          <h1>Current Job Openings</h1>
          <p>Explore career opportunities near you.</p>
        </div>

        <!-- SEARCH + FILTERS -->
        <div class="searchBarDiv">
          <!-- Search -->
          <div class="searchDiv">
            <span class="material-icons-sharp">search</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search jobs (title, description, location)"
            />
          </div>

          <!-- Price -->
          <div class="dropdown" data-filter="price">
            <button class="dropbtn">
              Price<span class="current" id="priceLabel"></span>
            </button>
            <div class="dropdown-content">
              <div class="price-controls">
                <div class="row">
                  <input
                    id="minPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Min ₱"
                  />
                  <input
                    id="maxPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Max ₱"
                  />
                </div>
                <button id="applyPrice">Apply range</button>
              </div>
            </div>
          </div>

          <!-- Category (FIXED LIST) -->
          <div class="dropdown" data-filter="category">
            <button class="dropbtn">
              Category<span class="current" id="categoryLabel"></span>
            </button>
            <div class="dropdown-content" id="categoryMenu"></div>
          </div>

          <!-- Level (1–10 FIXED) -->
          <div class="dropdown" data-filter="level">
            <button class="dropbtn">
              Level<span class="current" id="levelLabel"></span>
            </button>
            <div class="dropdown-content" id="levelMenu"></div>
          </div>
        </div>

        <!-- CARDS -->
        <section class="cards"></section>
        <div class="scroll-tip">Scroll down for more</div>
      </main>

      <!-- Right column left empty to match your 3-col grid -->
      <div></div>
    </div>
    <!-- CLOSE .container AT THE END -->

    <!-- Job Application Modal -->
    <div id="applyModal" class="modal-backdrop" aria-hidden="true">
      <div
        class="job-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="jobModalTitle"
      >
        <!-- LEFT: image & quick meta -->
        <div class="left">
          <img id="mImg" src="" alt="Job photo" />
          <div class="left-meta">
            <div class="pills">
              <span class="pill" id="mCategory">Category</span>
              <span class="pill" id="mDifficulty">Difficulty</span>
            </div>
            <div class="tiny">
              <strong>Pay:</strong> <span id="mPay">₱–</span>
            </div>
            <div class="tiny">
              <strong>Date/Time:</strong> <span id="mDT">–</span>
            </div>
            <div class="tiny">
              <strong>Location:</strong> <span id="mLoc">–</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: description & actions -->
        <div class="right">
          <div class="banner" id="fitBanner" style="display: none">
            <span class="material-icons-sharp" style="font-size: 18px"
              >verified</span
            >
            <span>You are a strong candidate for this job</span>
          </div>

          <h3 id="jobModalTitle">Job Title</h3>
          <div class="tiny" id="mPostedBy"></div>
          <div class="desc" id="mDesc"></div>

          <!-- Optional resume badge (you can hook your uploader later) -->
          <div class="resume">
            <span
              class="material-icons-sharp"
              style="font-size: 18px; color: #059669"
              >attach_file</span
            >
            <a href="javascript:void(0)" title="Coming soon">resume.pdf</a>
            <span class="tiny" style="margin-left: auto; color: #6b7280"
              >(optional)</span
            >
          </div>

          <div class="cta-row">
            <button id="modalApplyBtn" class="btn btn-apply">
              Apply for this Job!
            </button>
            <button id="modalCancelBtn" class="btn btn-cancel">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <!-- Supabase UMD build -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script>
      const { createClient } = supabase;

      // ✅ Your Supabase project details
      const SUPABASE_URL = "https://gxydxmobwrccqagltlci.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4eWR4bW9id3JjY3FhZ2x0bGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDMzOTMsImV4cCI6MjA3MDcxOTM5M30.Zk2xUlmlPGbe-7rDsqC486Js9LGFMMOp-fytNZSwzBs";
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ---------- helpers ----------
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const esc = (str) =>
        String(str ?? "").replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      const fmtPeso = (n) => {
        const v = typeof n === "string" ? parseFloat(n) : n;
        return isNaN(v)
          ? "-"
          : v.toLocaleString("en-PH", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
      };
      const fmtDate = (d) =>
        d ? new Date(d + "T00:00:00").toLocaleDateString() : "-";
      const fmtTime = (t) => (t ? String(t).slice(0, 5) : "");

      // Build PUBLIC URL from jobs bucket
      function publicJobImageUrl(rawPath, postedBy) {
        if (!rawPath) return "";
        if (/^https?:\/\//i.test(rawPath)) return rawPath;
        let clean = String(rawPath)
          .replace(/^\/+/, "")
          .replace(/^jobs\//, "");
        if (clean && !clean.includes("/") && postedBy)
          clean = `${postedBy}/${clean}`;
        const { data } = sb.storage.from("jobs").getPublicUrl(clean);
        return data?.publicUrl || "";
      }

      // ---------- FIXED FILTER OPTIONS ----------
      const FIXED_CATEGORIES = [
        "", // All
        "Electrical",
        "Safety",
        "Networking",
        "CCTV",
        "Plumbing",
        "General Services",
      ];
      const FIXED_LEVELS = [
        "",
        ...Array.from({ length: 10 }, (_, i) => String(i + 1)),
      ];

      // ---------- state ----------
      let ALL_JOBS = [];
      const FILTERS = {
        q: "", // text search
        minPrice: null, // number | null
        maxPrice: null, // number | null
        category: "", // exact match
        level: "", // exact match (1..10)
      };

      // ---------- rendering ----------
      function renderJobs(list) {
        const container = $(".cards");
        container.innerHTML = "";
        if (!list || list.length === 0) {
          container.innerHTML =
            '<div class="scroll-tip">No jobs match your filters.</div>';
          return;
        }
        for (const job of list) {
          const imgUrl = publicJobImageUrl(job.job_picture_url, job.posted_by);
          const card = document.createElement("article");
          card.className = "job-card";
          card.innerHTML = `
          <div class="thumb">
            <img src="${imgUrl || "../images/profile-4.jpg"}" alt="Job image"
              onerror="this.onerror=null;console.warn('Image not found:', this.src); this.src='../images/profile-4.jpg';" />
          </div>
          <div class="content">
            <div class="contentFirstRow">
              <div class="title">${esc(job.job_title)}</div>
              <div class="meta-row">
                <span class="pill">${esc(
                  job.job_category || "Uncategorized"
                )}</span>
                <span class="pill">Difficulty: ${esc(
                  job.job_difficulty ?? ""
                )}</span>
              </div>
            </div>
            <div class="info-grid">
              <div><div class="label">Pay: ₱${fmtPeso(job.job_pay)}</div></div>
              <div><div class="label">Date/Time: ${fmtDate(
                job.job_date
              )} ${fmtTime(job.job_time)}</div></div>
              <div><div class="label">Location: ${esc(
                job.job_location || "Not specified"
              )}</div></div>
            </div>
            <div class="desc">${esc(
              job.job_description || "No description provided"
            )}</div>
          </div>
          <button class="apply" data-job-id="${
            job.job_id
          }">Apply for this Job!</button>
        `;
          container.appendChild(card);
        }
      }

      function populateMenus() {
        const fillMenu = (el, values) => {
          el.innerHTML = values
            .map(
              (v) =>
                `<a href="#" data-value="${esc(v)}">${v ? esc(v) : "All"}</a>`
            )
            .join("");
        };

        fillMenu($("#categoryMenu"), FIXED_CATEGORIES);
        fillMenu($("#levelMenu"), FIXED_LEVELS);

        updateButtonLabels();
      }

      function updateButtonLabels() {
        $("#priceLabel").textContent =
          FILTERS.minPrice || FILTERS.maxPrice
            ? `(${FILTERS.minPrice ?? 0}–${FILTERS.maxPrice ?? "∞"})`
            : "";
        $("#categoryLabel").textContent = FILTERS.category
          ? `(${FILTERS.category})`
          : "";
        $("#levelLabel").textContent = FILTERS.level
          ? `(${FILTERS.level})`
          : "";
      }

      // Apply filters to ALL_JOBS
      function applyFilters() {
        let list = [...ALL_JOBS];

        // text search across title/desc/location
        const q = (FILTERS.q || "").trim().toLowerCase();
        if (q) {
          list = list.filter((j) => {
            const hay = [j.job_title, j.job_description, j.job_location]
              .map((x) => String(x ?? "").toLowerCase())
              .join(" | ");
            return hay.includes(q);
          });
        }

        // category
        if (FILTERS.category)
          list = list.filter(
            (j) => String(j.job_category || "") === FILTERS.category
          );

        // level (difficulty)
        if (FILTERS.level)
          list = list.filter(
            (j) => String(j.job_difficulty || "") === FILTERS.level
          );

        // price range
        const toNum = (v) =>
          v === null || v === "" || Number.isNaN(v) ? null : Number(v);
        const minP = toNum(FILTERS.minPrice);
        const maxP = toNum(FILTERS.maxPrice);

        if (minP !== null)
          list = list.filter((j) => Number(j.job_pay ?? 0) >= minP);
        if (maxP !== null)
          list = list.filter((j) => Number(j.job_pay ?? 0) <= maxP);

        renderJobs(list);
        updateButtonLabels();
      }

      // ---------- main ----------
      async function loadJobs() {
        const container = $(".cards");
        if (!container) {
          console.error(
            'Missing .cards element. Ensure <section class="cards"> exists.'
          );
          return;
        }
        container.innerHTML = '<div class="scroll-tip">Loading jobs…</div>';

        const { data: jobs, error } = await sb
          .from("job")
          .select(
            "job_id, posted_by, job_title, job_description, job_difficulty, job_category, job_location, job_date, job_time, job_pay, job_picture_url, created_at"
          )
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error fetching jobs:", error);
          container.innerHTML = `<div class="scroll-tip">Could not load jobs: ${esc(
            error.message || "Check URL/key & RLS"
          )}</div>`;
          return;
        }

        ALL_JOBS = jobs || [];
        populateMenus(); // fixed menus
        applyFilters(); // initial render
      }

      // ---------- UI wiring ----------
      // Open/close dropdowns (click outside closes)
      document.addEventListener("click", (e) => {
        const dd = e.target.closest(".dropdown");
        // Close all
        $$(".dropdown").forEach((d) => d.classList.remove("open"));
        // Toggle the one clicked (if any)
        if (dd) dd.classList.add("open");
      });

      // Category / Level option clicks
      ["categoryMenu", "levelMenu"].forEach((menuId) => {
        const menu = document.getElementById(menuId);
        menu.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-value]");
          if (!a) return;
          e.preventDefault();
          const value = a.getAttribute("data-value");
          if (menuId === "categoryMenu") FILTERS.category = value;
          if (menuId === "levelMenu") FILTERS.level = value;
          applyFilters();
          // close the dropdown
          menu.closest(".dropdown").classList.remove("open");
        });
      });

      // Price apply
      $("#applyPrice").addEventListener("click", () => {
        const min = $("#minPrice").value ? Number($("#minPrice").value) : null;
        const max = $("#maxPrice").value ? Number($("#maxPrice").value) : null;
        FILTERS.minPrice = Number.isFinite(min) ? min : null;
        FILTERS.maxPrice = Number.isFinite(max) ? max : null;
        applyFilters();
        $("#minPrice").blur();
        $("#maxPrice").blur();
        $("#applyPrice").closest(".dropdown").classList.remove("open");
      });

      // Search (debounced)
      let tId;
      $("#searchInput").addEventListener("input", (e) => {
        clearTimeout(tId);
        tId = setTimeout(() => {
          FILTERS.q = e.target.value || "";
          applyFilters();
        }, 200);
      });

      // Load
      document.addEventListener("DOMContentLoaded", loadJobs);
    </script>
    <script>
      // ===== Modal + Application Logic =====
      const modal = document.getElementById("applyModal");
      const modalBtnApply = document.getElementById("modalApplyBtn");
      const modalBtnCancel = document.getElementById("modalCancelBtn");
      const toastEl = document.getElementById("toast");

      let CURRENT_JOB_ID = null;

      function showToast(msg, ms = 2200) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), ms);
      }

      function openApplyModal(job) {
        CURRENT_JOB_ID = job.job_id;

        // Fill left
        const imgUrl = publicJobImageUrl(job.job_picture_url, job.posted_by);
        document.getElementById("mImg").src =
          imgUrl || "../images/profile-4.jpg";
        document.getElementById("mCategory").textContent =
          job.job_category || "Uncategorized";
        document.getElementById("mDifficulty").textContent = `Difficulty: ${
          job.job_difficulty ?? "-"
        }`;
        document.getElementById("mPay").textContent =
          "₱" + fmtPeso(job.job_pay);
        document.getElementById("mDT").textContent = `${fmtDate(
          job.job_date
        )} ${fmtTime(job.job_time)}`;
        document.getElementById("mLoc").textContent =
          job.job_location || "Not specified";

        // Right
        document.getElementById("jobModalTitle").textContent =
          job.job_title || "Job";
        document.getElementById("mPostedBy").textContent = job.posted_by
          ? `Posted by: ${job.posted_by}`
          : "";
        document.getElementById("mDesc").textContent =
          job.job_description || "No description provided";
        document.getElementById("fitBanner").style.display = "none"; // you can add your own logic

        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeApplyModal() {
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        CURRENT_JOB_ID = null;
      }

      // Close on backdrop click
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeApplyModal();
      });
      modalBtnCancel.addEventListener("click", closeApplyModal);

      // Delegate click from job cards to open modal
      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".apply[data-job-id]");
        if (!btn) return;
        const jobId = btn.getAttribute("data-job-id");
        const job = (ALL_JOBS || []).find(
          (j) => String(j.job_id) === String(jobId)
        );
        if (!job) {
          showToast("Could not load job details.");
          return;
        }
        openApplyModal(job);
      });

      // Resolve installer_id from the logged in user.
      // Strategy: get user email from auth, then fetch installer.id by email.
      // Fallback: prompt for installer id if we can’t resolve automatically.
      async function resolveInstallerId() {
        const {
          data: { user },
          error: uErr,
        } = await sb.auth.getUser();
        if (uErr) {
          console.warn("auth.getUser error", uErr);
        }

        const email = user?.email;
        if (!email) return null;

        const { data: inst, error } = await sb
          .from("installer")
          .select("id, email")
          .eq("email", email)
          .limit(1)
          .maybeSingle();

        if (error) {
          console.warn("installer lookup error", error);
          return null;
        }
        return inst?.id ?? null;
      }

      // Handle "Apply" click inside modal
      modalBtnApply.addEventListener("click", async () => {
        if (!CURRENT_JOB_ID) {
          return;
        }
        modalBtnApply.disabled = true;
        modalBtnApply.textContent = "Submitting…";

        try {
          const installerId = await resolveInstallerId();

          if (!installerId) {
            showToast("No linked installer profile found for this account.");
            modalBtnApply.disabled = false;
            modalBtnApply.textContent = "Apply for this Job!";
            return;
          }

          const payload = {
            job_id: CURRENT_JOB_ID,
            installer_id: installerId,
            status: "pending",
          };

          const { error } = await sb.from("job_application").insert(payload);

          if (error) {
            // Unique violation / already applied
            // Postgres code 23505 or Supabase message contains 'duplicate'
            const msg =
              error.code === "23505" || /duplicate/i.test(error.message)
                ? "You already applied to this job."
                : `Could not submit application: ${error.message}`;
            showToast(msg, 3000);
          } else {
            showToast("Application submitted! Status: pending", 2400);
            closeApplyModal();
          }
        } catch (err) {
          console.error(err);
          showToast("Unexpected error. Please try again.");
        } finally {
          modalBtnApply.disabled = false;
          modalBtnApply.textContent = "Apply for this Job!";
        }
      });
    </script>

    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
  </body>
</html>
