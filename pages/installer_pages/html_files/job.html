<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <title>Jobs</title>

    <style>
      /* ===== MAIN CONTENT (new) ===== */
      main {
        margin-top: 1.4rem;
      }
      .page-header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .page-header h1 {
        color: #1c2430;
      }
      .page-header p {
        font-size: 0.9rem;
      }

      /* Search + Filters row */
      .searchBarDiv {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: 1.5fr repeat(3, auto); /* search + price + category + level */
        gap: 0.6rem;
        align-items: center;
      }
      .searchDiv {
        background: var(--color-white);
        border-radius: 999px;
        box-shadow: var(--box-shadow);
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.8rem 1.2rem;
      }
      .searchDiv input {
        flex: 1;
        background: transparent;
        font: inherit;
        color: var(--color-dark);
        border: none;
        outline: none;
      }
      .searchDiv .material-icons-sharp {
        font-size: 1.2rem;
        color: var(--color-info-dark);
      }

      /* Dropdowns */
      .dropdown {
        position: relative;
      }
      .dropbtn {
        padding: 0.7rem 1rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        font-weight: 600;
      }
      .dropdown-content {
        position: absolute;
        top: 110%;
        right: 0;
        min-width: 220px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: var(--box-shadow);
        display: none;
        z-index: 10;
        padding: 0.4rem;
      }
      .dropdown.open .dropdown-content {
        display: block;
      }
      .dropdown-content a {
        display: block;
        padding: 0.6rem 0.8rem;
        border-radius: 10px;
        color: #1f2937;
        text-decoration: none;
        font-size: 0.92rem;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }

      /* Price range mini-form inside dropdown */
      .price-controls {
        padding: 0.6rem 0.8rem;
        display: grid;
        gap: 0.5rem;
      }
      .price-controls .row {
        display: flex;
        gap: 0.5rem;
      }
      .price-controls input {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.5rem 0.6rem;
      }
      .price-controls button {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        font-weight: 600;
        background: #3bbf67;
        color: #fff;
      }

      .cards {
        margin-top: 1.4rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.4rem;
      }
      @media (max-width: 900px) {
        .cards {
          grid-template-columns: 1fr;
        }
      }

      .job-card {
        background: var(--color-white);
        border-radius: 20px;
        box-shadow: var(--box-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .thumb img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .job-card .content {
        padding: 1rem 1.2rem;
      }
      .job-card .title {
        font-weight: 700;
      }
      .meta-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin: 0.6rem 0 0.2rem;
      }
      .pill {
        font-size: 0.72rem;
        line-height: 1;
        padding: 0.42rem 0.8rem;
        border-radius: 999px;
        background: #eef2f7;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }
      .info-grid {
        display: grid;
        gap: 0.6rem;
        margin: 0.6rem 0 0.8rem;
      }
      .info-grid .label {
        font-weight: 700;
      }
      .desc {
        font-size: 0.86rem;
        margin: 0.4rem 0 1rem;
      }
      .apply {
        margin: 0 1.2rem 1.2rem;
        border-radius: 999px;
        background: #3bbf67;
        color: #fff;
        font-weight: 600;
        padding: 0.8rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .apply:hover {
        filter: brightness(0.95);
      }
      .scroll-tip {
        text-align: center;
        color: var(--color-info-dark);
        margin: 1rem 0 2rem;
        font-size: 0.85rem;
      }

      /*JOB TITLE & CATEGORY SA ILALIM NG PIC*/
      .contentFirstRow {
        display: flex;
        grid-template-columns: 1fr 1fr;
        align-items: center;
        justify-content: space-between;
      }

      /* Tiny helper to show the current filter on the button */
      .dropbtn .current {
        color: #6b7280;
        font-weight: 500;
        margin-left: 0.3rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="#" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>
        <div class="sidebar">
          <a href="dashboard.html"
            ><span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3></a
          >
          <a href="job.html" class="active"
            ><span class="material-icons-sharp">work</span>
            <h3>Jobs</h3></a
          >
          <a href="myApplication.html"
            ><span class="material-icons-sharp">receipt</span>
            <h3>My Application</h3></a
          >
          <a href="courses.html"
            ><span class="material-icons-sharp">school</span>
            <h3>Courses</h3></a
          >
          <a href="shop.html"
            ><span class="material-icons-sharp">shopping_cart</span>
            <h3>Shop</h3></a
          >
          <a href="earnings.html"
            ><span class="material-icons-sharp">account_balance</span>
            <h3>Earnings</h3></a
          >
          <a href="documents.html"
            ><span class="material-icons-sharp">file_copy</span>
            <h3>Documents</h3></a
          >
          <a href="settings.html"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3></a
          >
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3></a
          >
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- Main content column (center) -->
      <main>
        <div class="page-header">
          <h1>Current Job Openings</h1>
          <p>Explore career opportunities near you.</p>
        </div>

        <!-- SEARCH + FILTERS -->
        <div class="searchBarDiv">
          <!-- Search -->
          <div class="searchDiv">
            <span class="material-icons-sharp">search</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search jobs (title, description, location)"
            />
          </div>

          <!-- Price -->
          <div class="dropdown" data-filter="price">
            <button class="dropbtn">
              Price<span class="current" id="priceLabel"></span>
            </button>
            <div class="dropdown-content">
              <div class="price-controls">
                <div class="row">
                  <input
                    id="minPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Min ₱"
                  />
                  <input
                    id="maxPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Max ₱"
                  />
                </div>
                <button id="applyPrice">Apply range</button>
              </div>
            </div>
          </div>

          <!-- Category (FIXED LIST) -->
          <div class="dropdown" data-filter="category">
            <button class="dropbtn">
              Category<span class="current" id="categoryLabel"></span>
            </button>
            <div class="dropdown-content" id="categoryMenu"></div>
          </div>

          <!-- Level (1–10 FIXED) -->
          <div class="dropdown" data-filter="level">
            <button class="dropbtn">
              Level<span class="current" id="levelLabel"></span>
            </button>
            <div class="dropdown-content" id="levelMenu"></div>
          </div>
        </div>

        <!-- CARDS -->
        <section class="cards"></section>
        <div class="scroll-tip">Scroll down for more</div>
      </main>

      <!-- Right column left empty to match your 3-col grid -->
      <div></div>
    </div>
    <!-- CLOSE .container AT THE END -->

    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <!-- Supabase UMD build -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script>
      const { createClient } = supabase;

      // ✅ Your Supabase project details
      const SUPABASE_URL = "https://gxydxmobwrccqagltlci.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4eWR4bW9id3JjY3FhZ2x0bGNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDMzOTMsImV4cCI6MjA3MDcxOTM5M30.Zk2xUlmlPGbe-7rDsqC486Js9LGFMMOp-fytNZSwzBs";
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ---------- helpers ----------
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const esc = (str) =>
        String(str ?? "").replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      const fmtPeso = (n) => {
        const v = typeof n === "string" ? parseFloat(n) : n;
        return isNaN(v)
          ? "-"
          : v.toLocaleString("en-PH", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
      };
      const fmtDate = (d) =>
        d ? new Date(d + "T00:00:00").toLocaleDateString() : "-";
      const fmtTime = (t) => (t ? String(t).slice(0, 5) : "");

      // Build PUBLIC URL from jobs bucket
      function publicJobImageUrl(rawPath, postedBy) {
        if (!rawPath) return "";
        if (/^https?:\/\//i.test(rawPath)) return rawPath;
        let clean = String(rawPath)
          .replace(/^\/+/, "")
          .replace(/^jobs\//, "");
        if (clean && !clean.includes("/") && postedBy)
          clean = `${postedBy}/${clean}`;
        const { data } = sb.storage.from("jobs").getPublicUrl(clean);
        return data?.publicUrl || "";
      }

      // ---------- FIXED FILTER OPTIONS ----------
      const FIXED_CATEGORIES = [
        "", // All
        "Electrical",
        "Safety",
        "Networking",
        "CCTV",
        "Plumbing",
        "General Services",
      ];
      const FIXED_LEVELS = [
        "",
        ...Array.from({ length: 10 }, (_, i) => String(i + 1)),
      ];

      // ---------- state ----------
      let ALL_JOBS = [];
      const FILTERS = {
        q: "", // text search
        minPrice: null, // number | null
        maxPrice: null, // number | null
        category: "", // exact match
        level: "", // exact match (1..10)
      };

      // ---------- rendering ----------
      function renderJobs(list) {
        const container = $(".cards");
        container.innerHTML = "";
        if (!list || list.length === 0) {
          container.innerHTML =
            '<div class="scroll-tip">No jobs match your filters.</div>';
          return;
        }
        for (const job of list) {
          const imgUrl = publicJobImageUrl(job.job_picture_url, job.posted_by);
          const card = document.createElement("article");
          card.className = "job-card";
          card.innerHTML = `
          <div class="thumb">
            <img src="${imgUrl || "../images/profile-4.jpg"}" alt="Job image"
              onerror="this.onerror=null;console.warn('Image not found:', this.src); this.src='../images/profile-4.jpg';" />
          </div>
          <div class="content">
            <div class="contentFirstRow">
              <div class="title">${esc(job.job_title)}</div>
              <div class="meta-row">
                <span class="pill">${esc(
                  job.job_category || "Uncategorized"
                )}</span>
                <span class="pill">Difficulty: ${esc(
                  job.job_difficulty ?? ""
                )}</span>
              </div>
            </div>
            <div class="info-grid">
              <div><div class="label">Pay: ₱${fmtPeso(job.job_pay)}</div></div>
              <div><div class="label">Date/Time: ${fmtDate(
                job.job_date
              )} ${fmtTime(job.job_time)}</div></div>
              <div><div class="label">Location: ${esc(
                job.job_location || "Not specified"
              )}</div></div>
            </div>
            <div class="desc">${esc(
              job.job_description || "No description provided"
            )}</div>
          </div>
          <button class="apply" data-job-id="${
            job.job_id
          }">Apply for this Job!</button>
        `;
          container.appendChild(card);
        }
      }

      function populateMenus() {
        const fillMenu = (el, values) => {
          el.innerHTML = values
            .map(
              (v) =>
                `<a href="#" data-value="${esc(v)}">${v ? esc(v) : "All"}</a>`
            )
            .join("");
        };

        fillMenu($("#categoryMenu"), FIXED_CATEGORIES);
        fillMenu($("#levelMenu"), FIXED_LEVELS);

        updateButtonLabels();
      }

      function updateButtonLabels() {
        $("#priceLabel").textContent =
          FILTERS.minPrice || FILTERS.maxPrice
            ? `(${FILTERS.minPrice ?? 0}–${FILTERS.maxPrice ?? "∞"})`
            : "";
        $("#categoryLabel").textContent = FILTERS.category
          ? `(${FILTERS.category})`
          : "";
        $("#levelLabel").textContent = FILTERS.level
          ? `(${FILTERS.level})`
          : "";
      }

      // Apply filters to ALL_JOBS
function applyFilters() {
  let list = [...ALL_JOBS];

  // text search across title/desc/location
  const q = (FILTERS.q || "").trim().toLowerCase();
  if (q) {
    list = list.filter((j) => {
      const hay = [j.job_title, j.job_description, j.job_location]
        .map((x) => String(x ?? "").toLowerCase())
        .join(" | ");
      return hay.includes(q);
    });
  }

  // category
  if (FILTERS.category)
    list = list.filter(
      (j) => String(j.job_category || "") === FILTERS.category
    );

  // level (difficulty)
  if (FILTERS.level)
    list = list.filter(
      (j) => String(j.job_difficulty || "") === FILTERS.level
    );

  // price range
  const toNum = (v) =>
    v === null || v === "" || Number.isNaN(v) ? null : Number(v);
  const minP = toNum(FILTERS.minPrice);
  const maxP = toNum(FILTERS.maxPrice);

  if (minP !== null)
    list = list.filter((j) => Number(j.job_pay ?? 0) >= minP);
  if (maxP !== null)
    list = list.filter((j) => Number(j.job_pay ?? 0) <= maxP);

  renderJobs(list);
  updateButtonLabels();
}


      // ---------- main ----------
      async function loadJobs() {
        const container = $(".cards");
        if (!container) {
          console.error(
            'Missing .cards element. Ensure <section class="cards"> exists.'
          );
          return;
        }
        container.innerHTML = '<div class="scroll-tip">Loading jobs…</div>';

        const { data: jobs, error } = await sb
          .from("job")
          .select(
            "job_id, posted_by, job_title, job_description, job_difficulty, job_category, job_location, job_date, job_time, job_pay, job_picture_url, created_at"
          )
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error fetching jobs:", error);
          container.innerHTML = `<div class="scroll-tip">Could not load jobs: ${esc(
            error.message || "Check URL/key & RLS"
          )}</div>`;
          return;
        }

        ALL_JOBS = jobs || [];
        populateMenus(); // fixed menus
        applyFilters(); // initial render
      }

      // ---------- UI wiring ----------
      // Open/close dropdowns (click outside closes)
      document.addEventListener("click", (e) => {
        const dd = e.target.closest(".dropdown");
        // Close all
        $$(".dropdown").forEach((d) => d.classList.remove("open"));
        // Toggle the one clicked (if any)
        if (dd) dd.classList.add("open");
      });

      // Category / Level option clicks
      ["categoryMenu", "levelMenu"].forEach((menuId) => {
        const menu = document.getElementById(menuId);
        menu.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-value]");
          if (!a) return;
          e.preventDefault();
          const value = a.getAttribute("data-value");
          if (menuId === "categoryMenu") FILTERS.category = value;
          if (menuId === "levelMenu") FILTERS.level = value;
          applyFilters();
          // close the dropdown
          menu.closest(".dropdown").classList.remove("open");
        });
      });

      // Price apply
      $("#applyPrice").addEventListener("click", () => {
        const min = $("#minPrice").value ? Number($("#minPrice").value) : null;
        const max = $("#maxPrice").value ? Number($("#maxPrice").value) : null;
        FILTERS.minPrice = Number.isFinite(min) ? min : null;
        FILTERS.maxPrice = Number.isFinite(max) ? max : null;
        applyFilters();
        $("#minPrice").blur();
        $("#maxPrice").blur();
        $("#applyPrice").closest(".dropdown").classList.remove("open");
      });

      // Search (debounced)
      let tId;
      $("#searchInput").addEventListener("input", (e) => {
        clearTimeout(tId);
        tId = setTimeout(() => {
          FILTERS.q = e.target.value || "";
          applyFilters();
        }, 200);
      });

      // Load
      document.addEventListener("DOMContentLoaded", loadJobs);
    </script>
  </body>
</html>
