<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <title>Jobs</title>
    <style>
      /* ===== MAIN CONTENT (new) ===== */
      main {
        margin-top: 1.4rem;
      }
      .page-header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .page-header h1 {
        color: #1c2430;
      }
      .page-header p {
        font-size: 0.9rem;
      }

      /* Search + Filters row */
      .searchBarDiv {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: 1.5fr repeat(3, auto); /* search + price + category + level */
        gap: 0.6rem;
        align-items: center;
      }
      .searchDiv {
        background: var(--color-white);
        border-radius: 999px;
        box-shadow: var(--box-shadow);
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.8rem 1.2rem;
      }
      .searchDiv input {
        flex: 1;
        background: transparent;
        font: inherit;
        color: var(--color-dark);
        border: none;
        outline: none;
      }
      .searchDiv .material-icons-sharp {
        font-size: 1.2rem;
        color: var(--color-info-dark);
      }

      /* Dropdowns */
      .dropdown {
        position: relative;
      }
      .dropbtn {
        padding: 0.7rem 1rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        font-weight: 600;
      }
      .dropdown-content {
        position: absolute;
        top: 110%;
        right: 0;
        min-width: 220px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: var(--box-shadow);
        display: none;
        z-index: 10;
        padding: 0.4rem;
      }
      .dropdown.open .dropdown-content {
        display: block;
      }
      .dropdown-content a {
        display: block;
        padding: 0.6rem 0.8rem;
        border-radius: 10px;
        color: #1f2937;
        text-decoration: none;
        font-size: 0.92rem;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }

      /* Price range mini-form inside dropdown */
      .price-controls {
        padding: 0.6rem 0.8rem;
        display: grid;
        gap: 0.5rem;
      }
      .price-controls .row {
        display: flex;
        gap: 0.5rem;
      }
      .price-controls input {
        width: 100%;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.5rem 0.6rem;
      }
      .price-controls button {
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        font-weight: 600;
        background: #3bbf67;
        color: #fff;
      }

      .cards {
        margin-top: 1.4rem;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.4rem;
      }
      @media (max-width: 900px) {
        .cards {
          grid-template-columns: 1fr;
        }
      }

      .job-card {
        background: var(--color-white);
        border-radius: 20px;
        box-shadow: var(--box-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .thumb img {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .job-card .content {
        padding: 1rem 1.2rem;
      }
      .job-card .title {
        font-weight: 700;
      }
      .meta-row {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin: 0.6rem 0 0.2rem;
      }
      .pill {
        font-size: 0.72rem;
        line-height: 1;
        padding: 0.42rem 0.8rem;
        border-radius: 999px;
        background: #eef2f7;
        color: #6b7280;
        border: 1px solid #e5e7eb;
      }
      .info-grid {
        display: grid;
        gap: 0.6rem;
        margin: 0.6rem 0 0.8rem;
      }
      .info-grid .label {
        font-weight: 700;
      }
      .desc {
        font-size: 0.86rem;
        margin: 0.4rem 0 1rem;
      }
      .apply {
        margin: 0 1.2rem 1.2rem;
        border-radius: 999px;
        background: #3bbf67;
        color: #fff;
        font-weight: 600;
        padding: 0.8rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .apply:hover {
        filter: brightness(0.95);
      }
      .scroll-tip {
        text-align: center;
        color: var(--color-info-dark);
        margin: 1rem 0 2rem;
        font-size: 0.85rem;
      }

      /* JOB TITLE & CATEGORY SA ILALIM NG PIC */
      .contentFirstRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      /* Tiny helper to show the current filter on the button */
      .dropbtn .current {
        color: #6b7280;
        font-weight: 500;
        margin-left: 0.3rem;
      }

      /* ===== Modal (Job Application) ===== */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(17, 24, 39, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal-backdrop.show {
        display: flex;
      }

      .job-modal {
        width: min(680px, 92vw);
        max-height: 86vh;
        overflow: auto;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
        padding: 18px;
        gap: 14px;
      }
      .job-modal .banner {
        background: #f0fdf4;
        color: #065f46;
        border: 1px solid #dcfce7;
        padding: 8px 10px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .m-header {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .m-header img#mImg {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 12px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
      }
      .m-headings h3 {
        margin: 0;
      }
      .job-modal .tiny {
        color: #6b7280;
        font-size: 0.9rem;
      }
      .m-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .job-modal .pill {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        font-size: 0.78rem;
      }
      .m-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      @media (max-width: 520px) {
        .m-meta {
          grid-template-columns: 1fr;
        }
      }
      .m-meta > div {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        background: #fafafa;
        border: 1px solid #eee;
        border-radius: 12px;
      }
      .m-meta .label {
        font-weight: 600;
        color: #111827;
      }
      .job-modal .desc {
        margin-top: 4px;
        line-height: 1.55;
        font-size: 0.95rem;
        color: #1f2937;
      }
      .job-modal .resume {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.92rem;
      }
      .job-modal .resume a {
        color: #15803d;
        text-decoration: none;
      }
      .job-modal .cta-row {
        display: flex;
        gap: 10px;
        margin-top: 4px;
      }
      .job-modal .btn {
        border: none;
        border-radius: 12px;
        padding: 0.85rem 1rem;
        font-weight: 700;
        cursor: pointer;
      }
      .job-modal .btn-apply {
        background: #22c55e;
        color: #fff;
      }
      .job-modal .btn-apply:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .job-modal .btn-cancel {
        background: #e5e7eb;
        color: #111827;
      }
      @media (max-width: 400px) {
        .job-modal {
          padding: 14px;
        }
        .m-header img#mImg {
          width: 56px;
          height: 56px;
        }
      }

      .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        z-index: 60;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        font-size: 0.9rem;
        display: none;
      }
      .toast.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="#" alt="logo" />
            <h2>SIMP<span class="danger">Project</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp">close</span>
          </div>
        </div>
        <div class="sidebar">
          <a href="dashboard.html"
            ><span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3></a
          >
          <a href="job.html" class="active"
            ><span class="material-icons-sharp">work</span>
            <h3>Jobs</h3></a
          >
          <a href="myApplication.html"
            ><span class="material-icons-sharp">receipt</span>
            <h3>My Application</h3></a
          >
          <a href="courses.html"
            ><span class="material-icons-sharp">school</span>
            <h3>Courses</h3></a
          >
          <a href="shop.html"
            ><span class="material-icons-sharp">shopping_cart</span>
            <h3>Shop</h3></a
          >
          <a href="earnings.html"
            ><span class="material-icons-sharp">account_balance</span>
            <h3>Earnings</h3></a
          >
          <a href="documents.html"
            ><span class="material-icons-sharp">file_copy</span>
            <h3>Documents</h3></a
          >
          <a href="settings.html"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3></a
          >
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3></a
          >
        </div>
      </aside>

      <!-- Main content column (center) -->
      <main>
        <div class="page-header">
          <h1>Current Job Openings</h1>
          <p>Explore career opportunities near you.</p>
        </div>

        <!-- SEARCH + FILTERS -->
        <div class="searchBarDiv">
          <!-- Search -->
          <div class="searchDiv">
            <span class="material-icons-sharp">search</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search jobs (title, description, location)"
            />
          </div>
          <!-- Price -->
          <div class="dropdown" data-filter="price">
            <button class="dropbtn">
              Price<span class="current" id="priceLabel"></span>
            </button>
            <div class="dropdown-content">
              <div class="price-controls">
                <div class="row">
                  <input
                    id="minPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Min ₱"
                  />
                  <input
                    id="maxPrice"
                    type="number"
                    step="0.01"
                    min="0"
                    placeholder="Max ₱"
                  />
                </div>
                <button id="applyPrice">Apply range</button>
              </div>
            </div>
          </div>
          <!-- Category (FIXED LIST) -->
          <div class="dropdown" data-filter="category">
            <button class="dropbtn">
              Category<span class="current" id="categoryLabel"></span>
            </button>
            <div class="dropdown-content" id="categoryMenu"></div>
          </div>
          <!-- Level (1–10 FIXED) -->
          <div class="dropdown" data-filter="level">
            <button class="dropbtn">
              Level<span class="current" id="levelLabel"></span>
            </button>
            <div class="dropdown-content" id="levelMenu"></div>
          </div>
        </div>

        <!-- CARDS -->
        <section class="cards"></section>
        <div class="scroll-tip">Scroll down for more</div>
      </main>

      <!-- Right column filler -->
      <div></div>
    </div>

    <!-- Job Application Modal -->
    <div id="applyModal" class="modal-backdrop" aria-hidden="true">
      <div
        class="job-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="jobModalTitle"
      >
        <div class="banner" id="fitBanner" style="display: none">
          <span class="material-icons-sharp" style="font-size: 18px"
            >verified</span
          >
          <span>You are a strong candidate for this job</span>
        </div>
        <!-- Header -->
        <div class="m-header">
          <img id="mImg" src="" alt="Job photo" />
          <div class="m-headings">
            <h3 id="jobModalTitle">Job Title</h3>
            <div class="tiny" id="mPostedBy">Anonymous</div>
          </div>
        </div>
        <!-- Meta chips -->
        <div class="m-chips">
          <span class="pill" id="mCategory">Category</span>
          <span class="pill" id="mDifficulty">Difficulty</span>
        </div>
        <!-- Key info -->
        <div class="m-meta">
          <div><span class="label">Pay</span><span id="mPay">₱–</span></div>
          <div><span class="label">Date/Time</span><span id="mDT">–</span></div>
          <div><span class="label">Location</span><span id="mLoc">–</span></div>
        </div>
        <!-- Description -->
        <div class="desc" id="mDesc"></div>
        <!-- Resume row (auto-filled per current installer) -->
        <div class="resume" id="mResumeRow">
          <span class="material-icons-sharp" style="font-size: 18px"
            >attach_file</span
          >
          <a
            id="mResumeLink"
            href="javascript:void(0)"
            title="Resume"
            target="_blank"
            rel="noopener"
            >Loading…</a
          >
          <span class="tiny" style="margin-left: auto; color: #6b7280"
            >(optional)</span
          >
        </div>
        <!-- Actions -->
        <div class="cta-row">
          <button id="modalApplyBtn" class="btn btn-apply">
            Apply for this Job!
          </button>
          <button id="modalCancelBtn" class="btn btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Global site scripts -->
    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>
    <!-- Supabase UMD build -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <script type="module">
      const { createClient } = supabase;
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ---------- helpers ----------
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const esc = (str) =>
        String(str ?? "").replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      const fmtPeso = (n) => {
        const v = typeof n === "string" ? parseFloat(n) : n;
        return isNaN(v)
          ? "-"
          : v.toLocaleString("en-PH", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
      };
      const fmtDate = (d) =>
        d ? new Date(d + "T00:00:00").toLocaleDateString() : "-";
      const fmtTime = (t) => (t ? String(t).slice(0, 5) : "");
      function showToast(msg, ms = 2800) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), ms);
      }

      function publicJobImageUrl(rawPath, postedBy) {
        if (!rawPath) return "";
        if (/^https?:\/\//i.test(rawPath)) return rawPath;
        let clean = String(rawPath)
          .replace(/^\/+/, "")
          .replace(/^jobs\//, "");
        if (clean && !clean.includes("/") && postedBy)
          clean = `${postedBy}/${clean}`;
        const { data } = sb.storage.from("jobs").getPublicUrl(clean);
        return data?.publicUrl || "";
      }

      const FIXED_CATEGORIES = [
        "",
        "Electrical",
        "Safety",
        "Networking",
        "CCTV",
        "Plumbing",
        "General Services",
      ];
      const FIXED_LEVELS = [
        "",
        ...Array.from({ length: 10 }, (_, i) => String(i + 1)),
      ];

      // ---------- state ----------
      let ALL_JOBS = [];
      let jobsChannel = null;
      const FILTERS = {
        q: "",
        minPrice: null,
        maxPrice: null,
        category: "",
        level: "",
      };

      // === ADDED: helper to detect if a job already has an assigned installer ===
      function hasAssignedInstaller(row) {
        const v = row?.installer_id_assigned;
        return v !== null && v !== undefined && String(v).trim() !== "";
      }

      // ---------- UI renderers ----------
      function renderJobs(list) {
        const container = $(".cards");
        container.innerHTML = "";
        if (!list || list.length === 0) {
          container.innerHTML =
            '<div class="scroll-tip">No jobs match your filters.</div>';
          return;
        }
        for (const job of list) {
          const imgUrl = publicJobImageUrl(job.job_picture_url, job.posted_by);
          const card = document.createElement("article");
          card.className = "job-card";
          card.innerHTML = `
            <div class="thumb">
              <img src="${imgUrl || "../images/profile-4.jpg"}" alt="Job image"
                   onerror="this.onerror=null;console.warn('Image not found:', this.src); this.src='../images/profile-4.jpg';" />
            </div>
            <div class="content">
              <div class="contentFirstRow">
                <div class="title">${esc(job.job_title)}</div>
                <div class="meta-row">
                  <span class="pill">${esc(
                    job.job_category || "Uncategorized"
                  )}</span>
                  <span class="pill">Difficulty: ${esc(
                    job.job_difficulty ?? ""
                  )}</span>
                </div>
              </div>
              <div class="info-grid">
                <div><div class="label">Pay: ₱${fmtPeso(
                  job.job_pay
                )}</div></div>
                <div><div class="label">Date/Time: ${fmtDate(
                  job.job_date
                )} ${fmtTime(job.job_time)}</div></div>
                <div><div class="label">Location: ${esc(
                  job.job_location || "Not specified"
                )}</div></div>
              </div>
              <div class="desc">${esc(
                job.job_description || "No description provided"
              )}</div>
            </div>
            <button class="apply" data-job-id="${job.job_id}">View</button>
          `;
          container.appendChild(card);
        }
      }

      function populateMenus() {
        const fillMenu = (el, values) => {
          el.innerHTML = values
            .map(
              (v) =>
                `<a href="#" data-value="${esc(v)}">${v ? esc(v) : "All"}</a>`
            )
            .join("");
        };
        $("#categoryMenu") && fillMenu($("#categoryMenu"), FIXED_CATEGORIES);
        $("#levelMenu") && fillMenu($("#levelMenu"), FIXED_LEVELS);
        updateButtonLabels();
      }

      function updateButtonLabels() {
        const priceText =
          FILTERS.minPrice != null || FILTERS.maxPrice != null
            ? `${FILTERS.minPrice ?? 0}–${FILTERS.maxPrice ?? "∞"}`
            : "";
        $("#priceLabel") && ($("#priceLabel").textContent = priceText);
        $("#categoryLabel") &&
          ($("#categoryLabel").textContent = FILTERS.category
            ? ` (${FILTERS.category})`
            : "");
        $("#levelLabel") &&
          ($("#levelLabel").textContent = FILTERS.level
            ? ` (${FILTERS.level})`
            : "");
      }

      function applyFilters() {
        let list = [...ALL_JOBS];
        const q = (FILTERS.q || "").trim().toLowerCase();
        if (q) {
          list = list.filter((j) => {
            const hay = [j.job_title, j.job_description, j.job_location]
              .map((x) => String(x ?? "").toLowerCase())
              .join(" | ");
            return hay.includes(q);
          });
        }
        if (FILTERS.category)
          list = list.filter(
            (j) => String(j.job_category || "") === FILTERS.category
          );
        if (FILTERS.level)
          list = list.filter(
            (j) => String(j.job_difficulty || "") === FILTERS.level
          );
        const toNum = (v) =>
          v === null || v === "" || Number.isNaN(v) ? null : Number(v);
        const minP = toNum(FILTERS.minPrice);
        const maxP = toNum(FILTERS.maxPrice);
        if (minP !== null)
          list = list.filter((j) => Number(j.job_pay ?? 0) >= minP);
        if (maxP !== null)
          list = list.filter((j) => Number(j.job_pay ?? 0) <= maxP);
        renderJobs(list);
        updateButtonLabels();
      }

      // ---------- initial load ----------
      async function loadJobs() {
        const container = $(".cards");
        if (!container) {
          console.error(
            'Missing .cards element. Ensure <section class="cards"> exists.'
          );
          return;
        }
        container.innerHTML = '<div class="scroll-tip">Loading jobs…</div>';

        const { data: jobs, error } = await sb
          .schema("jobs")
          .from("job")
          .select(
            // ADDED installer_id_assigned so we can hide jobs that already have an installer
            "job_id, posted_by, job_title, job_description, job_difficulty, job_category, job_location, job_date, job_time, job_pay, job_picture_url, created_at, job_status, installer_id_assigned"
          )
          .eq("job_status", "approved")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error fetching jobs:", error);
          container.innerHTML = `<div class="scroll-tip">Could not load jobs: ${esc(
            error.message || "Check URL/key & RLS"
          )}</div>`;
          return;
        }

        // ADDED: filter out jobs that already have an assigned installer
        const visible = (jobs || []).filter((j) => !hasAssignedInstaller(j));

        ALL_JOBS = visible;
        populateMenus();
        applyFilters();

        await ensureRealtimeAuth();
        initRealtimeApprovalListener();
      }

      // ---------- realtime helpers ----------
      async function ensureRealtimeAuth() {
        const {
          data: { session },
        } = await sb.auth.getSession();
        if (session?.access_token) {
          sb.realtime.setAuth(session.access_token);
          console.log("[Realtime] setAuth with user token");
        } else {
          console.log(
            "[Realtime] no user session; using anon token (make sure your SELECT policy allows it)"
          );
        }
      }

      sb.auth.onAuthStateChange(async (_event, session) => {
        sb.realtime.setAuth(session?.access_token ?? null);
        if (jobsChannel) {
          try {
            sb.removeChannel(jobsChannel);
          } catch {}
          jobsChannel = null;
        }
        initRealtimeApprovalListener();
      });

      function upsertApprovedJob(row) {
        // ADDED: ensure not assigned and approved
        if (!row || row.job_status !== "approved") return;
        if (hasAssignedInstaller(row)) {
          // if it's assigned, make sure it isn't in our list
          removeIfNoLongerApproved(row);
          return;
        }
        const idx = ALL_JOBS.findIndex(
          (j) => String(j.job_id) === String(row.job_id)
        );
        if (idx >= 0) {
          ALL_JOBS[idx] = row;
        } else {
          ALL_JOBS.unshift(row);
        }
        applyFilters();
        showToast(`New approved job: ${row.job_title || row.job_id}`);
      }

      function removeIfNoLongerApproved(rowLike) {
        if (!rowLike) return;
        const before = ALL_JOBS.length;
        ALL_JOBS = ALL_JOBS.filter(
          (j) => String(j.job_id) !== String(rowLike.job_id)
        );
        if (ALL_JOBS.length !== before) applyFilters();
      }

      function initRealtimeApprovalListener() {
        if (jobsChannel) return;

        jobsChannel = sb
          .channel("jobs-approved-feed")

          // INSERT
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "jobs", table: "job" },
            (payload) => {
              const n = payload.new;
              if (n?.job_status === "approved") upsertApprovedJob(n);
            }
          )

          // UPDATE
          .on(
            "postgres_changes",
            { event: "UPDATE", schema: "jobs", table: "job" },
            (payload) => {
              const n = payload.new;
              // ADDED: if approved but gets an assigned installer -> remove; if approved & unassigned -> upsert; else remove
              if (n?.job_status === "approved" && !hasAssignedInstaller(n)) {
                upsertApprovedJob(n);
              } else {
                removeIfNoLongerApproved(n);
              }
            }
          )

          // DELETE
          .on(
            "postgres_changes",
            { event: "DELETE", schema: "jobs", table: "job" },
            (payload) => {
              const o = payload.old;
              removeIfNoLongerApproved(o);
            }
          )

          .subscribe((status) => {
            console.log("[Realtime] Channel status:", status);
            if (status === "SUBSCRIBED")
              console.log("[Realtime] Subscribed to jobs-approved-feed");
          });
      }

      // ---------- dropdown UI wiring ----------
      document.addEventListener("click", (e) => {
        const dd = e.target.closest(".dropdown");
        $$(".dropdown").forEach((d) => d.classList.remove("open"));
        if (dd) dd.classList.add("open");
      });

      ["categoryMenu", "levelMenu"].forEach((menuId) => {
        const menu = document.getElementById(menuId);
        menu.addEventListener("click", (e) => {
          const a = e.target.closest("a[data-value]");
          if (!a) return;
          e.preventDefault();
          const value = a.getAttribute("data-value");
          if (menuId === "categoryMenu") FILTERS.category = value;
          if (menuId === "levelMenu") FILTERS.level = value;
          applyFilters();
          menu.closest(".dropdown").classList.remove("open");
        });
      });

      $("#applyPrice").addEventListener("click", () => {
        const min = $("#minPrice").value ? Number($("#minPrice").value) : null;
        const max = $("#maxPrice").value ? Number($("#maxPrice").value) : null;
        FILTERS.minPrice = Number.isFinite(min) ? min : null;
        FILTERS.maxPrice = Number.isFinite(max) ? max : null;
        applyFilters();
        $("#minPrice").blur();
        $("#maxPrice").blur();
        const priceDropdown = document.querySelector(
          '.dropdown[data-filter="price"]'
        );
        if (priceDropdown) priceDropdown.classList.remove("open");
      });

      // Search (debounced)
      let tId;
      $("#searchInput").addEventListener("input", (e) => {
        clearTimeout(tId);
        tId = setTimeout(() => {
          FILTERS.q = e.target.value || "";
          applyFilters();
        }, 200);
      });

      document.addEventListener("DOMContentLoaded", loadJobs);

      // ===== Modal + Application Logic =====
      const modal = document.getElementById("applyModal");
      const modalBtnCancel = document.getElementById("modalCancelBtn");
      const resumeLinkEl = document.getElementById("mResumeLink");
      let CURRENT_JOB_ID = null;

      async function resolveInstallerId() {
        const {
          data: { user },
          error: uErr,
        } = await sb.auth.getUser();
        if (uErr) console.warn("auth.getUser error", uErr);
        const email = user?.email;
        if (!email) return null;
        const { data: inst, error } = await sb
          .from("installer")
          .select("id, email")
          .eq("email", email)
          .limit(1)
          .maybeSingle();
        if (error) {
          console.warn("installer lookup error", error);
          return null;
        }
        return inst?.id ?? null;
      }

      async function getInstallerLevel(installerId) {
        if (!installerId) return null;
        const { data, error } = await sb
          .from("installer")
          .select("levelstatus")
          .eq("id", installerId)
          .limit(1)
          .maybeSingle();
        if (error) {
          console.warn("installer levelstatus lookup error", error);
          return null;
        }
        return data?.levelstatus ?? null;
      }

      let RESUME_CACHE = {
        loaded: false,
        url: "",
        name: "",
        installerId: null,
      };
      async function getInstallerResume() {
        if (RESUME_CACHE.loaded) return RESUME_CACHE;
        const installerId = await resolveInstallerId();
        if (!installerId) {
          RESUME_CACHE = { loaded: true, url: "", name: "", installerId: null };
          return RESUME_CACHE;
        }
        const { data, error } = await sb
          .from("installer_documents")
          .select("resume")
          .eq("installer_id", installerId)
          .maybeSingle();
        if (error) {
          console.warn("installer_documents lookup error", error);
          RESUME_CACHE = { loaded: true, url: "", name: "", installerId };
          return RESUME_CACHE;
        }
        let path = data?.resume || "";
        if (!path) {
          RESUME_CACHE = { loaded: true, url: "", name: "", installerId };
          return RESUME_CACHE;
        }
        if (path && !path.includes("/")) path = `${installerId}/${path}`;
        const { data: pub } = sb.storage
          .from("documents_review")
          .getPublicUrl(path);
        const url = pub?.publicUrl || "";
        const name = path.split("/").pop() || "resume.pdf";
        RESUME_CACHE = { loaded: true, url, name, installerId };
        return RESUME_CACHE;
      }

      async function setResumeLinkInModal() {
        resumeLinkEl.textContent = "Loading…";
        resumeLinkEl.removeAttribute("href");
        resumeLinkEl.style.pointerEvents = "none";
        const res = await getInstallerResume();
        if (res.url) {
          resumeLinkEl.textContent = res.name;
          resumeLinkEl.href = res.url;
          resumeLinkEl.style.pointerEvents = "auto";
        } else {
          resumeLinkEl.textContent = "No resume on file";
          resumeLinkEl.removeAttribute("href");
          resumeLinkEl.style.pointerEvents = "none";
        }
      }

      function closeApplyModal() {
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        CURRENT_JOB_ID = null;
      }

      async function openApplyModal(job) {
        CURRENT_JOB_ID = job.job_id;
        const imgUrl = publicJobImageUrl(job.job_picture_url, job.posted_by);
        document.getElementById("mImg").src =
          imgUrl || "../images/profile-4.jpg";
        document.getElementById("mCategory").textContent =
          job.job_category || "Uncategorized";
        document.getElementById("mDifficulty").textContent = `Difficulty: ${
          job.job_difficulty ?? "-"
        }`;
        document.getElementById("mPay").textContent =
          "₱" + fmtPeso(job.job_pay);
        document.getElementById("mDT").textContent = `${fmtDate(
          job.job_date
        )} ${fmtTime(job.job_time)}`;
        document.getElementById("mLoc").textContent =
          job.job_location || "Not specified";
        document.getElementById("jobModalTitle").textContent =
          job.job_title || "Job";
        document.getElementById("mDesc").textContent =
          job.job_description || "No description provided";
        document.getElementById("fitBanner").style.display = "none";
        await setResumeLinkInModal();
        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
      }

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeApplyModal();
      });
      document.getElementById("modalCancelBtn").addEventListener("click", closeApplyModal);

      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".apply[data-job-id]");
        if (!btn) return;
        const jobId = btn.getAttribute("data-job-id");
        const job = (ALL_JOBS || []).find(
          (j) => String(j.job_id) === String(jobId)
        );
        if (!job) {
          showToast("Could not load job details.");
          return;
        }
        openApplyModal(job);
      });

      document
        .getElementById("modalApplyBtn")
        .addEventListener("click", async () => {
          if (!CURRENT_JOB_ID) return;
          const modalBtnApply = document.getElementById("modalApplyBtn");
          modalBtnApply.disabled = true;
          modalBtnApply.textContent = "Checking eligibility…";
          try {
            const base = await getInstallerResume();
            const installerId =
              base.installerId || (await resolveInstallerId());
            if (!installerId) {
              showToast(
                "We could not identify your installer profile. Please sign in again."
              );
              modalBtnApply.disabled = false;
              modalBtnApply.textContent = "Apply for this Job!";
              return;
            }
            const levelstatus = await getInstallerLevel(installerId);

            const job = (ALL_JOBS || []).find(
              (j) => String(j.job_id) === String(CURRENT_JOB_ID)
            );
            const requiredLevel = Number(job?.job_difficulty ?? 0);
            const userLevel = Number(levelstatus ?? 0);

            if (
              Number.isFinite(requiredLevel) &&
              Number.isFinite(userLevel) &&
              userLevel < requiredLevel
            ) {
              showToast(
                `Application blocked: your current level (${userLevel}) does not meet the required job level (${requiredLevel}).`
              );
              modalBtnApply.disabled = false;
              modalBtnApply.textContent = "Apply for this Job!";
              return;
            }

            modalBtnApply.textContent = "Submitting…";
            const payload = {
              job_id: CURRENT_JOB_ID,
              installer_id: installerId,
              status: "pending",
            };
            const { error } = await sb
              .schema("jobs")
              .from("job_application")
              .insert(payload);
            if (error) {
              const msg =
                error.code === "23505" || /duplicate/i.test(error.message)
                  ? "You already applied to this job."
                  : `Could not submit application: ${error.message}`;
              showToast(msg, 3000);
            } else {
              showToast("Application submitted. Status: pending.", 2400);
              closeApplyModal();
            }
          } catch (err) {
            console.error(err);
            showToast("Unexpected error while applying. Please try again.");
          } finally {
            modalBtnApply.disabled = false;
            modalBtnApply.textContent = "Apply for this Job!";
          }
        });
    </script>
  </body>
</html>
