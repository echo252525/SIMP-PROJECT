<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css_files/sideBar.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet"
    />
    <title>Dashboard</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap");

      :root {
        --color-primary: #6c9bcf;
        --color-danger: #ff0060;
        --color-success: #1b9c85;
        --color-warning: #f7d060;
        --color-white: #fff;
        --color-info-dark: #7d8da1;
        --color-dark: #363949;
        --color-light: rgba(132, 139, 200, 0.18);
        --color-dark-variant: #677483;
        --color-background: #f6f6f9;

        --card-border-radius: 2rem;
        --border-radius-1: 0.4rem;
        --border-radius-2: 1.2rem;

        --card-padding: 1.8rem;
        --padding-1: 1.2rem;

        --box-shadow: 0 2rem 3rem var(--color-light);
      }

      .dark-mode-variables {
        --color-background: #181a1e;
        --color-white: #202528;
        --color-dark: #edeffd;
        --color-dark-variant: #a3bdcc;
        --color-light: rgba(0, 0, 0, 0.4);
        --box-shadow: 0 2rem 3rem var(--color-light);
      }

      * {
        margin: 0;
        padding: 0;
        outline: 0;
        appearance: 0;
        border: 0;
        text-decoration: none;
        box-sizing: border-box;
      }

      html {
        font-size: 14px;
      }

      body {
        width: 100vw;
        height: 100vh;
        font-family: "Poppins", sans-serif;
        font-size: 0.88rem;
        user-select: none;
        overflow-x: hidden;
        color: var(--color-dark);
        background-color: var(--color-background);
      }

      a {
        color: var(--color-dark);
      }
      img {
        display: block;
        width: 100%;
        object-fit: cover;
      }
      h1 {
        font-weight: 800;
        font-size: 1.8rem;
      }
      h2 {
        font-weight: 600;
        font-size: 1.4rem;
      }
      h3 {
        font-weight: 500;
        font-size: 0.87rem;
      }
      small {
        font-size: 0.76rem;
      }
      p {
        color: var(--color-dark-variant);
      }
      b {
        color: var(--color-dark);
      }
      .text-muted {
        color: var(--color-info-dark);
      }
      .primary {
        color: var(--color-primary);
      }
      .danger {
        color: var(--color-danger);
      }
      .success {
        color: var(--color-success);
      }
      .warning {
        color: var(--color-warning);
      }

      .container {
        display: grid;
        width: 96%;
        margin: 0 auto;
        gap: 1.8rem;
        grid-template-columns: 12rem auto 23rem;
      }
      aside {
        height: 100vh;
      }

      aside .toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 1.4rem;
      }
      aside .toggle .logo {
        display: flex;
        gap: 0.5rem;
      }
      aside .toggle .logo img {
        width: 2rem;
        height: 2rem;
      }
      aside .toggle .close {
        padding-right: 1rem;
        display: none;
      }

      aside .sidebar {
        display: flex;
        flex-direction: column;
        background-color: var(--color-white);
        box-shadow: var(--box-shadow);
        border-radius: 15px;
        height: 88vh;
        position: relative;
        top: 1.5rem;
        transition: all 0.3s ease;
      }
      aside .sidebar:hover {
        box-shadow: none;
      }

      aside .sidebar a {
        display: flex;
        align-items: center;
        color: var(--color-info-dark);
        height: 3.7rem;
        gap: 1rem;
        position: relative;
        margin-left: 2rem;
        transition: all 0.3s ease;
      }
      aside .sidebar a span {
        font-size: 1.6rem;
        transition: all 0.3s ease;
      }
      aside .sidebar a:last-child {
        position: absolute;
        bottom: 2rem;
        width: 100%;
      }
      aside .sidebar a.active {
        width: 100%;
        color: var(--color-primary);
        background-color: var(--color-light);
        margin-left: 0;
      }
      aside .sidebar a.active::before {
        content: "";
        width: 6px;
        height: 18px;
        background-color: var(--color-primary);
      }
      aside .sidebar a.active span {
        color: var(--color-primary);
        margin-left: calc(1rem - 3px);
      }
      aside .sidebar a:hover {
        color: var(--color-primary);
      }
      aside .sidebar a:hover span {
        margin-left: 0.6rem;
      }
      aside .sidebar .message-count {
        background-color: var(--color-danger);
        padding: 2px 6px;
        color: var(--color-white);
        font-size: 11px;
        border-radius: var(--border-radius-1);
      }

      main {
        margin-top: 1.4rem;
      }

      /* ====== Analytics cards ====== */
      main .analyse {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.6rem;
      }
      main .analyse > div {
        background-color: var(--color-white);
        padding: var(--card-padding);
        border-radius: var(--card-border-radius);
        margin-top: 1rem;
        box-shadow: var(--box-shadow);
        cursor: pointer;
        transition: all 0.3s ease;
      }
      main .analyse > div:hover {
        box-shadow: none;
      }
      main .analyse > div .status {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      main .analyse h3 {
        margin-left: 0.6rem;
        font-size: 1rem;
      }

      main .analyse .progresss {
        position: relative;
        width: 92px;
        height: 92px;
        border-radius: 50%;
      }
      main .analyse svg {
        width: 7rem;
        height: 7rem;
      }
      main .analyse svg circle {
        fill: none;
        stroke-width: 10;
        stroke-linecap: round;
        transform: translate(5px, 5px);
        stroke: var(--color-success);
      }
      .visits svg circle {
        stroke: var(--color-danger);
      }
      .searches svg circle {
        stroke: var(--color-primary);
      }
      main .analyse .progresss .percentage {
        position: absolute;
        top: -3px;
        left: -1px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
      }

      /* ====== New Jobs Posted ====== */
      .section-header {
        margin-top: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .section-header .see-all {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.45rem 0.7rem;
        border-radius: 12px;
        background: var(--color-white);
        box-shadow: var(--box-shadow);
        color: var(--color-dark);
        min-width: 124px;
        transition: transform 0.12s ease, box-shadow 0.22s ease;
      }
      .section-header .see-all .label {
        font-weight: 500;
      }
      .section-header .see-all .material-icons-sharp {
        margin-left: auto;
        font-size: 20px;
      }
      .section-header .see-all:hover {
        transform: translateX(2px);
        box-shadow: none;
      }

      .new-users {
        margin-top: 0.6rem;
      }
      .new-users .user-list {
        background-color: var(--color-white);
        padding: var(--card-padding);
        border-radius: var(--card-border-radius);
        margin-top: 0.8rem;
        box-shadow: var(--box-shadow);
        display: flex;
        flex-wrap: wrap;
        /* Most recent stays left, then next, etc. */
        justify-content: flex-start;
        gap: 1.1rem;
        transition: all 0.3s ease;
      }
      .new-users .user-list:hover {
        box-shadow: none;
      }

      .new-users .user-list a.user {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 180px;
        padding: 0.6rem 0.6rem 0.8rem;
        border-radius: 12px;
        text-align: center;
        background: var(--color-white);
        box-shadow: 0 0.5rem 1rem var(--color-light);
        transition: transform 0.15s ease, box-shadow 0.22s ease;
      }
      .new-users .user-list a.user:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.6rem 1.1rem var(--color-light);
      }
      .new-users .user-list a.user img {
        width: 100%;
        height: 100px;
        margin-bottom: 0.5rem;
        border-radius: 10px;
        object-fit: cover;
      }
      .new-users .user-list a.user h2 {
        font-size: 0.95rem;
        line-height: 1.25rem;
        max-height: 2.5rem;
        overflow: hidden;
      }
      .new-users .user-list a.user p {
        font-size: 0.78rem;
        margin-top: 0.2rem;
      }

      /* ====== Upcoming Work ====== */
      .recent-orders {
        margin-top: 1.3rem;
      }
      .recent-orders h2 {
        margin-bottom: 0.8rem;
      }
      .recent-orders table {
        background-color: var(--color-white);
        width: 100%;
        padding: var(--card-padding);
        text-align: center;
        box-shadow: var(--box-shadow);
        border-radius: var(--card-border-radius);
        transition: all 0.3s ease;
      }
      .recent-orders table:hover {
        box-shadow: none;
      }
      main table tbody td {
        height: 2.8rem;
        border-bottom: 1px solid var(--color-light);
        color: var(--color-dark-variant);
      }
      main table tbody tr:last-child td {
        border: none;
      }
      .recent-orders a {
        text-align: center;
        display: block;
        margin: 1rem auto;
        color: var(--color-primary);
      }

      /* ====== Responsive ====== */
      @media screen and (max-width: 1200px) {
        .container {
          width: 95%;
          grid-template-columns: 7rem auto 23rem;
        }
        aside .logo h2 {
          display: none;
        }
        aside .sidebar h3 {
          display: none;
        }
        aside .sidebar a {
          width: 5.6rem;
        }
        aside .sidebar a:last-child {
          position: relative;
          margin-top: 1.8rem;
        }
        main .analyse {
          grid-template-columns: 1fr;
          gap: 0;
        }
        .new-users .user-list .user {
          flex-basis: 40%;
        }
        .recent-orders {
          width: 94%;
          position: absolute;
          left: 50%;
          transform: translateX(-50%);
          margin: 2rem 0 0 0.8rem;
        }
        .recent-orders table {
          width: 83vw;
        }
        main table thead tr th:last-child,
        main table thead tr th:first-child {
          display: none;
        }
        main table tbody tr td:last-child,
        main table tbody tr td:first-child {
          display: none;
        }
      }

      @media screen and (max-width: 768px) {
        .container {
          width: 100%;
          grid-template-columns: 1fr;
          padding: 0 var(--padding-1);
        }
        aside {
          position: fixed;
          background-color: var(--color-white);
          width: 15rem;
          z-index: 3;
          box-shadow: 1rem 3rem 4rem var(--color-light);
          height: 100vh;
          left: -100%;
          display: none;
          animation: showMenu 0.4s ease forwards;
        }
        @keyframes showMenu {
          to {
            left: 0;
          }
        }
        aside .logo {
          margin-left: 1rem;
        }
        aside .logo h2 {
          display: inline;
        }
        aside .sidebar h3 {
          display: inline;
        }
        aside .sidebar a {
          width: 100%;
          height: 3.4rem;
        }
        aside .sidebar a:last-child {
          position: absolute;
          bottom: 5rem;
        }
        aside .toggle .close {
          display: inline-block;
          cursor: pointer;
        }

        main {
          margin-top: 8rem;
          padding: 0 1rem;
        }
        .new-users .user-list .user {
          flex-basis: 35%;
        }
        .recent-orders {
          position: relative;
          margin: 3rem 0 0 0;
          width: 100%;
        }
        .recent-orders table {
          width: 100%;
          margin: 0;
        }

        .right-section {
          width: 94%;
          margin: 0 auto 4rem;
        }
        .right-section .nav {
          position: fixed;
          top: 0;
          left: 0;
          align-items: center;
          background-color: var(--color-white);
          padding: 0 var(--padding-1);
          height: 4.6rem;
          width: 100%;
          z-index: 2;
          box-shadow: 0 1rem 1rem var(--color-light);
          margin: 0;
        }
        .right-section .nav .dark-mode {
          width: 4.4rem;
          position: absolute;
          left: 66%;
        }
        .right-section .profile .info {
          display: none;
        }
        .right-section .nav button {
          display: inline-block;
          background-color: transparent;
          cursor: pointer;
          color: var(--color-dark);
          position: absolute;
          left: 1rem;
        }
        .right-section .nav button span {
          font-size: 2rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar Section -->
      <aside>
        <div class="toggle">
          <div class="logo">
            <img src="images/logo.png" alt="logo" />
            <h2>Asmr<span class="danger">Prog</span></h2>
          </div>
          <div class="close" id="close-btn">
            <span class="material-icons-sharp"> close </span>
          </div>
        </div>

        <div class="sidebar">
          <a href="dashboard.html" class="active"
            ><span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3></a
          >
          <a href="job.html"
            ><span class="material-icons-sharp">work</span>
            <h3>Jobs</h3></a
          >
          <a href="myApplication.html"
            ><span class="material-icons-sharp">receipt</span>
            <h3>My Application</h3></a
          >
          <a href="courses.html"
            ><span class="material-icons-sharp">school</span>
            <h3>Courses</h3></a
          >
          <a href="shop.html"
            ><span class="material-icons-sharp">shopping_cart</span>
            <h3>Shop</h3></a
          >
          <a href="earnings.html"
            ><span class="material-icons-sharp">account_balance</span>
            <h3>Earnings</h3></a
          >
          <a href="documents.html"
            ><span class="material-icons-sharp">file_copy</span>
            <h3>Documents</h3></a
          >
          <a href="settings.html"
            ><span class="material-icons-sharp">settings</span>
            <h3>Settings</h3></a
          >
          <a href="#" id="logout-btn"
            ><span class="material-icons-sharp">logout</span>
            <h3>Logout</h3></a
          >
        </div>
      </aside>
      <!-- End of Sidebar Section -->

      <!-- Main Content -->
      <main>
        <h1>Analytics</h1>

        <!-- Analyses -->
        <div class="analyse">
          <!-- 1) Applied vs Total Jobs Posted -->
          <div class="sales" id="cardApplied">
            <div class="status">
              <div class="info">
                <h3>Jobs Applied</h3>
                <h1 id="appliedCount">0</h1>
                <small class="text-muted" id="appliedCaption"
                  >Applied vs Total Jobs</small
                >
              </div>
              <div class="progresss">
                <svg><circle cx="38" cy="38" r="36"></circle></svg>
                <div class="percentage"><p id="appliedPct">0%</p></div>
              </div>
            </div>
          </div>

          <!-- 2) Approved vs Pending -->
          <div class="visits" id="cardApproved">
            <div class="status">
              <div class="info">
                <h3>Jobs Assigned</h3>
                <h1 id="approvedCount">0</h1>
                <small class="text-muted" id="approvedCaption"
                  >Approved vs Pending</small
                >
              </div>
              <div class="progresss">
                <svg><circle cx="38" cy="38" r="36"></circle></svg>
                <div class="percentage"><p id="approvedPct">0%</p></div>
              </div>
            </div>
          </div>

          <!-- 3) Earning Balance -->
          <div class="searches" id="cardBalance">
            <div class="status">
              <div class="info">
                <h3>Earning Balance</h3>
                <h1 id="balanceAmount">₱0.00</h1>
                <small class="text-muted">Current balance</small>
              </div>
              <div class="progresss">
                <svg><circle cx="38" cy="38" r="36"></circle></svg>
                <div class="percentage"><p id="balancePct">₱0.00</p></div>
              </div>
            </div>
          </div>
        </div>
        <!-- End of Analyses -->

        <!-- New Jobs Posted (last 4 APPROVED only) -->
        <div class="section-header">
          <h2>New Jobs Posted</h2>
          <a class="see-all" href="job.html" title="View all jobs">
            <span class="label">See all</span>
            <span class="material-icons-sharp" aria-hidden="true">arrow_forward</span>
          </a>
        </div>
        <div class="new-users">
          <div class="user-list" id="latestJobsWrap">
            <!-- Filled by JS -->
          </div>
        </div>

        <!-- Recent Orders Table -->
        <div class="recent-orders">
          <h2>Upcoming Work</h2>
          <table>
            <thead>
              <tr>
                <!-- CHANGED: Job Code instead of Job ID -->
                <th>Job Code</th>
                <th>Job Title</th>
                <th>Date/Time</th>
                <th>Location</th>
                <th>Pay</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <a href="#">Show All</a>
        </div>
        <!-- End of Recent Orders -->
      </main>
      <!-- End of Main Content -->

      <!-- Right Section -->
      <div class="right-section">
        <div class="nav">
          <button id="menu-btn">
            <span class="material-icons-sharp"> menu </span>
          </button>

          <!-- Dark mode toggle (persisted via localStorage) -->
          <div class="dark-mode" id="themeToggle" title="Toggle theme">
            <span class="material-icons-sharp" id="lightIcon">light_mode</span>
            <span class="material-icons-sharp" id="darkIcon">dark_mode</span>
          </div>

          <div class="profile">
            <div class="info">
              <p>Hey, <b id="profileName">Installer</b></p>
              <small class="text-muted">User</small>
            </div>
            <div class="profile-photo">
              <!-- will be replaced at runtime with user's photo or initials image -->
              <img id="topRightAvatar" src="images/profile-1.jpg" alt="profile" />
            </div>
          </div>
        </div>
        <!-- End of Nav -->

        <div class="user-profile">
          <div class="logo">
            <h2 id="levelHeading">Level 0</h2>
            <p id="levelNote">Take courses to level up!</p>
          </div>
        </div>

        <div class="reminders">
          <div class="header"><h2>Take Courses</h2></div>

          <!-- (Placeholders removed at runtime) -->

          <!-- Dynamic published courses will be injected above the link below -->
          <a href="#">Show All</a>
        </div>
      </div>
    </div>

    <!-- Shared base scripts -->
    <script src="../../general_files/index.js"></script>
    <script type="module" src="../../general_files/session.js"></script>

    <!-- Supabase UMD -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script type="module">
      const { createClient } = supabase;

      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
      const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      /* ================= Theme ================= */
      const bodyEl = document.body;
      const lightIcon = document.getElementById("lightIcon");
      const darkIcon = document.getElementById("darkIcon");
      const themeToggle = document.getElementById("themeToggle");

      function applySavedTheme() {
        const saved = localStorage.getItem("theme");
        const dark = saved === "dark";
        bodyEl.classList.toggle("dark-mode-variables", dark);
        lightIcon.classList.toggle("active", !dark);
        darkIcon.classList.toggle("active", dark);
      }
      function toggleTheme() {
        const isDark = bodyEl.classList.toggle("dark-mode-variables");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        lightIcon.classList.toggle("active", !isDark);
        darkIcon.classList.toggle("active", isDark);
      }
      themeToggle.addEventListener("click", toggleTheme);
      applySavedTheme();

      /* ================= Helpers ================= */
      const fmtPeso = (n) => {
        const v = typeof n === "string" ? parseFloat(n) : n;
        return isNaN(v)
          ? "0.00"
          : v.toLocaleString("en-PH", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
      };
      function setCircleProgress(circleEl, percent) {
        const r = 36,
          C = 2 * Math.PI * r,
          p = Math.max(0, Math.min(1, percent || 0));
        circleEl.style.strokeDasharray = `${C}`;
        circleEl.style.strokeDashoffset = `${C * (1 - p)}`;
      }
      function publicJobImageUrl(rawPath, postedBy) {
        if (!rawPath) return "";
        if (/^https?:\/\//i.test(rawPath)) return rawPath;
        let clean = String(rawPath)
          .replace(/^\/+/, "")
          .replace(/^jobs\//, "");
        if (clean && !clean.includes("/") && postedBy)
          clean = `${postedBy}/${clean}`;
        const { data } = sb.storage.from("jobs").getPublicUrl(clean);
        return data?.publicUrl || "";
      }
      function timeAgo(isoOrTs) {
        const now = new Date(),
          then = new Date(isoOrTs),
          diffMs = now - then;
        if (isNaN(diffMs)) return "";
        const mins = Math.floor(diffMs / 60000);
        if (mins < 1) return "just now";
        if (mins < 60) return `${mins} min${mins > 1 ? "s" : ""} ago`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return `${hrs} hr${hrs > 1 ? "s" : ""} ago`;
        const days = Math.floor(hrs / 24);
        return `${days} day${days > 1 ? "s" : ""} ago`;
      }
      const esc = (str) =>
        String(str ?? "").replace(/[&<>"']/g, (s) => (
          { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s]
        ));

      /* ===== Avatar helpers (ADDED) ===== */
      const AVATAR_BUCKET = "installer_profile";
      const avatarPathFor = (userId) => `${userId}/avatar.jpg`;

      function parseStorageRef(ref) {
        if (!ref) return null;
        if (ref.startsWith("storage://")) {
          const [, bucket, ...rest] = ref.split("/");
          return { bucket, path: rest.join("/") };
        }
        // /storage/v1/object/public/<bucket>/<path>
        let m = ref.match(/\/storage\/v1\/object\/public\/([^/]+)\/(.+)$/);
        if (m) return { bucket: m[1], path: m[2] };
        // /storage/v1/object/sign/<bucket>/<path>?token=...
        m = ref.match(/\/storage\/v1\/object\/sign\/([^/]+)\/(.+)\?/);
        if (m) return { bucket: m[1], path: m[2] };
        return null;
      }

      async function getSignedAvatarURL(userId, storedUrl) {
        const parsed = parseStorageRef(storedUrl) || { bucket: AVATAR_BUCKET, path: avatarPathFor(userId) };
        try {
          const { data, error } = await sb.storage
            .from(parsed.bucket)
            .createSignedUrl(parsed.path, 60 * 60 * 24); // 24h
          if (error) throw error;
          if (data?.signedUrl) return `${data.signedUrl}&t=${Date.now()}`;
        } catch (e) {
          console.warn("createSignedUrl failed:", e?.message);
        }
        return null;
      }

      function initialsFrom(nameOrEmail) {
        const src = (nameOrEmail || "").trim();
        if (!src) return "U";
        const parts = src.split(/\s+/).filter(Boolean);
        if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        if (parts.length === 1) return parts[0][0].toUpperCase();
        return src[0]?.toUpperCase() || "U";
      }

      function makeInitialsDataURL(nameOrEmail, size = 128) {
        const initials = initialsFrom(nameOrEmail);
        const c = document.createElement("canvas");
        c.width = size; c.height = size;
        const ctx = c.getContext("2d");
        const grd = ctx.createLinearGradient(0, 0, size, size);
        grd.addColorStop(0, "#6c9bcf");
        grd.addColorStop(1, "#1b9c85");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, size, size);

        ctx.fillStyle = "#fff";
        ctx.font = `bold ${Math.floor(size * 0.45)}px Poppins, Arial, sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(initials, size / 2, size / 2 + 2);
        return c.toDataURL("image/png");
      }

      async function setTopRightAvatar(inst) {
        try {
          const img = document.getElementById("topRightAvatar");
          if (!img) return;

          let displayName = inst?.name;
          let email = inst?.email;

          if (!email) {
            const { data: { user } } = await sb.auth.getUser();
            email = user?.email || "";
          }
          if (!displayName) displayName = email || "User";

          // Try signed URL if a storage ref exists
          if (inst?.profile_pic_url && inst?.id) {
            const url = await getSignedAvatarURL(inst.id, inst.profile_pic_url);
            if (url) {
              img.alt = "profile";
              img.src = url;

              // if token ever expires while the page is open:
              let retried = false;
              img.onerror = async () => {
                if (retried) return;
                retried = true;
                const refreshed = await getSignedAvatarURL(inst.id, inst.profile_pic_url);
                if (refreshed) img.src = refreshed;
              };
              return;
            }
          }

          // Fallback to initials data URL (keeps your DOM intact)
          img.alt = "profile";
          img.src = makeInitialsDataURL(displayName || email || "User", 128);
        } catch (e) {
          console.warn("Avatar set error:", e);
        }
      }
      /* ===== End Avatar helpers ===== */

      async function resolveInstaller() {
        const {
          data: { user },
          error: uErr,
        } = await sb.auth.getUser();
        if (uErr) console.warn("auth.getUser error:", uErr);
        const email = user?.email;
        if (!email) return null;

        const { data: inst, error } = await sb
          .from("installer")
          .select('id, email, name, levelstatus, "earningBalance", profile_pic_url') /* ADDED email + profile_pic_url */
          .eq("email", email)
          .maybeSingle();

        if (error) {
          console.warn("installer lookup error", error);
          return null;
        }
        return inst;
      }

      async function fetchCounts(installerId) {
        const { count: totalJobs = 0 } = await sb
          .schema("jobs")
          .from("job")
          .select("job_id", { count: "exact", head: true });
        const { data: apps, error } = await sb
          .schema("jobs")
          .from("job_application")
          .select("status")
          .eq("installer_id", installerId);
        if (error) {
          console.warn("job_application error", error);
          return { totalJobs, applied: 0, approved: 0, pending: 0 };
        }
        const applied = apps?.length || 0;
        let approved = 0,
          pending = 0;
        for (const a of apps || []) {
          const st = String(a.status || "").toLowerCase();
          if (st === "approved") approved++;
          if (st === "pending") pending++;
        }
        return { totalJobs, applied, approved, pending };
      }

      function updateLevelUI({ name, levelstatus, earningBalance }) {
        if (name) document.getElementById("profileName").textContent = name;
        document.getElementById("levelHeading").textContent = `Level ${levelstatus ?? 0}`;
        document.getElementById("levelNote").textContent =
          (levelstatus ?? 0) > 0 ? "Keep going to reach the next level!" : "Take courses to level up!";
        const balText = `₱${fmtPeso(earningBalance ?? 0)}`;
        document.getElementById("balanceAmount").textContent = balText;
        document.getElementById("balancePct").textContent = balText;
        const circle3 = document.querySelector("#cardBalance svg circle");
        setCircleProgress(circle3, (earningBalance ?? 0) > 0 ? 1 : 0);
      }

      function updateAppliedCard({ applied, totalJobs }) {
        document.getElementById("appliedCount").textContent = applied.toLocaleString();
        document.getElementById("appliedCaption").textContent = `Applied vs Total Jobs (${applied}/${totalJobs})`;
        const pct = totalJobs > 0 ? applied / totalJobs : 0;
        document.getElementById("appliedPct").textContent = `${Math.round(pct * 100)}%`;
        const circle1 = document.querySelector("#cardApplied svg circle");
        setCircleProgress(circle1, pct);
      }

      function updateApprovedCard({ approved, pending }) {
        const total = approved + pending;
        document.getElementById("approvedCount").textContent = approved.toLocaleString();
        document.getElementById("approvedCaption").textContent = `Approved vs Pending (${approved}/${pending})`;
        const pct = total > 0 ? approved / total : 0;
        document.getElementById("approvedPct").textContent = `${Math.round(pct * 100)}%`;
        const circle2 = document.querySelector("#cardApproved svg circle");
        setCircleProgress(circle2, pct);
      }

      /* ============= Latest Jobs (APPROVED only & not assigned) ============= */
      let LATEST_IDS = []; // keep track of currently shown job_ids (strings)
      let latestJobsChannel = null;
      let latestRefreshTimer = null;

      function setLatestIdsFrom(jobs) {
        LATEST_IDS = (jobs || []).map((j) => String(j.job_id));
      }

      async function loadLatestJobs() {
        const wrap = document.getElementById("latestJobsWrap");
        wrap.innerHTML = "<p>Loading…</p>";

        // ✅ Only APPROVED and NOT assigned (installer_id_assigned is null)
        const { data: jobs, error } = await sb
          .schema("jobs")
          .from("job")
          .select(
            "job_id, job_title, job_picture_url, posted_by, created_at, job_status, installer_id_assigned"
          )
          .eq("job_status", "approved")
          .is("installer_id_assigned", null)
          .order("created_at", { ascending: false })
          .limit(4);

        if (error) {
          console.error("Latest jobs error:", error);
          wrap.innerHTML = `<p>Could not load latest jobs.</p>`;
          return;
        }

        setLatestIdsFrom(jobs || []);

        if (!jobs || jobs.length === 0) {
          wrap.innerHTML = "<p>No recent approved jobs.</p>";
          return;
        }

        wrap.innerHTML = "";
        for (const j of jobs) {
          const imgUrl =
            publicJobImageUrl(j.job_picture_url, j.posted_by) ||
            "images/profile-4.jpg";
          const a = document.createElement("a");
          a.href = `job.html?job=${encodeURIComponent(j.job_id)}`;
          a.className = "user";
          a.innerHTML = `
            <img src="${imgUrl}" alt="Job image" onerror="this.onerror=null;this.src='images/profile-4.jpg';" />
            <h2 title="${(j.job_title || "").replace(/"/g, "&quot;")}">${j.job_title || "Untitled Job"}</h2>
            <p>${timeAgo(j.created_at)}</p>
          `;
          wrap.appendChild(a);
        }
      }

      function refreshLatestJobsThrottled() {
        clearTimeout(latestRefreshTimer);
        latestRefreshTimer = setTimeout(loadLatestJobs, 300);
      }

      async function ensureRealtimeAuth() {
        const {
          data: { session },
        } = await sb.auth.getSession();
        sb.realtime.setAuth(session?.access_token ?? null);
      }

      function initLatestJobsRealtime() {
        if (latestJobsChannel) return;

        latestJobsChannel = sb
          .channel("dashboard-latest-jobs")
          .on(
            "postgres_changes",
            { event: "*", schema: "jobs", table: "job" },
            (payload) => {
              const ev = payload.eventType;
              const rowNew = payload.new;
              const rowOld = payload.old;
              const idStr = String((rowNew || rowOld)?.job_id ?? "");
              const approvedAndUnassigned =
                rowNew?.job_status === "approved" &&
                (rowNew?.installer_id_assigned === null ||
                  typeof rowNew?.installer_id_assigned === "undefined");

              if (ev === "INSERT") {
                if (approvedAndUnassigned) refreshLatestJobsThrottled();
                return;
              }

              if (ev === "UPDATE") {
                // Became approved & unassigned → refresh
                if (approvedAndUnassigned) {
                  refreshLatestJobsThrottled();
                  return;
                }
                // If it is now NOT eligible (overdue or assigned or not approved) and was visible → refresh
                const notEligible =
                  rowNew?.job_status !== "approved" ||
                  (rowNew?.installer_id_assigned !== null &&
                    typeof rowNew?.installer_id_assigned !== "undefined");
                if (notEligible && LATEST_IDS.includes(idStr)) {
                  refreshLatestJobsThrottled();
                }
                return;
              }

              if (ev === "DELETE") {
                if (LATEST_IDS.includes(idStr)) refreshLatestJobsThrottled();
                return;
              }
            }
          )
          .subscribe(() => {});
      }

      sb.auth.onAuthStateChange((_evt, session) => {
        sb.realtime.setAuth(session?.access_token ?? null);
        if (latestJobsChannel) {
          try {
            sb.removeChannel(latestJobsChannel);
          } catch {}
          latestJobsChannel = null;
        }
        initLatestJobsRealtime();
      });

      /* ============= Upcoming Work (uses job_code) ============= */
      function renderUpcomingWork(rows) {
        const tbody = document.querySelector(".recent-orders tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="5" style="padding:12px;color:#7d8da1;">No approved work yet.</td>`;
          tbody.appendChild(tr);
          return;
        }

        for (const r of rows) {
          const dt =
            (r.job_date
              ? new Date(r.job_date + "T00:00:00").toLocaleDateString()
              : "-") +
            " " +
            (r.job_time ? String(r.job_time).slice(0, 5) : "");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.job_code || "-"}</td>
            <td>${r.job_title || "Untitled Job"}</td>
            <td>${dt}</td>
            <td>${r.job_location || "-"}</td>
            <td>₱${fmtPeso(r.job_pay ?? 0)}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function loadUpcomingWork(installerId) {
        try {
          // 1) Approved applications for this installer
          const { data: apps, error: appErr } = await sb
            .schema("jobs")
            .from("job_application")
            .select("application_id, job_id, status")
            .eq("installer_id", installerId)
            .eq("status", "approved");

          if (appErr) {
            console.warn("Failed to fetch approved applications:", appErr);
            renderUpcomingWork([]);
            return;
          }

          const jobIds = [...new Set((apps || []).map((a) => a.job_id))];
          if (jobIds.length === 0) {
            renderUpcomingWork([]);
            return;
          }

          // 2) Fetch those jobs INCLUDING job_code
          const { data: jobs, error: jobErr } = await sb
            .schema("jobs")
            .from("job")
            .select(
              "job_id, job_code, job_title, job_date, job_time, job_location, job_pay"
            )
            .in("job_id", jobIds);

          if (jobErr) {
            console.warn("Failed to fetch jobs for approved apps:", jobErr);
            renderUpcomingWork([]);
            return;
          }

          // 3) Sort by date/time
          const sorted = (jobs || []).sort((a, b) => {
            const ad = new Date(`${a.job_date || ""}T${a.job_time || "00:00"}`);
            const bd = new Date(`${b.job_date || ""}T${b.job_time || "00:00"}`);
            return ad - bd;
          });

          renderUpcomingWork(sorted);
        } catch (e) {
          console.error("Unexpected error in loadUpcomingWork:", e);
          renderUpcomingWork([]);
        }
      }

      /* ============= Published Courses (dynamic; remove placeholders) ============= */
      function removeCoursePlaceholders() {
        // Remove any static templates that don't have our marker attribute
        document
          .querySelectorAll('.reminders .notification:not([data-course-id])')
          .forEach((el) => el.remove());
      }

      function renderCoursesList(courses) {
        const reminders = document.querySelector(".reminders");
        if (!reminders) return;

        // Insert before the trailing "Show All" link
        const anchor = Array.from(reminders.querySelectorAll("a")).pop() || null;

        // Remove previously injected course rows (only ones we created)
        reminders
          .querySelectorAll('.notification[data-course-id]')
          .forEach((el) => el.remove());

        if (!courses || courses.length === 0) {
          const empty = document.createElement("div");
          empty.className = "notification";
          empty.setAttribute("data-course-id", "empty");
          empty.innerHTML = `
            <div class="icon">
              <span class="material-icons-sharp">menu_book</span>
            </div>
            <div class="content">
              <div class="info">
                <h3>No published courses yet</h3>
                <small class="text_muted">Please check back later</small>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px"
                   viewBox="0 -960 960 960" width="24px" fill="#434343">
                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
              </svg>
            </div>
          `;
          reminders.insertBefore(empty, anchor);
          return;
        }

        for (const c of courses) {
          const row = document.createElement("div");
          row.className = "notification";
          row.setAttribute("data-course-id", c.id);
          row.style.cursor = "pointer";

          const tagsText =
            Array.isArray(c.tags) && c.tags.length
              ? c.tags.slice(0, 3).join(", ")
              : "";

          row.innerHTML = `
            <div class="icon">
              <span class="material-icons-sharp">school</span>
            </div>
            <div class="content">
              <div class="info">
                <h3>${esc(c.title)}</h3>
                <small class="text_muted">
                  Level ${Number.isFinite(c.level) ? c.level : 0}
                  ${tagsText ? " • " + esc(tagsText) : ""}
                </small>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px"
                   viewBox="0 -960 960 960" width="24px" fill="#434343">
                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
              </svg>
            </div>
          `;

          row.addEventListener("click", () => {
            window.location.href = `courses.html?slug=${encodeURIComponent(
              c.slug
            )}`;
          });

          reminders.insertBefore(row, anchor);
        }
      }

      // Completed courses → filter
      async function fetchCompletedCourseIds(installerId) {
        if (!installerId) return [];
        const { data, error } = await sb
          .schema("courses")
          .from("completed_courses")
          .select("course_id")
          .eq("installer_id", installerId);

        if (error) {
          console.warn("Could not load completed courses:", error);
          return [];
        }
        return (data || []).map((r) => r.course_id);
      }

      async function loadPublishedCourses(limit = 6, installerId = null) {
        try {
          const completedIds = await fetchCompletedCourseIds(installerId);
          const fetchCount = limit + (completedIds.length || 0) + 6;

          const { data, error } = await sb
            .schema("courses")
            .from("course")
            .select(
              "id, title, slug, description, level, tags, thumbnail_url, created_at"
            )
            .eq("is_published", true)
            .order("created_at", { ascending: false })
            .limit(fetchCount);

          if (error) {
            console.warn("Could not load published courses:", error);
            renderCoursesList([]);
            return;
          }

          const filtered =
            (data || []).filter((c) => !completedIds.includes(c.id)) || [];

          renderCoursesList(filtered.slice(0, limit));
        } catch (e) {
          console.error("Unexpected error loading courses:", e);
          renderCoursesList([]);
        }
      }

      /* ============= Dashboard boot ============= */
      async function loadDashboard() {
        // Remove the old "Job Title / Job Level to achieve" templates
        removeCoursePlaceholders();

        const inst = await resolveInstaller();
        if (!inst) {
          updateLevelUI({
            name: "Installer",
            levelstatus: 0,
            earningBalance: 0,
          });
          await setTopRightAvatar(null);  /* ADDED: show initials if no installer row */
          updateAppliedCard({ applied: 0, totalJobs: 0 });
          updateApprovedCard({ approved: 0, pending: 0 });
          renderUpcomingWork([]);
          await loadPublishedCourses(6, null);
        } else {
          updateLevelUI(inst);
          await setTopRightAvatar(inst);  /* ADDED: show signed URL or initials */
          const { totalJobs, applied, approved, pending } = await fetchCounts(
            inst.id
          );
          updateAppliedCard({ applied, totalJobs });
          updateApprovedCard({ approved, pending });

          await loadUpcomingWork(inst.id);
          await loadPublishedCourses(6, inst.id);
        }

        await loadLatestJobs();        // recent approved & unassigned jobs (most recent appears left)
        await ensureRealtimeAuth();    // make sure socket token matches
        initLatestJobsRealtime();      // wire realtime
      }

      document.addEventListener("DOMContentLoaded", loadDashboard);
    </script>
  </body>
</html>
