<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <link rel="stylesheet" href="../css_files/sideBar.css" />
  <title>Earnings</title>

  <style>
    :root{
      --ink:#1c2430; --muted:#6c7a8a; --line:#e7edf3; --brand:#20a44c; --danger:#e53935; --warn:#f59e0b;
      --bg:#f8fbfd; --card:#ffffff; --radius:14px;
    }
    body{background:var(--bg);}
    main{ margin-top:1.4rem; }
    .titlePageDiv h1{ color:var(--ink); margin:0 0 .4rem; }
    .titlePageDiv p{ color:var(--muted); margin:0; }

    /* Summary cards */
    .summary-grid{
      margin-top:1rem; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: .9rem;
    }
    @media (max-width:1100px){ .summary-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:580px){ .summary-grid{ grid-template-columns: 1fr; } }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:1rem; display:grid; gap:.3rem; }
    .card .label{ color:var(--muted); font-size:.9rem; }
    .card .value{ color:var(--ink); font-size:1.4rem; font-weight:600; }
    .sub{ color:var(--muted); font-size:.85rem; }
    .bar{ height:8px; border-radius:8px; background:#eef3f7; overflow:hidden; margin-top:.4rem; }
    .bar > span{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), #25c06e); width:0%; transition: width .4s ease; }

    /* Controls */
    .controls{
      margin-top:1rem; display:grid; gap:.6rem; grid-template-columns: 1.2fr repeat(2, .9fr) auto auto; align-items:end;
    }
    @media (max-width:980px){ .controls{ grid-template-columns: 1fr 1fr; } }
    .field{display:grid; gap:.3rem;}
    .field label{font-size:.85rem; color:var(--muted);}
    .field input[type="text"], .field input[type="date"], .field select{
      border:1px solid var(--line); background:#fff; border-radius:10px; padding:.55rem .7rem; outline:none;
    }
    .btn{
      display:inline-grid; grid-auto-flow:column; gap:.4rem; align-items:center; background:var(--ink); color:#fff;
      border:none; border-radius:10px; padding:.6rem .9rem; cursor:pointer;
    }
    .btn.secondary{ background:#1f6d86; }
    .btn.ghost{ background:transparent; color:var(--ink); border:1px solid var(--line); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Tabs */
    .tabs{ margin-top:1.2rem; display:grid; gap:.8rem; }
    .tabbar{ display:grid; grid-auto-flow:column; justify-content:start; gap:.4rem; border-bottom:1px solid var(--line); }
    .tabbar button{
      background:transparent; border:none; padding:.7rem 1rem; cursor:pointer; color:var(--muted);
      border-bottom:3px solid transparent; font-weight:600;
    }
    .tabbar button.active{ color:var(--ink); border-color:var(--brand); }

    /* Tables */
    .tablewrap{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); overflow:auto; }
    table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    thead th{
      text-align:left; background:#fbfdff; color:var(--muted); font-weight:600; position:sticky; top:0; z-index:1;
      border-bottom:1px solid var(--line); padding:.8rem .9rem;
    }
    tbody td{ padding:.75rem .9rem; border-bottom:1px solid #f0f4f7; color:var(--ink); vertical-align:middle; }
    tbody tr:hover{ background:#fcfdfd; }
    .pill{ display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.78rem; font-weight:600; border:1px solid; }
    .pill.paid{ color:#136d3c; border-color:#cfe9db; background:#ecf9f2; }
    .pill.unpaid{ color:#8a2c0f; border-color:#f7d8c6; background:#fff4ec; }
    .pill.approved{ color:#1f4f86; border-color:#cfe0f3; background:#eef5ff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Footer helper box */
    .helper{ margin-top:1rem; padding:1rem; background:#fff; border:1px dashed #d7e3ea; border-radius:12px; color:var(--muted); }
    .helper strong{ color:var(--ink); }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(28,36,48,.22); padding:1rem; z-index: 50; }
    .modal.open{ display:grid; }
    .modal-card{ width:min(720px, 100%); background:#fff; border-radius:16px; border:1px solid var(--line); box-shadow:0 20px 60px rgba(0,0,0,.08); overflow:hidden; }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; padding:1rem 1rem .8rem; border-bottom:1px solid var(--line); }
    .modal-head h3{ margin:0; color:var(--ink); }
    .modal-body{ padding:1rem; display:grid; gap:.6rem; }
    .modal-foot{ padding:1rem; display:flex; justify-content:flex-end; gap:.6rem; border-top:1px solid var(--line); }

    /* Tiny legend */
    .legend{ display:grid; grid-auto-flow:column; gap:1rem; align-items:center; color:var(--muted); font-size:.85rem; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.approved{ background:#20a44c; }
    .dot.pending{ background:#f59e0b; }
    .dot.payouted{ background:#1f6d86; }

    /* Select Mode toolbar (appears when Request Payout is pressed first) */
    .select-toolbar{
      display:none; align-items:center; gap:.8rem; padding:.6rem .8rem; border:1px dashed var(--line);
      border-radius:12px; background:#fff; margin:.6rem 0;
    }
    .select-toolbar.show{ display:flex; }
    .select-toolbar .count{ color:var(--muted); }
    .row-check{ margin-right:.5rem; }
    .row-check[disabled]{ opacity:.45; cursor:not-allowed; }
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar Section (unchanged) -->
    <aside>
      <div class="toggle">
        <div class="logo">
          <img src="../../../img/simpLogo.png" />
          <h2>SIMP<span class="danger">Project</span></h2>
        </div>
        <div class="close" id="close-btn">
          <span class="material-icons-sharp">close</span>
        </div>
      </div>

      <div class="sidebar">
        <a href="dashboard.html">
          <span class="material-icons-sharp">dashboard</span>
          <h3>Dashboard</h3>
        </a>
        <a href="job.html">
          <span class="material-icons-sharp">work</span>
          <h3>Jobs</h3>
        </a>
        <a href="myApplication.html">
          <span class="material-icons-sharp">receipt</span>
          <h3>My Application</h3>
        </a>
        <a href="courses.html">
          <span class="material-icons-sharp">school</span>
          <h3>Courses</h3>
        </a>
        <a href="shop.html">
          <span class="material-icons-sharp">shopping_cart</span>
          <h3>Shop</h3>
        </a>
        <a href="earnings.html" class="active">
          <span class="material-icons-sharp">account_balance</span>
          <h3>Earnings</h3>
        </a>
        <a href="documents.html">
          <span class="material-icons-sharp">file_copy</span>
          <h3>Documents</h3>
        </a>
        <a href="settings.html">
          <span class="material-icons-sharp">settings</span>
          <h3>Settings</h3>
        </a>
        <a href="#" id="logout-btn">
          <span class="material-icons-sharp">logout</span>
          <h3>Logout</h3>
        </a>
      </div>
    </aside>
    <!-- End of Sidebar Section -->

    <!-- MAIN CONTENT -->
    <main>
      <div class="titlePageDiv">
        <h1>See all your earnings in one place.</h1>
        <p>View your income details and payout status below.</p>
      </div>

      <!-- ===== Payments Summary (live from earnings.payments x jobs.job) ===== -->
      <section class="summary-grid" id="payments-summary">
        <div class="card">
          <div class="label">Total Payments that are approved by admin but don't payout yet (to payout) — Balance</div>
          <div class="value" id="sum-approved-balance">₱0.00</div>
          <div class="sub">Filter: <code>earnings.payments.payment_status = 'paid'</code></div>
          <div class="bar"><span id="bar-approved"></span></div>
        </div>
        <div class="card">
          <div class="label">Total Payments that are pending because the job is not yet done (assigned to installer)</div>
          <div class="value" id="sum-pending">₱0.00</div>
          <div class="sub">Filter: <code>earnings.payments.payment_status = 'unpaid'</code></div>
          <div class="bar"><span id="bar-pending"></span></div>
        </div>
        <div class="card">
          <div class="label">Total Payments that are already payouted</div>
          <div class="value" id="sum-payouted">₱0.00</div>
          <div class="sub">Filter: <code>earnings.payments.payment_status = 'payouted'</code></div>
          <div class="bar"><span id="bar-payouted"></span></div>
        </div>
        <div class="card">
          <div class="label">Legend</div>
          <div class="legend">
            <span><span class="dot approved"></span> Approved (to payout)</span>
            <span><span class="dot pending"></span> Pending (unpaid)</span>
            <span><span class="dot payouted"></span> Payouted</span>
          </div>
          <div class="sub">Amounts use <code>jobs.job.job_pay</code> via <code>earnings.payments.job_id</code>.</div>
        </div>
      </section>

      <!-- ===== Controls ===== -->
      <section class="controls">
        <div class="field">
          <label for="search">Search (code, title)</label>
          <input type="text" id="search" placeholder="e.g. JOB-2025-001, CCTV install..." />
        </div>
        <div class="field">
          <label for="dateFrom">From</label>
          <input type="date" id="dateFrom" />
        </div>
        <div class="field">
          <label for="dateTo">To</label>
          <input type="date" id="dateTo" />
        </div>

        <button class="btn" id="btnExport">
          <span class="material-icons-sharp">file_download</span> Export CSV
        </button>
        <button class="btn secondary" id="btnRequestPayout">
          <span class="material-icons-sharp">payments</span> Request Payout
        </button>
      </section>

      <!-- ===== Tabs and Tables ===== -->
      <section class="tabs">
        <div class="tabbar">
          <button class="active" data-tab="unpaid">Unpaid / Approved (not yet payouted)</button>
          <button data-tab="paid">Payouted</button>
        </div>

        <!-- Select toolbar (only shows in Select Mode on the Unpaid tab) -->
        <div id="selectToolbar" class="select-toolbar" aria-live="polite">
          <label><input type="checkbox" id="chkSelectAll" /> Select All</label>
          <span class="count" id="selCount">0 selected</span>
          <span class="sub">Tip: Only <strong>Approved</strong> rows (status <code>paid</code>) are eligible.</span>
        </div>

        <!-- Unpaid & Approved -->
        <div class="tablewrap" id="tab-unpaid">
          <table>
            <thead>
              <tr>
                <th>Job Code</th>
                <th>Title</th>
                <th>Date</th>
                <th class="mono">Amount (₱)</th>
                <th>Status</th>
                <th style="width:1%; white-space:nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody-unpaid"></tbody>
          </table>
        </div>

        <!-- Payouted -->
        <div class="tablewrap" id="tab-paid" style="display:none;">
          <table>
            <thead>
              <tr>
                <th>Job Code</th>
                <th>Title</th>
                <th>Date</th>
                <th class="mono">Amount (₱)</th>
                <th>Status</th>
                <th>Payout Ref</th>
              </tr>
            </thead>
            <tbody id="tbody-paid"></tbody>
          </table>
        </div>
      </section>

      <div class="helper" id="helperBox">
        <strong>Tip:</strong> Sign in to your Supabase session, or pass <code>?installer=&lt;uuid&gt;</code> in the URL to view a specific installer. Export respects current filters.
      </div>
    </main>
  </div>

  <!-- ===== Request Payout Modal ===== -->
  <div class="modal" id="modalPayout">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Request Payout</h3>
        <button class="btn ghost" id="closeModal"><span class="material-icons-sharp">close</span> Close</button>
      </div>
      <div class="modal-body">
        <div class="sub">You’re requesting a payout for your <strong>selected</strong> Approved jobs.</div>

        <div class="card" style="grid-template-columns:1fr 1fr; gap:.6rem;">
          <div>
            <div class="label">Eligible Total (selected)</div>
            <div class="value" id="modal-eligible">₱0.00</div>
            <div class="sub">Threshold: ₱1,000.00</div>
          </div>
          <div>
            <div class="label">Payout Method</div>
            <div class="value" id="modal-method">GCash (** 1123)</div>
            <div class="sub">Change in Settings → Payouts</div>
          </div>
        </div>

        <div class="sub" id="modal-note" style="margin-top:.3rem;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelPayout">Cancel</button>
        <button class="btn" id="confirmPayout"><span class="material-icons-sharp">check_circle</span> Confirm Request</button>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- (Optional) your global scripts -->
  <script src="../../general_files/index.js"></script>
  <script type="module" src="../../general_files/session.js"></script>

  <!-- Main Page Logic -->
  <script type="module">
    // ========= CONFIG =========
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../../../supabase.js";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= STATE =========
    let JOBS = [];      // [{ job_id, job_code, job_title, job_pay, job_date }]
    let PAYMENTS = [];  // [{ id, installer_id, job_id, payment_status, first_created_at, updated_at }]
    let EARNINGS = [];  // UI rows

    // Select Mode
    let SELECT_MODE = false;
    const SELECTED = new Set(); // payment ids
    const ELIGIBLE = new Set(); // ids eligible to select (payment_status === 'paid')

    // ========= ELEMS =========
    const CURRENCY = '₱';
    const PAYOUT_METHOD = 'GCash (** 1123)';  // replace from settings
    const PAYOUT_THRESHOLD = 1000;

    // Summary
    const sumApprovedBalanceEl = document.getElementById('sum-approved-balance');
    const sumPendingEl = document.getElementById('sum-pending');
    const sumPayoutedEl = document.getElementById('sum-payouted');
    const barApproved = document.getElementById('bar-approved');
    const barPending = document.getElementById('bar-pending');
    const barPayouted = document.getElementById('bar-payouted');

    // Tables / controls / modal
    const tbodyUnpaid = document.getElementById('tbody-unpaid');
    const tbodyPaid = document.getElementById('tbody-paid');
    const searchEl = document.getElementById('search');
    const dateFromEl = document.getElementById('dateFrom');
    const dateToEl = document.getElementById('dateTo');
    const btnExport = document.getElementById('btnExport');
    const tabs = document.querySelectorAll('.tabbar button');
    const tabUnpaidWrap = document.getElementById('tab-unpaid');
    const tabPaidWrap = document.getElementById('tab-paid');
    const helperBox = document.getElementById('helperBox');

    const modal = document.getElementById('modalPayout');
    const btnRequestPayout = document.getElementById('btnRequestPayout');
    const closeModal = document.getElementById('closeModal');
    const cancelPayout = document.getElementById('cancelPayout');
    const confirmPayout = document.getElementById('confirmPayout');
    const modalEligible = document.getElementById('modal-eligible');
    const modalMethod = document.getElementById('modal-method');
    const modalNote = document.getElementById('modal-note');

    // Select toolbar
    const selectToolbar = document.getElementById('selectToolbar');
    const chkSelectAll = document.getElementById('chkSelectAll');
    const selCount = document.getElementById('selCount');

    // ========= UTILS =========
    const fmt = (n)=> CURRENCY + (Number(n)||0).toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2});
    const inRange = (d, from, to)=>{
      if(!from && !to) return true;
      const x = new Date(d).setHours(0,0,0,0);
      if(from && x < new Date(from).setHours(0,0,0,0)) return false;
      if(to && x > new Date(to).setHours(0,0,0,0)) return false;
      return true;
    };

    async function getInstallerId(){
      const param = new URLSearchParams(location.search).get('installer');
      if (param) return param;
      const { data: { session } } = await supabase.auth.getSession();
      return session?.user?.id ?? null;
    }

    // ========= DATA LOAD =========
    async function loadFromSupabase(installerId){
      const { data: payments, error: payErr } = await supabase
        .schema("earnings")
        .from('payments')
        .select('id, installer_id, job_id, payment_status, first_created_at, updated_at')
        .eq('installer_id', installerId);

      if (payErr) throw payErr;

      const jobIds = Array.from(new Set((payments || []).map(p=>p.job_id)));
      let jobs = [];
      if (jobIds.length){
        const { data: jobRows, error: jobErr } = await supabase
          .schema("jobs")
          .from('job')
          .select('job_id, job_code, job_title, job_pay, job_date')
          .in('job_id', jobIds);
        if (jobErr) throw jobErr;
        jobs = jobRows || [];
      }

      // Build maps & UI rows
      const jobById = new Map(jobs.map(j=>[j.job_id, j]));

      EARNINGS = (payments || []).map(p=>{
        const j = jobById.get(p.job_id) || {};
        const uiStatus =
          p.payment_status === 'payouted'       ? 'paid' :
          p.payment_status === 'paid'           ? 'approved' :
          p.payment_status === 'pending_payout' ? 'approved' :
                                                  'unpaid';

        return {
          payment_id: p.id,
          payment_status: p.payment_status,
          job_id: p.job_id,
          code: j.job_code || '—',
          title: j.job_title || '—',
          date: j.job_date || null,
          amount: Number(j.job_pay) || 0,
          status: uiStatus,
          paid_ref: p.payment_status === 'payouted' ? (p.id || '').slice(0,8).toUpperCase() : null,
          updated_at: p.updated_at
        };
      });

      JOBS = jobs;
      PAYMENTS = payments || [];

      // Eligibility set (only exact 'paid' may be requested)
      ELIGIBLE.clear();
      for (const p of PAYMENTS){
        if (p.payment_status === 'paid') ELIGIBLE.add(p.id);
      }
    }

    // ========= SUMMARY =========
    function computePaymentsSummary(){
      const jobById = new Map(JOBS.map(j=>[j.job_id, j]));
      const sums = { unpaid:0, paid:0, payouted:0 };

      for (const p of PAYMENTS){
        const j = jobById.get(p.job_id);
        if (!j) continue;
        const amt = Number(j.job_pay) || 0;
        if (p.payment_status === 'unpaid') sums.unpaid += amt;
        else if (p.payment_status === 'paid') sums.paid += amt;        // approved, not payouted
        else if (p.payment_status === 'payouted') sums.payouted += amt;
      }

      const total = (sums.unpaid + sums.paid + sums.payouted) || 1;

      sumApprovedBalanceEl.textContent = fmt(sums.paid);
      sumPendingEl.textContent = fmt(sums.unpaid);
      sumPayoutedEl.textContent = fmt(sums.payouted);

      barApproved.style.width = (sums.paid / total * 100).toFixed(1) + '%';
      barPending.style.width = (sums.unpaid / total * 100).toFixed(1) + '%';
      barPayouted.style.width = (sums.payouted / total * 100).toFixed(1) + '%';
    }

    // ========= TABLES =========
    function rowHTML(r){
      let pill = '';
      if (r.status === 'paid') pill = '<span class="pill paid">Paid</span>';
      else if (r.status === 'approved') pill = '<span class="pill approved">Approved</span>';
      else pill = '<span class="pill unpaid">Unpaid</span>';

      const canSelect = ELIGIBLE.has(r.payment_id);
      const checkHTML = SELECT_MODE
        ? `<input type="checkbox" class="row-check" data-payid="${r.payment_id}" ${canSelect ? '' : 'disabled title="Only Approved rows are eligible"'} ${SELECTED.has(r.payment_id)?'checked':''}/>`
        : '';

      return `
        <tr data-payid="${r.payment_id}">
          <td class="mono">${checkHTML}${r.code}</td>
          <td>${r.title}</td>
          <td>${r.date ? new Date(r.date).toLocaleDateString('en-PH', {year:'numeric', month:'short', day:'numeric'}) : '—'}</td>
          <td class="mono">${fmt(r.amount)}</td>
          <td>${pill}</td>
          ${
            r.status==='paid'
              ? `<td class="mono">${r.paid_ref ?? '-'}</td>`
              : `<td><button class="btn ghost" data-invoice="${r.code}"><span class="material-icons-sharp">picture_as_pdf</span> Invoice</button></td>`
          }
        </tr>
      `;
    }

    function applyFilters(){
      const q = (searchEl.value || '').trim().toLowerCase();
      const f = dateFromEl.value || null;
      const t = dateToEl.value || null;

      const filtered = EARNINGS.filter(e=>{
        const hay = [e.code, e.title].join(' ').toLowerCase();
        const hit = hay.includes(q);
        const okDate = e.date ? inRange(e.date, f, t) : true;
        return hit && okDate;
      });

      // Not payouted = unpaid + approved
      const notPayouted = filtered.filter(r => r.status === 'unpaid' || r.status === 'approved');
      tbodyUnpaid.innerHTML = notPayouted.length
        ? notPayouted.map(rowHTML).join('')
        : `<tr><td colspan="6" class="sub" style="padding:1rem;">No records match your filters.</td></tr>`;

      // Payouted
      const payoutedRows = filtered.filter(r => r.status === 'paid');
      tbodyPaid.innerHTML = payoutedRows.length
        ? payoutedRows.map(rowHTML).join('')
        : `<tr><td colspan="6" class="sub" style="padding:1rem;">No payouted records match your filters.</td></tr>`;

      updatePayoutButton(notPayouted);
      updateSelectToolbarCount();
      wireRowCheckboxes();
    }

    function updatePayoutButton(rows){
      const eligible = rows.reduce((s,r)=>s+r.amount,0);
      document.getElementById('btnRequestPayout').title =
        SELECT_MODE
          ? 'Review selected items'
          : (eligible < PAYOUT_THRESHOLD
                ? `Need at least ${fmt(PAYOUT_THRESHOLD)} to request payout`
                : 'Select which jobs to include in this payout');
    }

    function exportCSV(){
      const activeTab = document.querySelector('.tabbar button.active').dataset.tab;
      const tableBody = (activeTab === 'unpaid') ? tbodyUnpaid : tbodyPaid;

      const rows = Array.from(tableBody.querySelectorAll('tr'))
        .filter(tr => tr.querySelector('td'));

      const headers = (activeTab==='unpaid')
        ? ['Job Code','Title','Date','Amount','Status']
        : ['Job Code','Title','Date','Amount','Status','Payout Ref'];

      const records = rows.map(tr=>{
        const cells = Array.from(tr.querySelectorAll('td'));
        const text = cells.map(td => td.innerText.replace(/\n/g,' ').trim());
        if (activeTab==='unpaid') text.pop(); // drop actions
        return text;
      });

      const csv = [headers, ...records]
        .map(r => r.map(v => {
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(','))
        .join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `earnings_${activeTab}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ========= MODAL & REQUEST FLOW =========
    function openPayout(){
      // First click → enter Select Mode
      if (!SELECT_MODE){
        setSelectMode(true);
        btnRequestPayout.innerHTML = '<span class="material-icons-sharp">playlist_add_check</span> Review Selection';
        helperBox.innerHTML = `<strong>Select Mode:</strong> Choose the approved jobs to include, then click <em>Review Selection</em>.`;
        return;
      }

      // Second click → review selection in modal
      const chosen = EARNINGS.filter(r => SELECTED.has(r.payment_id));
      const eligibleChosen = chosen.filter(r => ELIGIBLE.has(r.payment_id)); // safety
      const total = eligibleChosen.reduce((s,r)=>s + (Number(r.amount)||0), 0);

      modalEligible.textContent = fmt(total);
      modalMethod.textContent = PAYOUT_METHOD;

      if (eligibleChosen.length === 0){
        modalNote.textContent = `No eligible (Approved) rows selected. Select at least one to proceed.`;
        confirmPayout.disabled = true;
      } else if (total < PAYOUT_THRESHOLD){
        modalNote.textContent = `You currently don't meet the payout threshold of ${fmt(PAYOUT_THRESHOLD)} for the selected items.`;
        confirmPayout.disabled = true;
      } else {
        modalNote.textContent = `A payout request will be created for ${eligibleChosen.length} job(s). You’ll see them move to “pending_payout”.`;
        confirmPayout.disabled = false;
      }

      modal.classList.add('open');
    }
    function closePayout(){ modal.classList.remove('open'); }
    async function confirmPayoutRequest(){
      // Update selected eligible rows to pending_payout
      const ids = Array.from(SELECTED).filter(id => ELIGIBLE.has(id));
      if (!ids.length) return;

      confirmPayout.disabled = true;
      confirmPayout.innerHTML = '<span class="material-icons-sharp">hourglass_top</span> Working...';

      try{
        const { error } = await supabase
          .schema('earnings')
          .from('payments')
          .update({ payment_status: 'pending_payout' })
          .in('id', ids);
        if (error) throw error;

        // Mutate local PAYMENTS and derived EARNINGS
        for (const p of PAYMENTS){
          if (ids.includes(p.id)) p.payment_status = 'pending_payout';
        }
        EARNINGS = EARNINGS.map(r => ids.includes(r.payment_id)
          ? { ...r, payment_status: 'pending_payout', status: 'approved' }
          : r
        );

        // Recompute eligibility (pending_payout is no longer eligible)
        ELIGIBLE.clear();
        for (const p of PAYMENTS){
          if (p.payment_status === 'paid') ELIGIBLE.add(p.id);
        }

        // Exit select mode, refresh UI
        setSelectMode(false);
        btnRequestPayout.innerHTML = '<span class="material-icons-sharp">payments</span> Request Payout';
        computePaymentsSummary();
        applyFilters();
        closePayout();
        alert(`Request submitted for ${ids.length} job(s).`);
      }catch(err){
        console.error(err);
        alert('Failed to submit payout request: ' + (err?.message || 'Unknown error'));
      }finally{
        confirmPayout.disabled = false;
        confirmPayout.innerHTML = '<span class="material-icons-sharp">check_circle</span> Confirm Request';
      }
    }

    // ========= SELECT MODE =========
    function setSelectMode(on){
      SELECT_MODE = !!on;
      if (!SELECT_MODE){
        SELECTED.clear();
        chkSelectAll.checked = false;
        selectToolbar.classList.remove('show');
        helperBox.innerHTML = `<strong>Tip:</strong> Sign in to your Supabase session, or pass <code>?installer=&lt;uuid&gt;</code> in the URL to view a specific installer. Export respects current filters.`;
      } else {
        selectToolbar.classList.add('show');
      }
      applyFilters();
    }

    function updateSelectToolbarCount(){
      selCount.textContent = `${SELECTED.size} selected`;
    }

    function wireRowCheckboxes(){
      if (!SELECT_MODE) return;
      // Only in Unpaid tab
      tbodyUnpaid.querySelectorAll('.row-check').forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const id = chk.getAttribute('data-payid');
          if (!id || chk.disabled) return;
          if (chk.checked) SELECTED.add(id);
          else SELECTED.delete(id);
          updateSelectToolbarCount();
        });
      });
    }

    chkSelectAll.addEventListener('change', ()=>{
      if (!SELECT_MODE) return;
      SELECTED.clear();
      tbodyUnpaid.querySelectorAll('.row-check').forEach(chk=>{
        if (!chk.disabled){
          chk.checked = chkSelectAll.checked;
          if (chk.checked){
            const id = chk.getAttribute('data-payid');
            if (id) SELECTED.add(id);
          }
        }
      });
      updateSelectToolbarCount();
    });

    // ========= EVENTS =========
    document.getElementById('btnExport').addEventListener('click', exportCSV);

    searchEl.addEventListener('input', applyFilters);
    dateFromEl.addEventListener('change', applyFilters);
    dateToEl.addEventListener('change', applyFilters);

    tabs.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const tab = b.dataset.tab;
        if(tab==='unpaid'){
          tabUnpaidWrap.style.display='block';
          tabPaidWrap.style.display='none';
          selectToolbar.style.display = SELECT_MODE ? 'flex' : 'none';
        } else {
          tabUnpaidWrap.style.display='none';
          tabPaidWrap.style.display='block';
          selectToolbar.style.display = 'none';
        }
      });
    });

    btnRequestPayout.addEventListener('click', openPayout);
    closeModal.addEventListener('click', closePayout);
    cancelPayout.addEventListener('click', closePayout);
    confirmPayout.addEventListener('click', confirmPayoutRequest);

    // Invoice button (hook)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-invoice]');
      if(!btn) return;
      const code = btn.getAttribute('data-invoice');
      alert('Generate/Download invoice for ' + code);
    });

    // ========= INIT =========
    (async function init(){
      try{
        const installerId = await getInstallerId();
        if (!installerId){
          helperBox.innerHTML = `<strong>Heads up:</strong> No installer ID found. Sign in or append <code>?installer=&lt;uuid&gt;</code> to the URL.`;
        } else {
          helperBox.innerHTML = `<strong>Viewing installer:</strong> <code>${installerId}</code>`;
          await loadFromSupabase(installerId);
        }
      } catch (err){
        console.error(err);
        helperBox.innerHTML = `<strong>Error:</strong> ${err.message || err}`;
      } finally {
        computePaymentsSummary();
        applyFilters();
      }
    })();
  </script>
</body>
</html>
