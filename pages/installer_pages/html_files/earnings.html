<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <link rel="stylesheet" href="../css_files/sideBar.css" />
  <title>Earnings</title>
  <style>
    :root{
      --ink:#1c2430; --muted:#6c7a8a; --line:#e7edf3; --brand:#20a44c; --danger:#e53935; --warn:#f59e0b;
      --bg:#f8fbfd; --card:#ffffff; --radius:14px;
    }
    body{background:var(--bg);}
    main{ margin-top:1.4rem; }
    .titlePageDiv h1{ color:var(--ink); margin:0 0 .4rem; }
    .titlePageDiv p{ color:var(--muted); margin:0; }

    /* Summary cards */
    .summary-grid{
      margin-top:1rem;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: .9rem;
    }
    @media (max-width:1100px){ .summary-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:580px){ .summary-grid{ grid-template-columns: 1fr; } }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:1rem;
      display:grid; gap:.3rem;
    }
    .card .label{ color:var(--muted); font-size:.9rem; }
    .card .value{ color:var(--ink); font-size:1.4rem; font-weight:600; }
    .sub{ color:var(--muted); font-size:.85rem; }

    .bar{
      height:8px; border-radius:8px; background:#eef3f7; overflow:hidden; margin-top:.4rem;
    }
    .bar > span{
      display:block; height:100%; background:linear-gradient(90deg, var(--brand), #25c06e);
      width:0%;
      transition: width .4s ease;
    }

    /* Controls */
    .controls{
      margin-top:1rem; display:grid; gap:.6rem;
      grid-template-columns: 1.2fr repeat(2, .9fr) auto auto;
      align-items:end;
    }
    @media (max-width:980px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    .field{display:grid; gap:.3rem;}
    .field label{font-size:.85rem; color:var(--muted);}
    .field input[type="text"], .field input[type="date"], .field select{
      border:1px solid var(--line); background:#fff; border-radius:10px; padding:.55rem .7rem; outline:none;
    }
    .btn{
      display:inline-grid; grid-auto-flow:column; gap:.4rem; align-items:center;
      background:var(--ink); color:#fff; border:none; border-radius:10px; padding:.6rem .9rem; cursor:pointer;
    }
    .btn.secondary{ background:#1f6d86; }
    .btn.ghost{ background:transparent; color:var(--ink); border:1px solid var(--line); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Tabs */
    .tabs{ margin-top:1.2rem; display:grid; gap:.8rem; }
    .tabbar{
      display:grid; grid-auto-flow:column; justify-content:start; gap:.4rem;
      border-bottom:1px solid var(--line);
    }
    .tabbar button{
      background:transparent; border:none; padding:.7rem 1rem; cursor:pointer; color:var(--muted);
      border-bottom:3px solid transparent; font-weight:600;
    }
    .tabbar button.active{
      color:var(--ink); border-color:var(--brand);
    }

    /* Tables */
    .tablewrap{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    thead th{
      text-align:left; background:#fbfdff; color:var(--muted); font-weight:600;
      position:sticky; top:0; z-index:1;
      border-bottom:1px solid var(--line);
      padding:.8rem .9rem;
    }
    tbody td{
      padding:.75rem .9rem; border-bottom:1px solid #f0f4f7; color:var(--ink);
      vertical-align:middle;
    }
    tbody tr:hover{ background:#fcfdfd; }
    .pill{
      display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.78rem; font-weight:600;
      border:1px solid;
    }
    .pill.paid{ color:#136d3c; border-color:#cfe9db; background:#ecf9f2; }
    .pill.unpaid{ color:#8a2c0f; border-color:#f7d8c6; background:#fff4ec; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Footer helper box */
    .helper{
      margin-top:1rem; padding:1rem; background:#fff; border:1px dashed #d7e3ea; border-radius:12px; color:var(--muted);
    }
    .helper strong{ color:var(--ink); }

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(28,36,48,.22);
      padding:1rem; z-index: 50;
    }
    .modal.open{ display:grid; }
    .modal-card{
      width:min(720px, 100%); background:#fff; border-radius:16px; border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .modal-head{
      display:flex; justify-content:space-between; align-items:center; padding:1rem 1rem .8rem; border-bottom:1px solid var(--line);
    }
    .modal-head h3{ margin:0; color:var(--ink); }
    .modal-body{ padding:1rem; display:grid; gap:.6rem; }
    .modal-foot{ padding:1rem; display:flex; justify-content:flex-end; gap:.6rem; border-top:1px solid var(--line); }
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar Section (unchanged) -->
    <aside>
      <div class="toggle">
        <div class="logo">
          <img src="../../../img/simpLogo.png" />
          <h2>SIMP<span class="danger">Project</span></h2>
        </div>
        <div class="close" id="close-btn">
          <span class="material-icons-sharp">close</span>
        </div>
      </div>

      <div class="sidebar">
        <a href="dashboard.html">
          <span class="material-icons-sharp">dashboard</span>
          <h3>Dashboard</h3>
        </a>
        <a href="job.html">
          <span class="material-icons-sharp">work</span>
          <h3>Jobs</h3>
        </a>
        <a href="myApplication.html">
          <span class="material-icons-sharp">receipt</span>
          <h3>My Application</h3>
        </a>
        <a href="courses.html">
          <span class="material-icons-sharp">school</span>
          <h3>Courses</h3>
        </a>
        <a href="shop.html">
          <span class="material-icons-sharp">shopping_cart</span>
          <h3>Shop</h3>
        </a>
        <a href="earnings.html" class="active">
          <span class="material-icons-sharp">account_balance</span>
          <h3>Earnings</h3>
        </a>
        <a href="documents.html">
          <span class="material-icons-sharp">file_copy</span>
          <h3>Documents</h3>
        </a>
        <a href="settings.html">
          <span class="material-icons-sharp">settings</span>
          <h3>Settings</h3>
        </a>
        <a href="#" id="logout-btn">
          <span class="material-icons-sharp">logout</span>
          <h3>Logout</h3>
        </a>
      </div>
    </aside>
    <!-- End of Sidebar Section -->

    <!-- MAIN CONTENT -->
    <main>
      <div class="titlePageDiv">
        <h1>See all your earnings in one place.</h1>
        <p>View your income details and payout status below.</p>
      </div>

      <!-- Earnings Summary -->
      <section class="summary-grid" id="summary">
        <div class="card">
          <div class="label">Total Earnings</div>
          <div class="value" id="sum-total">₱0.00</div>
          <div class="sub">All time (paid + unpaid)</div>
          <div class="bar"><span id="bar-total"></span></div>
        </div>
        <div class="card">
          <div class="label">Paid Out</div>
          <div class="value" id="sum-paid">₱0.00</div>
          <div class="sub"><span id="count-paid">0</span> jobs paid</div>
          <div class="bar"><span id="bar-paid"></span></div>
        </div>
        <div class="card">
          <div class="label">Unpaid (to collect)</div>
          <div class="value" id="sum-unpaid">₱0.00</div>
          <div class="sub"><span id="count-unpaid">0</span> jobs pending</div>
          <div class="bar"><span id="bar-unpaid"></span></div>
        </div>
        <div class="card">
          <div class="label">Next Payout (est.)</div>
          <div class="value" id="next-payout">—</div>
          <div class="sub">Method: <strong id="payout-method">GCash (**** 1123)</strong></div>
        </div>
      </section>

      <!-- Controls -->
      <section class="controls">
        <div class="field">
          <label for="search">Search (code, title, client)</label>
          <input type="text" id="search" placeholder="e.g. JOB-2025-001, ACME, CCTV install...">
        </div>
        <div class="field">
          <label for="dateFrom">From</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="field">
          <label for="dateTo">To</label>
          <input type="date" id="dateTo">
        </div>
        <button class="btn" id="btnExport"><span class="material-icons-sharp">file_download</span> Export CSV</button>
        <button class="btn secondary" id="btnRequestPayout"><span class="material-icons-sharp">payments</span> Request Payout</button>
      </section>

      <!-- Tabs -->
      <section class="tabs">
        <div class="tabbar">
          <button class="active" data-tab="unpaid">Unpaid Jobs</button>
          <button data-tab="paid">Paid Jobs</button>
        </div>

        <!-- Unpaid Table -->
        <div class="tablewrap" id="tab-unpaid">
          <table>
            <thead>
              <tr>
                <th>Job Code</th>
                <th>Title</th>
                <th>Date</th>
                <th>Client</th>
                <th class="mono">Amount (₱)</th>
                <th>Status</th>
                <th style="width:1%; white-space:nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody-unpaid"></tbody>
          </table>
        </div>

        <!-- Paid Table -->
        <div class="tablewrap" id="tab-paid" style="display:none;">
          <table>
            <thead>
              <tr>
                <th>Job Code</th>
                <th>Title</th>
                <th>Date</th>
                <th>Client</th>
                <th class="mono">Amount (₱)</th>
                <th>Status</th>
                <th>Payout Ref</th>
              </tr>
            </thead>
            <tbody id="tbody-paid"></tbody>
          </table>
        </div>
      </section>

      <!-- Helpful tips -->
      <div class="helper">
        <strong>Pro tip:</strong> Use the date range and search to narrow results. “Export CSV” downloads only the rows that match your current filters. Connect payout details in <em>Settings → Payouts</em> to change your preferred method.
      </div>
    </main>
  </div>

  <!-- Request Payout Modal -->
  <div class="modal" id="modalPayout">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Request Payout</h3>
        <button class="btn ghost" id="closeModal"><span class="material-icons-sharp">close</span> Close</button>
      </div>
      <div class="modal-body">
        <div class="sub">You’re requesting a payout for current <strong>unpaid</strong> jobs that meet your payout rules (e.g., completed & approved).</div>
        <div class="card" style="grid-template-columns:1fr 1fr; gap:.6rem;">
          <div>
            <div class="label">Eligible Unpaid Total</div>
            <div class="value" id="modal-eligible">₱0.00</div>
            <div class="sub">Threshold: ₱1,000.00</div>
          </div>
          <div>
            <div class="label">Payout Method</div>
            <div class="value" id="modal-method">GCash (**** 1123)</div>
            <div class="sub">Change in Settings → Payouts</div>
          </div>
        </div>
        <div class="sub" id="modal-note" style="margin-top:.3rem;"></div>
      </div>
      <div class="modal-foot">
        <button class="btn ghost" id="cancelPayout">Cancel</button>
        <button class="btn" id="confirmPayout"><span class="material-icons-sharp">check_circle</span> Confirm Request</button>
      </div>
    </div>
  </div>

  <script>
    // -------- Demo data (replace with API fetch) --------
    /** Each item represents a job earning.
     * status: 'paid' | 'unpaid'
     * paid_ref present only when paid
     */
    const EARNINGS = [
      { code:'JOB-2025-001', title:'CCTV Install – Warehouse', date:'2025-08-26', client:'ACME Foods', amount: 5200, status:'paid', paid_ref:'P-8Y29KJ', updated_at:'2025-08-28' },
      { code:'JOB-2025-002', title:'Door Access – Office B', date:'2025-08-29', client:'Nordic Labs', amount: 3100, status:'unpaid', updated_at:'2025-08-30' },
      { code:'JOB-2025-003', title:'Network Setup – Branch 3', date:'2025-08-30', client:'EduTech PH', amount: 4500, status:'paid', paid_ref:'P-8Y30ZZ', updated_at:'2025-08-31' },
      { code:'JOB-2025-004', title:'CCTV Maintenance', date:'2025-09-01', client:'Cafe Uno', amount: 1600, status:'unpaid', updated_at:'2025-09-01' },
      { code:'JOB-2025-005', title:'Home Automation – Lights', date:'2025-09-02', client:'Ramos Residence', amount: 3800, status:'unpaid', updated_at:'2025-09-02' }
    ];
    const CURRENCY = '₱';
    const PAYOUT_METHOD = 'GCash (**** 1123)';
    const PAYOUT_THRESHOLD = 1000; // demo

    // -------- Elements --------
    const sumTotalEl = document.getElementById('sum-total');
    const sumPaidEl = document.getElementById('sum-paid');
    const sumUnpaidEl = document.getElementById('sum-unpaid');
    const countPaidEl = document.getElementById('count-paid');
    const countUnpaidEl = document.getElementById('count-unpaid');
    const nextPayoutEl = document.getElementById('next-payout');
    const payoutMethodEl = document.getElementById('payout-method');

    const barTotal = document.getElementById('bar-total');
    const barPaid = document.getElementById('bar-paid');
    const barUnpaid = document.getElementById('bar-unpaid');

    const tbodyUnpaid = document.getElementById('tbody-unpaid');
    const tbodyPaid = document.getElementById('tbody-paid');

    const searchEl = document.getElementById('search');
    const dateFromEl = document.getElementById('dateFrom');
    const dateToEl = document.getElementById('dateTo');
    const btnExport = document.getElementById('btnExport');

    const tabs = document.querySelectorAll('.tabbar button');
    const tabUnpaidWrap = document.getElementById('tab-unpaid');
    const tabPaidWrap = document.getElementById('tab-paid');

    // Modal
    const modal = document.getElementById('modalPayout');
    const btnRequestPayout = document.getElementById('btnRequestPayout');
    const closeModal = document.getElementById('closeModal');
    const cancelPayout = document.getElementById('cancelPayout');
    const confirmPayout = document.getElementById('confirmPayout');
    const modalEligible = document.getElementById('modal-eligible');
    const modalMethod = document.getElementById('modal-method');
    const modalNote = document.getElementById('modal-note');

    // -------- Utils --------
    const fmt = (n)=> CURRENCY + n.toLocaleString('en-PH', {minimumFractionDigits:2, maximumFractionDigits:2});
    const inRange = (d, from, to)=>{
      if(!from && !to) return true;
      const x = new Date(d).setHours(0,0,0,0);
      if(from && x < new Date(from).setHours(0,0,0,0)) return false;
      if(to && x > new Date(to).setHours(0,0,0,0)) return false;
      return true;
    };

    // -------- Render --------
    function computeSummary(rows){
      const total = rows.reduce((s,r)=>s+r.amount,0);
      const paidRows = rows.filter(r=>r.status==='paid');
      const unpaidRows = rows.filter(r=>r.status==='unpaid');
      const paid = paidRows.reduce((s,r)=>s+r.amount,0);
      const unpaid = unpaidRows.reduce((s,r)=>s+r.amount,0);

      sumTotalEl.textContent = fmt(total);
      sumPaidEl.textContent = fmt(paid);
      sumUnpaidEl.textContent = fmt(unpaid);
      countPaidEl.textContent = paidRows.length;
      countUnpaidEl.textContent = unpaidRows.length;

      // Bars relative to total
      const t = total || 1;
      barTotal.style.width = '100%';
      barPaid.style.width = (paid / t * 100).toFixed(1) + '%';
      barUnpaid.style.width = (unpaid / t * 100).toFixed(1) + '%';

      // Next payout estimate (demo rule: every Friday)
      const today = new Date();
      const day = today.getDay(); // 0 Sun .. 6 Sat
      const daysToFri = (5 - day + 7) % 7 || 7;
      const next = new Date(today);
      next.setDate(today.getDate() + daysToFri);
      nextPayoutEl.textContent = next.toLocaleDateString('en-PH', {year:'numeric', month:'short', day:'numeric'});
      payoutMethodEl.textContent = PAYOUT_METHOD;
    }

    function rowHTML(r){
      const statusPill = r.status==='paid' ? '<span class="pill paid">Paid</span>' : '<span class="pill unpaid">Unpaid</span>';
      return `
        <tr>
          <td class="mono">${r.code}</td>
          <td>${r.title}</td>
          <td>${new Date(r.date).toLocaleDateString('en-PH', {year:'numeric', month:'short', day:'numeric'})}</td>
          <td>${r.client}</td>
          <td class="mono">${fmt(r.amount)}</td>
          <td>${statusPill}</td>
          ${
            r.status==='paid'
            ? `<td class="mono">${r.paid_ref ?? '-'}</td>`
            : `<td><button class="btn ghost" data-invoice="${r.code}"><span class="material-icons-sharp">picture_as_pdf</span> Invoice</button></td>`
          }
        </tr>
      `;
    }

    function applyFilters(){
      const q = (searchEl.value || '').trim().toLowerCase();
      const f = dateFromEl.value || null;
      const t = dateToEl.value || null;

      const filtered = EARNINGS.filter(e=>{
        const hit = [e.code, e.title, e.client].some(v => (v||'').toLowerCase().includes(q));
        return hit && inRange(e.date, f, t);
      });

      // Render unpaid
      const unpaid = filtered.filter(r=>r.status==='unpaid');
      tbodyUnpaid.innerHTML = unpaid.map(rowHTML).join('') || `<tr><td colspan="7" class="sub" style="padding:1rem;">No unpaid jobs match your filters.</td></tr>`;

      // Render paid
      const paid = filtered.filter(r=>r.status==='paid');
      tbodyPaid.innerHTML = paid.map(rowHTML).join('') || `<tr><td colspan="7" class="sub" style="padding:1rem;">No paid jobs match your filters.</td></tr>`;

      computeSummary(filtered);
      updatePayoutButton(unpaid);
    }

    function updatePayoutButton(unpaidRows){
      const eligible = unpaidRows.reduce((s,r)=>s+r.amount,0);
      btnRequestPayout.disabled = eligible < PAYOUT_THRESHOLD;
      btnRequestPayout.title = eligible < PAYOUT_THRESHOLD
        ? `Need at least ${fmt(PAYOUT_THRESHOLD)} to request payout`
        : 'Request payout for eligible jobs';
    }

    function exportCSV(){
      // Export only currently visible (filtered) rows from the active tab
      const activeTab = document.querySelector('.tabbar button.active').dataset.tab;
      const rows = Array.from((activeTab==='unpaid'? tbodyUnpaid : tbodyPaid).querySelectorAll('tr'))
        .filter(tr => tr.querySelector('td')); // skip headers/placeholders

      const headers = activeTab==='unpaid'
        ? ['Job Code','Title','Date','Client','Amount','Status']
        : ['Job Code','Title','Date','Client','Amount','Status','Payout Ref'];

      const records = rows.map(tr=>{
        const cells = Array.from(tr.querySelectorAll('td'));
        // strip HTML from status cell, take text only
        const text = cells.map(td=>td.innerText.replace(/\n/g,' ').trim());
        // Drop last cell (actions) for unpaid table
        if(activeTab==='unpaid'){ text.pop(); }
        return text;
      });

      const csv = [headers, ...records].map(r=>r.map(v=>{
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `earnings_${activeTab}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // -------- Events --------
    searchEl.addEventListener('input', applyFilters);
    dateFromEl.addEventListener('change', applyFilters);
    dateToEl.addEventListener('change', applyFilters);
    btnExport.addEventListener('click', exportCSV);

    tabs.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const tab = b.dataset.tab;
        if(tab==='unpaid'){ tabUnpaidWrap.style.display='block'; tabPaidWrap.style.display='none'; }
        else { tabUnpaidWrap.style.display='none'; tabPaidWrap.style.display='block'; }
      });
    });

    // Payout modal handlers
    function openPayout(){
      const q = (searchEl.value || '').trim().toLowerCase();
      const f = dateFromEl.value || null;
      const t = dateToEl.value || null;
      const unpaid = EARNINGS.filter(r=>r.status==='unpaid')
        .filter(e=>{
          const hit = [e.code, e.title, e.client].some(v => (v||'').toLowerCase().includes(q));
          return hit && inRange(e.date, f, t);
        });
      const eligible = unpaid.reduce((s,r)=>s+r.amount,0);
      modalEligible.textContent = fmt(eligible);
      modalMethod.textContent = PAYOUT_METHOD;
      modalNote.textContent = eligible < PAYOUT_THRESHOLD
        ? `You currently don't meet the payout threshold of ${fmt(PAYOUT_THRESHOLD)}.`
        : `A payout request will be created for ${unpaid.length} job(s). You’ll receive a reference in the Paid tab once processed.`;
      confirmPayout.disabled = eligible < PAYOUT_THRESHOLD;
      modal.classList.add('open');
    }
    function closePayout(){ modal.classList.remove('open'); }

    btnRequestPayout.addEventListener('click', openPayout);
    closeModal.addEventListener('click', closePayout);
    cancelPayout.addEventListener('click', closePayout);
    confirmPayout.addEventListener('click', ()=>{
      // ---- Hook your backend request here ----
      // e.g., POST /api/payouts { jobs: [codes...] }
      alert('Payout request submitted! (Demo)');
      closePayout();
    });

    // Invoice button (demo)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-invoice]');
      if(!btn) return;
      const code = btn.getAttribute('data-invoice');
      // ---- Hook your invoice download here ----
      alert('Generate/Download invoice for ' + code + ' (Demo)');
    });

    // -------- Init --------
    (function init(){
      applyFilters();
    })();
  </script>
</body>
</html>
