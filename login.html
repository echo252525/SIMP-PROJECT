<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Login – SIMP Project</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        max-width: 480px;
        margin: 50px auto;
        padding: 0 16px;
      }
      h2 {
        margin-bottom: 20px;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      button {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 8px;
        background-color: #4f46e5;
        color: white;
        cursor: pointer;
        margin-top: 12px;
      }
      button:hover {
        background-color: #3730a3;
      }
    </style>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "/supabase.js";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // If installer_documents is in another schema, e.g. "jobs", use:
      // const db = supabase.schema("jobs");
      const db = supabase; // public schema

      // Paths
      const INSTALLER_UPLOAD =
        "../pages/installer_pages/html_files/upload.html";
      const INSTALLER_DASH =
        "../pages/installer_pages/html_files/dashboard.html";
      const INSTALLER_REVIEW =
        "../pages/installer_pages/html_files/review.html";
      const INSTALLER_APPROVED =
        "../pages/installer_pages/html_files/approved.html";
      const INSTALLER_REJECTED =
        "../pages/installer_pages/html_files/rejected.html";
      const CUSTOMER_DASH =
        "../pages/customer_pages/html_files/createPost.html";

      // Get the latest installer_documents row for this user
      async function getLatestInstallerDoc(userId) {
        const { data, error } = await db
          .from("installer_documents")
          .select("installer_id, status, updated_at, uploaded_at")
          .eq("installer_id", userId)
          .order("updated_at", { ascending: false, nullsLast: true })
          .order("uploaded_at", { ascending: false, nullsLast: true })
          .limit(1)
          .maybeSingle();

        if (error) throw error;
        return data; // may be null if no docs yet
      }

      async function isCustomer(userId) {
        const { data, error } = await supabase
          .from("customer")
          .select("id")
          .eq("id", userId)
          .maybeSingle();
        if (error) throw error;
        return !!data;
      }

      // ✅ NEW: check if user exists in public.installer table
      async function isInstaller(userId) {
        const { data, error } = await supabase
          .from("installer")
          .select("id")
          .eq("id", userId)
          .maybeSingle();
        if (error) throw error;
        return !!data;
      }

      window.login = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const role = document.getElementById("role").value;

        try {
          // 1) Auth sign-in
          const { data: signInData, error: signInError } =
            await supabase.auth.signInWithPassword({ email, password });
          if (signInError) throw signInError;

          const userId = signInData.user.id;

          if (role === "installer") {
            // ✅ First, ensure this user is actually an installer
            const installerExists = await isInstaller(userId);
            if (!installerExists) {
              alert(
                "No installer profile found for this account. Please register as an installer first."
              );
              // Do NOT redirect to upload; stop here.
              return;
            }

            // Proceed with document status routing only for real installers
            const doc = await getLatestInstallerDoc(userId);

            if (doc) {
              const status = String(doc.status || "").toLowerCase();

              // 2) When status is "approved", flip to "verified"
              if (status === "approved") {
                try {
                  const { data: updated, error: updErr } = await db
                    .from("installer_documents")
                    .update({ status: "verified" })
                    .eq("installer_id", userId) // ← NOT doc.id
                    .select("status") // force returning row
                    .single(); // 406 if nothing matched
                  if (updErr) throw updErr;
                  console.log("Status updated to:", updated.status);
                } catch (e) {
                  console.warn(
                    "Auto-upgrade failed (still going to Approved page):",
                    e
                  );
                }
                window.location.href = INSTALLER_APPROVED;
                return;
              }

              if (status === "verified") {
                window.location.href = INSTALLER_DASH;
                return;
              }

              if (
                status === "pending review" ||
                status === "pending" ||
                status === "submitted" ||
                status === "under review"
              ) {
                window.location.href = INSTALLER_REVIEW;
                return;
              }

              if (status === "rejected") {
                window.location.href = INSTALLER_REJECTED;
                return;
              }

              // Unknown status → send to upload
              window.location.href = INSTALLER_UPLOAD;
              return;
            } else {
              // Installer exists but has no documents yet → upload
              alert(
                "No installer documents found. Please upload your documents."
              );
              window.location.href = INSTALLER_UPLOAD;
              return;
            }
          }

          if (role === "customer") {
            const customer = await isCustomer(userId);
            if (customer) {
              window.location.href = CUSTOMER_DASH;
            } else {
              alert("No customer profile found. Please register as customer.");
            }
          }
        } catch (err) {
          alert("Error: " + (err.message || "Login failed"));
          console.error(err);
        }
      };
    </script>
  </head>

  <body>
    <h2>Login – SIMP Project</h2>
    <input type="email" id="email" placeholder="Email" required /><br />
    <input
      type="password"
      id="password"
      placeholder="Password"
      required
    /><br />

    <!-- Role Selector -->
    <select id="role" required>
      <option value="" disabled selected>Select Role</option>
      <option value="customer">Customer</option>
      <option value="installer">Installer</option>
    </select>

    <button onclick="login()">Login</button>
    <p>Don't have an account? <a href="signup.html">Sign Up</a></p>
  </body>
</html>
