<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <link rel="icon" type="image/png" href="img/simpHappyMascotLogo.png">

  <title>SIMP Project – Admin Login / Sign Up</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap");

    :root {
      --azure: #20647c;
      --green: #20a44c;
      --ink: #1c2430;
      --muted: #6b7280;
      --line: #e7edf3;
      --bg: #f6f8fb;
      --shadow: 0 28px 60px rgba(17, 24, 39, .14);
      --grad: linear-gradient(135deg, #20a44c, #20647c);
    }

    * { box-sizing: border-box; }

    /* Keep scrollbar space to prevent layout shift when modals open */
    html { height: 100%; overflow-y: scroll; }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: "Raleway", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f8fbfd, #e7edf3);
      display: grid;
      align-items: center;
      justify-content: center;
    }

    /* ===== Root container (kept) ===== */
    .adminLoginDiv {
      width: min(980px, 95vw);
      height: 560px;
      position: relative;
    }

    .adminLoginDiv .backBtn {
      position: absolute;
      top: -54px;
      left: 0;
      background: none;
      border: 0;
      cursor: pointer;
      color: #000
    }

    /* ===== Card grid (2 columns) ===== */
    .auth-card {
      position: relative;
      height: 100%;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #fff;
    }

    .auth-inner { position: relative; height: 100%; width: 100%; }

    .columns {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    /* ===== Forms (left & right) ===== */
    .form-side {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 34px;
    }

    .panel-shell {
      width: 100%;
      max-width: 420px;
      position: relative;
    }

    .panel-shell h3 {
      margin: 0 0 1rem;
      color: #000;
      font-weight: 800;
      font-size: 36px;
      text-align: center;
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px }
    .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px }

    label { font-size: 13px; color: #374151; display: block }

    input {
      width: 100%;
      margin-top: 6px;
      padding: 12px 12px;
      border: 1px solid #d7dee7;
      border-radius: 10px;
      outline: none;
      transition: border-color .2s, box-shadow .2s, background .2s;
      background: #f1f3f6;
    }
    input:focus {
      border-color: #9ac7d7;
      box-shadow: 0 0 0 3px rgba(32, 100, 124, .12);
      background: #fff
    }

    .actions { display: flex; justify-content: center; gap: 10px; margin-top: 14px }

    .btn { border: 0; border-radius: 999px; cursor: pointer; padding: 12px 26px; font-weight: 800 }
    .btn-primary { background: #20a44c; color: #fff }
    .btn-primary:hover { filter: brightness(.96) }

    .hint { font-size: 12px; color: var(--muted); text-align: center; margin-top: 10px }

    /* old notice kept for fallback but visually hidden now */
    .notice { display: none; }

    /* ===== Overlay (desktop) ===== */
    .overlay {
      position: absolute;
      top: 0; left: 50%;
      width: 50%; height: 100%;
      pointer-events: none;
      transition: transform .6s cubic-bezier(.22, .61, .36, 1);
      z-index: 2;
    }
    .overlay .block {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: var(--grad); color: #fff; text-align: center; padding: 34px;
    }
    .overlay .content { max-width: 420px }
    .overlay h2 { font-size: 40px; line-height: 1.05; margin: 0 0 12px; font-weight: 900 }
    .overlay p { opacity: .95; margin: 0 0 28px; font-size: 16px; line-height: 1.5 }

    .btn-ghost {
      border: 2px solid rgba(255, 255, 255, .9);
      background: transparent; color: #fff;
      border-radius: 999px; padding: 12px 28px; font-weight: 800; pointer-events: auto;
    }
    .btn-ghost:hover { background: rgba(255, 255, 255, .12) }

    .adminLoginDiv:not(.mode-signup) .overlay { transform: translateX(0%); }
    .adminLoginDiv.mode-signup .overlay { transform: translateX(-100%); }

    .welcome, .hello { display: none }
    .adminLoginDiv.mode-signup .welcome { display: block }
    .adminLoginDiv:not(.mode-signup) .hello { display: block }

    .form-login, .form-signup { transition: opacity .45s ease, transform .45s ease; }
    .form-login { opacity: 1; transform: translateX(0px); }
    .form-signup { opacity: 0; transform: translateX(20px); pointer-events: none; }
    .mode-signup .form-login { opacity: 0; transform: translateX(-20px); pointer-events: none; }
    .mode-signup .form-signup { opacity: 1; transform: translateX(0px); pointer-events: auto; }

    .tabs { display: none }
    .mobile-tabs { display: none; }

    @media (max-width: 900px) {
      .auth-inner { position: relative; display: grid; grid-template-rows: auto 1fr; }
      .adminLoginDiv { width: min(560px, 100vw); height: 450px; margin: 50px; }
      .adminLoginDiv .backBtn { top: -30px; left: 0%; z-index: 5; }

      .mobile-tabs {
        position: static; margin: 12px; z-index: 0; display: none;
        grid-template-columns: 1fr 1fr; gap: 8px; padding: 6px; border-radius: 999px;
        background-color: #f5f7fb; border: 1px solid #e6e8ee; box-shadow: 0 8px 20px rgba(17, 24, 39, .08);
      }
      .seg {
        font-weight: 800; font-size: 13px; padding: 10px 0; border-radius: 999px;
        border: none; color: #334155; background-color: #f5f7fb; cursor: pointer;
      }
      .seg.active { color: #fff; border-color: transparent; background: linear-gradient(135deg, #20a44c, #20647c); }

      .overlay { display: none }

      .columns {
        position: relative; top: 0; left: 0; right: 0; bottom: auto; height: auto; min-height: 0;
        display: flex; width: 200%; transition: transform .45s ease;
      }
      .form-side {
        overflow-y: auto; align-items: flex-start; padding: 20px 18px 22px;
        width: 50%; margin-top: 20px;
      }
      .panel-shell { max-width: 520px; margin: 8px auto 0px; }
      .panel-shell h3 { margin-top: 0; }

      .row { grid-template-columns: 1fr; gap: 10px }
      input { padding: 11px 12px; border-radius: 12px; }

      .adminLoginDiv:not(.mode-signup) .columns { transform: translateX(0%); }
      .adminLoginDiv.mode-signup .columns { transform: translateX(-50%); }

      .form-login, .form-signup { opacity: 1 !important; transform: none !important; pointer-events: auto !important; }
      .auth-card { border-radius: 16px; }
    }

    @media (max-width: 420px) {
      .adminLoginDiv { height: 500px; }
      .panel-shell h3 { font-size: 24px; }
      .seg { font-size: 12px; padding: 9px 0; }
    }
  </style>
</head>

<body>
  <div class="adminLoginDiv">
    <div class="auth-card">
      <div class="auth-inner">

        <!-- MOBILE segmented control (auto-hidden on desktop) -->
        <div class="mobile-tabs">
          <button id="mobSignIn" class="seg active" type="button">Sign in</button>
          <button id="mobSignUp" class="seg" type="button">Sign up</button>
        </div>

        <div class="columns">
          <!-- LEFT: Sign in form -->
          <div class="form-side">
            <div class="panel-shell form-login">
              <div>
                <button class="backBtn" onclick="history.back()"><span class="material-icons-sharp">arrow_back</span></button>
              </div>
              <h3>Sign in</h3>

              <div id="notice" class="notice"></div>

              <div class="row-1">
                <label>Email
                  <input id="loginEmail" type="email" autocomplete="email" required />
                </label>
                <label>Password
                  <input id="loginPassword" type="password" autocomplete="current-password" required />
                </label>
              </div>
              <div onclick="window.location.href='forgotPassword.html'" class="hint">Forgot your password?</div>
              <div class="actions">
                <button id="loginBtn" class="btn btn-primary">SIGN IN</button>
              </div>
            </div>
          </div>

          <!-- RIGHT: Sign up form -->
          <div class="form-side">
            <div class="panel-shell form-signup">
              <button class="backBtn" onclick="history.back()"><span class="material-icons-sharp">arrow_back</span></button>
              <h3>Create Account</h3>

              <div class="row">
                <div><label>Full Name
                    <input id="suName" type="text" required /></label></div>
                <div><label>Phone (optional)
                    <input id="suPhone" type="tel" /></label></div>
              </div>
              <div class="row-1">
                <label>Email
                  <input id="suEmail" type="email" required /></label>
              </div>
              <div class="row-1">
                <label>Password
                  <input id="suPassword" type="password" minlength="6" required /></label>
                <div class="hint">Minimum 6 characters. New sign-ups are <b>pending</b> until admin approval.</div>
              </div>
              <div class="actions">
                <button id="signUpBtn" class="btn btn-primary">SIGN UP</button>
              </div>
            </div>
          </div>
        </div>

        <!-- OVERLAY that moves left/right (desktop only) -->
        <div class="overlay" aria-hidden="true">
          <div class="block">
            <div class="content">
              <!-- Right side (default, login view) -->
              <div class="hello">
                <img src="img/simpHappyMascotLogo.png" style="max-width:100px; width:95%;">
                <h2>Welcome Back, Simpsters!</h2>
                <p>To keep connected with us please login with your personal info</p>
                <button id="ctaSignUpBtn" class="btn-ghost">SIGN UP</button>
              </div>
              <!-- Left side (signup view) -->
              <div class="welcome">
                <img src="img/simpHappyMascotLogo.png" style="max-width:100px; width:95%;">
                <h2>Hello, Simpsters!</h2>
                <p>Enter your personal details and start journey with us</p>
                <button id="ctaLoginBtn" class="btn-ghost">SIGN IN</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden header + tabs (kept for compatibility) -->
      <div class="adminLoginDivHeader" aria-hidden="true">
        <h2>SIMP Project – Welcome!</h2>
        <div class="hint">
          This page is only for <b>Admin</b> accounts. New sign-ups are created as
          <b>pending</b> and require approval by the superadmin.
        </div>
      </div>
      <div class="tabs" aria-hidden="true">
        <div class="indicator"></div>
        <div class="tab active" data-tab="login" aria-controls="loginPanel">Login</div>
        <div class="tab" data-tab="signup" aria-controls="signupPanel">Sign Up</div>
      </div>
    </div>

    <!-- Kept (unused now; SweetAlert handles email confirm) -->
    <div id="emailConfirmModal" style="display:none">
      <div class="modal-content">
        <h3>Confirm Your Email</h3>
        <p>We’ve sent a confirmation link to your email. Please check your inbox and click the link to activate your
          account.</p>
        <button id="goToEmailBtn" class="btn btn-primary">Go to My Email</button>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "/supabase.js";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Scroll freeze helpers to prevent page jump ----------
    let __scrollY = 0;
    function lockBodyScroll() {
      __scrollY = window.scrollY || window.pageYOffset || 0;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      document.body.style.width = '100%';
    }
    function unlockBodyScroll() {
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.width = '';
      window.scrollTo(0, __scrollY);
    }

    // ---------- SweetAlert compact styling (shorter popups) ----------
    const swalBase = Swal.mixin({
      customClass: {
        popup: 'swal2-compact-popup',
        confirmButton: 'swal2-compact-confirm',
        cancelButton: 'swal2-compact-cancel',
        title: 'swal2-compact-title',
        htmlContainer: 'swal2-compact-html'
      },
      buttonsStyling: false,
      allowOutsideClick: false,
      allowEscapeKey: true,
      backdrop: true,
      heightAuto: false, // prevent layout jump on some browsers
      returnFocus: false,
      willOpen: lockBodyScroll,
      didClose: unlockBodyScroll
    });

    const toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 2400,
      timerProgressBar: true,
      customClass: { popup: 'swal2-compact-popup' },
      returnFocus: false
    });

    // Inject minimal compact CSS for the modals (shorter + stable)
    (function injectSwalCompactCSS() {
      const css = `
        .swal2-compact-popup {
          padding: 14px 16px !important;
          border-radius: 14px !important;
          max-width: min(92vw, 420px) !important;
        }
        .swal2-compact-title {
          font-size: 18px !important;
          margin: 2px 0 6px !important;
          line-height: 1.2 !important;
          font-weight: 800 !important;
          color: #0f172a !important;
        }
        .swal2-compact-html {
          font-size: 14px !important;
          line-height: 1.45 !important;
          color: #334155 !important;
        }
        .swal2-compact-confirm, .swal2-compact-cancel {
          background: #20a44c; color: #fff; border: 0; border-radius: 999px;
          padding: 9px 16px; font-weight: 800; margin: 6px 4px;
        }
        .swal2-compact-cancel { background: #e5e7eb; color: #111827; }
        .swal2-icon { margin: 8px auto !important; }
        .swal2-actions { margin-top: 8px !important; }
        .swal2-timer-progress-bar { background: rgba(32,100,124,.25) !important; }
      `;
      const el = document.createElement('style');
      el.innerHTML = css;
      document.head.appendChild(el);
    })();

    // ---------- Friendly error mapping (expanded) ----------
    function prettyError(err) {
      const message = (err?.message || String(err || 'Unknown error'));
      const raw = message.toLowerCase();

      if (raw.includes('invalid login') || raw.includes('invalid credentials')) {
        return 'Email or password is incorrect.';
      }
      if (raw.includes('email not confirmed') || raw.includes('confirm')) {
        return 'Please confirm your email before signing in.';
      }
      if (raw.includes('over_email_send_rate_limit')) {
        return 'We’ve sent too many emails recently. Please try again in a few minutes.';
      }
      if (raw.includes('user already registered') || raw.includes('already exists')) {
        return 'There’s already an account with this email.';
      }
      if (raw.includes('password')) {
        return 'Password does not meet the requirements. Please try a stronger one.';
      }
      if (raw.includes('network') || raw.includes('fetch') || raw.includes('failed to fetch')) {
        return 'We couldn’t reach the server. Please check your connection and try again.';
      }
      if (raw.includes('rate limit')) {
        return 'Too many attempts. Please wait a moment and try again.';
      }
      return message || 'Something went wrong. Please try again.';
    }

    // ---------- Old notice fallback (kept) + SweetAlert wrappers ----------
    const noticeEl = document.getElementById("notice");

    async function showNotice(msg, type = "") {
      // Keep fallback content for legacy (hidden in UI)
      noticeEl.textContent = msg;

      // Unify sweetalert popups (short, friendly)
      const common = { customClass: { popup: 'swal2-compact-popup' } };

      if (type === "success") {
        await swalBase.fire({
          icon: 'success',
          title: 'Success',
          html: msg,
          confirmButtonText: 'OK',
          ...common
        });
      } else if (type === "error") {
        await swalBase.fire({
          icon: 'error',
          title: 'Something went wrong',
          html: msg,
          confirmButtonText: 'OK',
          ...common
        });
      } else if (type === "warning") {
        await swalBase.fire({
          icon: 'warning',
          title: 'Please check',
          html: msg,
          confirmButtonText: 'OK',
          ...common
        });
      } else {
        toast.fire({ icon: 'info', title: msg, ...common });
      }
    }
    function hideNotice() { noticeEl.textContent = ""; }

    // ---------- Mode toggle ----------
    const container = document.querySelector(".adminLoginDiv");
    const tabs = document.querySelectorAll(".tab");
    function switchTab(key) {
      tabs.forEach(x => x.classList.toggle("active", x.dataset.tab === key));
      container.classList.toggle("mode-signup", key === "signup");
      // mobile segmented control state
      const si = document.getElementById("mobSignIn");
      const su = document.getElementById("mobSignUp");
      if (si && su) {
        const isSignup = key === "signup";
        si.classList.toggle("active", !isSignup);
        su.classList.toggle("active", isSignup);
      }
      hideNotice();
    }

    // Desktop overlay CTAs
    document.getElementById("ctaSignUpBtn").addEventListener("click", () => switchTab("signup"));
    document.getElementById("ctaLoginBtn").addEventListener("click", () => switchTab("login"));

    // Mobile segmented buttons
    const mobTabs = document.querySelector(".mobile-tabs");
    const mql = window.matchMedia("(max-width: 900px)");
    const applyMobTabsVisibility = () => { mobTabs.style.display = mql.matches ? "grid" : "none"; };
    applyMobTabsVisibility();
    mql.addEventListener?.("change", applyMobTabsVisibility);
    document.getElementById("mobSignIn")?.addEventListener("click", () => switchTab("login"));
    document.getElementById("mobSignUp")?.addEventListener("click", () => switchTab("signup"));

    // ===== Data helpers (kept) =====
    async function getAdminRow(userId) {
      const { data, error } = await supabase.from("admin").select("*").eq("id", userId).maybeSingle();
      if (error) throw error; return data;
    }
    async function ensureAdminRowNow(user, overrides = {}) {
      const payload = {
        id: user.id, email: user.email,
        name: user.user_metadata?.name || overrides.name || "Admin User",
        phone: user.user_metadata?.phone || overrides.phone || null,
        role: "pending",
      };
      const { error } = await supabase.from("admin").insert([payload]);
      if (error) throw error;
    }

    // Email provider prompt via SweetAlert (replaces old modal)
    async function openEmailProvider(email) {
      const emailProvider = email.split("@")[1]?.toLowerCase() || "";
      let providerUrl = "https://mail.google.com";
      if (emailProvider.includes("yahoo")) providerUrl = "https://mail.yahoo.com";
      else if (emailProvider.includes("outlook") || emailProvider.includes("hotmail") || emailProvider.includes("live")) providerUrl = "https://outlook.live.com/mail";
      else if (emailProvider.includes("icloud")) providerUrl = "https://www.icloud.com/mail";

      await swalBase.fire({
        icon: 'info',
        title: 'Confirm your email',
        html: `We sent a confirmation link to <b>${email}</b>.<br/>Open your inbox and click the link to activate your account.`,
        showCancelButton: true,
        confirmButtonText: 'Open Email',
        cancelButtonText: 'OK'
      }).then(res => { if (res.isConfirmed) window.open(providerUrl, "_blank"); });
    }

    // ===== SIGN UP (kept; messages refined) =====
    document.getElementById("signUpBtn").addEventListener("click", async () => {
      hideNotice();
      const name = document.getElementById("suName").value.trim();
      const phone = document.getElementById("suPhone").value.trim();
      const email = document.getElementById("suEmail").value.trim();
      const password = document.getElementById("suPassword").value;

      if (!name || !email || !password || password.length < 6) {
        showNotice("Please complete all required fields. Password must be at least 6 characters.", "warning");
        return;
      }
      try {
        const { data: authData, error: authError } =
          await supabase.auth.signUp({
            email,
            password,
            options: {
              data: { name, phone, role: "admin" },
              emailRedirectTo: "https://simp-project-tan.vercel.app/adminLogin.html",
            },
          });
        if (authError) throw authError;

        if (authData.session && authData.user) {
          await ensureAdminRowNow(authData.user, { name, phone });
          await showNotice("Account created! Your admin profile is now set to <b>Pending</b> for approval.", "success");
          switchTab("login");
        } else {
          await openEmailProvider(email);
          await showNotice("Sign up successful. Please verify your email, then sign in. Your admin profile will be set to <b>Pending</b> automatically.", "success");
          switchTab("login");
        }
      } catch (err) {
        console.error(err);
        showNotice("Sign up failed. " + prettyError(err), "error");
      }
    });

    // ===== LOGIN (kept; messages refined) =====
    const loginBtn = document.getElementById("loginBtn");
    async function refreshLoginState() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      try {
        let row = await getAdminRow(user.id);
        if (!row) { await ensureAdminRowNow(user); row = await getAdminRow(user.id); }

        if (row.role === "pending") {
          await swalBase.fire({
            icon: 'info',
            title: 'Approval in progress',
            html: 'Your account is currently <b>Pending</b> approval. We’ll notify you once it’s activated.',
            confirmButtonText: 'Continue'
          });
          window.location.href = "pages/admin_pages/html_files/waiting.html";
          return;
        }
        if (row.role === "admin" || row.role === "superadmin") {
          await toast.fire({ icon: 'success', title: 'Welcome back!' });
          window.location.href = "pages/admin_pages/html_files/dashboard.html";
        } else {
          showNotice("We couldn’t determine your role. Please contact support.", "error");
        }
      } catch (e) {
        console.error(e);
        showNotice("Could not load your admin status. " + prettyError(e), "error");
      }
    }
    loginBtn.addEventListener("click", async () => {
      hideNotice();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) { showNotice("Please enter both your email and password.", "warning"); return; }
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await refreshLoginState();
      } catch (err) {
        console.error(err);
        showNotice("Sign in failed. " + prettyError(err), "error");
      }
    });

    // On load
    (async () => { switchTab("login"); await refreshLoginState(); })();
  </script>
</body>

</html>
