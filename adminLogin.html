<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <title>SIMP Project – Admin Login / Sign Up</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap");

    :root {
      --azure: #20647c;
      --green: #20a44c;
      --ink: #1c2430;
      --muted: #6b7280;
      --line: #e7edf3;
      --bg: #f6f8fb;
      --shadow: 0 28px 60px rgba(17, 24, 39, .14);
      --grad: linear-gradient(135deg, #20a44c, #20647c);
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: "Raleway", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #f8fbfd, #e7edf3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== Root container (kept) ===== */
    .adminLoginDiv {
      width: min(980px, 95vw);
      height: 560px;
      position: relative;
    }

    .adminLoginDiv .backBtn {
      position: absolute;
      top: -54px;
      left: 0;
      background: none;
      border: 0;
      cursor: pointer;
      color: #000
    }

    /* ===== Card grid (2 columns) ===== */
    .auth-card {
      position: relative;
      height: 100%;
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #fff;
    }

    .auth-inner {
      position: relative;
      height: 100%;
      width: 100%;
    }

    .columns {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    /* ===== Forms (left & right) ===== */
    .form-side {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 34px;
    }

    .panel-shell {
      width: 100%;
      max-width: 420px;
      position: relative;
    }

    .panel-shell h3 {
      margin: 0 0 1rem;
      color: #000;
      font-weight: 800;
      font-size: 36px
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px
    }

    .row-1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px
    }

    label {
      font-size: 13px;
      color: #374151;
      display: block
    }

    input {
      width: 100%;
      margin-top: 6px;
      padding: 12px 12px;
      border: 1px solid #d7dee7;
      border-radius: 10px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
      background: #f1f3f6;
    }

    input:focus {
      border-color: #9ac7d7;
      box-shadow: 0 0 0 3px rgba(32, 100, 124, .12);
      background: #fff
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 14px
    }

    .btn {
      border: 0;
      border-radius: 999px;
      cursor: pointer;
      padding: 12px 26px;
      font-weight: 800
    }

    .btn-primary {
      background: #20a44c;
      color: #fff
    }

    .btn-primary:hover {
      filter: brightness(.96)
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px
    }

    .notice {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 12px 0
    }

    .success {
      background: #ecfdf5;
      border: 1px solid #10b981;
      color: #065f46
    }

    .error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b
    }

    .hidden {
      display: none
    }

    #emailConfirmModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50
    }

    #emailConfirmModal .modal-content {
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px
    }

    /* ===== Overlay panel that SWAPS sides (desktop) ===== */
    .overlay {
      position: absolute;
      top: 0;
      left: 50%;
      width: 50%;
      height: 100%;
      pointer-events: none;
      transition: transform .6s cubic-bezier(.22, .61, .36, 1);
      z-index: 2;
    }

    .overlay .block {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grad);
      color: #fff;
      text-align: center;
      padding: 34px;
    }

    .overlay .content {
      max-width: 420px
    }

    .overlay h2 {
      font-size: 40px;
      line-height: 1.05;
      margin: 0 0 12px;
      font-weight: 900
    }

    .overlay p {
      opacity: .95;
      margin: 0 0 28px;
      font-size: 16px;
      line-height: 1.5
    }

    .btn-ghost {
      border: 2px solid rgba(255, 255, 255, .9);
      background: transparent;
      color: #fff;
      border-radius: 999px;
      padding: 12px 28px;
      font-weight: 800;
      pointer-events: auto;
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, .12)
    }

    /* Default: LOGIN view — overlay sits on RIGHT half */
    .adminLoginDiv:not(.mode-signup) .overlay {
      transform: translateX(0%);
    }

    /* SIGNUP view — overlay slides LEFT to cover the left half */
    .adminLoginDiv.mode-signup .overlay {
      transform: translateX(-100%);
    }

    /* Swap overlay texts depending on mode */
    .welcome,
    .hello {
      display: none
    }

    .adminLoginDiv.mode-signup .welcome {
      display: block
    }

    .adminLoginDiv:not(.mode-signup) .hello {
      display: block
    }

    /* Form visibility transitions (desktop fade) */
    .form-login,
    .form-signup {
      transition: opacity .45s ease, transform .45s ease;
    }

    .form-login {
      opacity: 1;
      transform: translateX(0px);
    }

    .form-signup {
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }

    .mode-signup .form-login {
      opacity: 0;
      transform: translateX(-20px);
      pointer-events: none;
    }

    .mode-signup .form-signup {
      opacity: 1;
      transform: translateX(0px);
      pointer-events: auto;
    }

    /* Keep original tabs (hidden visually) for compatibility */
    .tabs {
      display: none
    }

    /* ---------- MOBILE / SMALL SCREENS ---------- */
    /* Hidden by default on desktop */
    .mobile-tabs {
      display: none;
    }

    @media (max-width: 900px) {
      .adminLoginDiv {
        width: min(560px, 100vw);
        height: 470px;
        margin: 50px;
        /* taller for stacked UI */
      }

      .adminLoginDiv .backBtn {
        top: -30px;
        left: 0px;
        z-index: 5;
      }

      /* Show compact top tabs for mobile */
      .mobile-tabs {
        position: absolute;
        top: 100px;
        left: 12px;
        right: 12px;
        z-index: 3;
        display: grid;
        /* becomes visible only on mobile */
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        background: rgba(255, 255, 255, .8);
        backdrop-filter: blur(6px);
        padding: 8px;
        border-radius: 14px;
        border: 1px solid #eef2f7;
        box-shadow: 0 6px 20px rgba(17, 24, 39, .08);
      }

      .seg {
        font-weight: 800;
        font-size: 13px;
        padding: 10px 0;
        border-radius: 10px;
        border: 1px solid #e6ecf4;
        color: #334155;
        background: #fff;
        cursor: pointer;
      }

      .seg.active {
        color: #fff;
        border-color: transparent;
        background: linear-gradient(135deg, #20a44c, #20647c);
      }

      /* Hide overlay on mobile (we’ll slide the forms themselves) */
      .overlay {
        display: none
      }

      /* Make the two panels sit side-by-side horizontally and slide */
      .columns {
        position: absolute;
        top: 56px;
        /* leave room for the mobile tabs */
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        width: 200%;
        height: calc(100% - 56px);
        transition: transform .45s ease;
      }

      .form-side {
        width: 50%;
        align-items: flex-start;
        padding: 20px 18px 22px;
        overflow-y: auto;
      }

      .panel-shell {
        max-width: 520px;
        margin: 8px auto 24px;
      }

      .panel-shell h3 {
        font-size: 26px;
        margin-bottom: 10px;
        margin-top: 90px;
      }

      .row {
        grid-template-columns: 1fr;
        gap: 10px
      }

      /* stack inputs on mobile */
      input {
        padding: 11px 12px;
        border-radius: 12px;
      }

      .actions .btn {
        padding: 12px 18px;
      }

      /* Slide the whole strip left/right to reveal one panel */
      .adminLoginDiv:not(.mode-signup) .columns {
        transform: translateX(0%);
      }

      .adminLoginDiv.mode-signup .columns {
        transform: translateX(-50%);
      }

      /* Don’t fade forms on mobile; keep full opacity for clarity while sliding */
      .form-login,
      .form-signup {
        opacity: 1 !important;
        transform: none !important;
        pointer-events: auto !important;
      }

      /* Softer card radius on mobile */
      .auth-card {
        border-radius: 16px;
      }
    }

    /* Extra tiny phones */
    @media (max-width: 420px) {
      .adminLoginDiv {
        height: 470px;
      }

      .panel-shell h3 {
        font-size: 24px;
      }

      .seg {
        font-size: 12px;
        padding: 9px 0;
      }
    }
  </style>
</head>

<body>
  <div class="adminLoginDiv">
    <div class="auth-card">
      <div class="auth-inner">

        <!-- MOBILE segmented control (auto-hidden on desktop, visible under 900px) -->
        <div class="mobile-tabs">
          <button id="mobSignIn" class="seg active" type="button">Sign in</button>
          <button id="mobSignUp" class="seg" type="button">Sign up</button>
        </div>

        <div class="columns">
          <!-- LEFT: Sign in form -->
          <div class="form-side">
            <div class="panel-shell form-login">
              <button class="backBtn" onclick="history.back()"><span
                  class="material-icons-sharp">arrow_back</span></button>
              <h3>Sign in</h3>

              <div id="notice" class="notice hidden"></div>

              <div class="row-1">
                <label>Email
                  <input id="loginEmail" type="email" autocomplete="email" required />
                </label>
                <label>Password
                  <input id="loginPassword" type="password" autocomplete="current-password" required />
                </label>
              </div>
              <div class="hint">Forgot your password?</div>
              <div class="actions">
                <button id="loginBtn" class="btn btn-primary">SIGN IN</button>
              </div>
            </div>
          </div>

          <!-- RIGHT: Sign up form -->
          <div class="form-side">
            <div class="panel-shell form-signup">
              <button class="backBtn" onclick="history.back()"><span
                  class="material-icons-sharp">arrow_back</span></button>
              <h3>Create Account</h3>

              <div class="row">
                <div><label>Full Name
                    <input id="suName" type="text" required /></label></div>
                <div><label>Phone (optional)
                    <input id="suPhone" type="tel" /></label></div>
              </div>
              <div class="row-1">
                <label>Email
                  <input id="suEmail" type="email" required /></label>
              </div>
              <div class="row-1">
                <label>Password
                  <input id="suPassword" type="password" minlength="6" required /></label>
                <div class="hint">Minimum 6 characters. New sign-ups are <b>pending</b> until admin approval.</div>
              </div>
              <div class="actions">
                <button id="signUpBtn" class="btn btn-primary">SIGN UP</button>
              </div>
            </div>
          </div>
        </div>

        <!-- OVERLAY that moves left/right (desktop only) -->
        <div class="overlay" aria-hidden="true">
          <div class="block">
            <div class="content">
              <!-- Right side (default, login view) -->
              <div class="hello">
                <img src="img/simpHappyMascotLogo.png" style="max-width:100px; width:95%;">
                <h2>Hello, Simpsters!</h2>
                <p>Enter your personal details and start journey with us</p>
                <button id="ctaSignUpBtn" class="btn-ghost">SIGN UP</button>
              </div>
              <!-- Left side (signup view) -->
              <div class="welcome">
                <img src="img/simpHappyMascotLogo.png" style="max-width:100px; width:95%;">
                <h2>Welcome Back, Simpsters!</h2>
                <p>To keep connected with us please login with your personal info</p>
                <button id="ctaLoginBtn" class="btn-ghost">SIGN IN</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden header + tabs (kept for compatibility) -->
      <div class="adminLoginDivHeader" aria-hidden="true">
        <h2>SIMP Project – Welcome!</h2>
        <div class="hint">
          This page is only for <b>Admin</b> accounts. New sign-ups are created as
          <b>pending</b> and require approval by the superadmin.
        </div>
      </div>
      <div class="tabs" aria-hidden="true">
        <div class="indicator"></div>
        <div class="tab active" data-tab="login" aria-controls="loginPanel">Login</div>
        <div class="tab" data-tab="signup" aria-controls="signupPanel">Sign Up</div>
      </div>
    </div>

    <!-- Modal (kept) -->
    <div id="emailConfirmModal">
      <div class="modal-content">
        <h3>Confirm Your Email</h3>
        <p>We’ve sent a confirmation link to your email. Please check your inbox and click the link to activate your
          account.</p>
        <button id="goToEmailBtn" class="btn btn-primary">Go to My Email</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "/supabase.js";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Notices
    const noticeEl = document.getElementById("notice");
    function showNotice(msg, type = "") { noticeEl.textContent = msg; noticeEl.classList.remove("hidden", "success", "error"); if (type === "success") noticeEl.classList.add("success"); if (type === "error") noticeEl.classList.add("error"); }
    function hideNotice() { noticeEl.classList.add("hidden"); noticeEl.classList.remove("success", "error"); noticeEl.textContent = ""; }

    // Mode toggle
    const container = document.querySelector(".adminLoginDiv");
    const tabs = document.querySelectorAll(".tab");
    function switchTab(key) {
      tabs.forEach(x => x.classList.toggle("active", x.dataset.tab === key));
      container.classList.toggle("mode-signup", key === "signup");
      // mobile segmented control state
      const si = document.getElementById("mobSignIn");
      const su = document.getElementById("mobSignUp");
      if (si && su) {
        const isSignup = key === "signup";
        si.classList.toggle("active", !isSignup);
        su.classList.toggle("active", isSignup);
      }
      hideNotice();
    }

    // Desktop overlay CTAs
    document.getElementById("ctaSignUpBtn").addEventListener("click", () => switchTab("signup"));
    document.getElementById("ctaLoginBtn").addEventListener("click", () => switchTab("login"));

    // Mobile segmented buttons
    const mobTabs = document.querySelector(".mobile-tabs");
    const mql = window.matchMedia("(max-width: 900px)");
    const applyMobTabsVisibility = () => {
      // Keep CSS as the source of truth; this only avoids stale inline styles on resize.
      mobTabs.style.display = mql.matches ? "grid" : "none";
    };
    applyMobTabsVisibility();
    mql.addEventListener?.("change", applyMobTabsVisibility);

    document.getElementById("mobSignIn")?.addEventListener("click", () => switchTab("login"));
    document.getElementById("mobSignUp")?.addEventListener("click", () => switchTab("signup"));

    // ===== Data helpers (kept) =====
    async function getAdminRow(userId) {
      const { data, error } = await supabase.from("admin").select("*").eq("id", userId).maybeSingle();
      if (error) throw error; return data;
    }
    async function ensureAdminRowNow(user, overrides = {}) {
      const payload = {
        id: user.id, email: user.email,
        name: user.user_metadata?.name || overrides.name || "Admin User",
        phone: user.user_metadata?.phone || overrides.phone || null,
        role: "pending",
      };
      const { error } = await supabase.from("admin").insert([payload]);
      if (error) throw error;
    }
    function openEmailProvider(email) {
      const emailProvider = email.split("@")[1]?.toLowerCase() || "";
      let providerUrl = "https://mail.google.com";
      if (emailProvider.includes("yahoo")) providerUrl = "https://mail.yahoo.com";
      else if (emailProvider.includes("outlook") || emailProvider.includes("hotmail") || emailProvider.includes("live")) providerUrl = "https://outlook.live.com/mail";
      else if (emailProvider.includes("icloud")) providerUrl = "https://www.icloud.com/mail";
      document.getElementById("goToEmailBtn").onclick = () => window.open(providerUrl, "_blank");
      document.getElementById("emailConfirmModal").style.display = "flex";
    }

    // ===== SIGN UP (kept) =====
    document.getElementById("signUpBtn").addEventListener("click", async () => {
      hideNotice();
      const name = document.getElementById("suName").value.trim();
      const phone = document.getElementById("suPhone").value.trim();
      const email = document.getElementById("suEmail").value.trim();
      const password = document.getElementById("suPassword").value;

      if (!name || !email || !password || password.length < 6) {
        showNotice("Please fill all required fields (password min 6 chars).", "error"); return;
      }
      try {
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email, password, options: { data: { name, phone, role: "admin" } },
        });
        if (authError) throw authError;

        if (authData.session && authData.user) {
          await ensureAdminRowNow(authData.user, { name, phone });
          showNotice("Sign up successful. Your admin profile is now pending approval.", "success");
          switchTab("login");
        } else {
          openEmailProvider(email);
          showNotice("Sign up successful. Please confirm your email. After confirming, log in — your admin profile will be set to pending automatically.", "success");
          switchTab("login");
        }
      } catch (err) {
        console.error(err);
        showNotice("Sign up error: " + (err.message || "Unknown error"), "error");
      }
    });

    // ===== LOGIN (kept) =====
    const loginBtn = document.getElementById("loginBtn");
    async function refreshLoginState() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      try {
        let row = await getAdminRow(user.id);
        if (!row) { await ensureAdminRowNow(user); row = await getAdminRow(user.id); }

        if (row.role === "pending") {
          window.location.href = "pages/admin_pages/html_files/waiting.html"; return;
        }
        if (row.role === "admin" || row.role === "superadmin") {
          window.location.href = "pages/admin_pages/html_files/dashboard.html";
        } else {
          showNotice("Unknown role status.", "error");
        }
      } catch (e) {
        console.error(e);
        showNotice("Failed to fetch admin status: " + (e.message || "Unknown error"), "error");
      }
    }
    loginBtn.addEventListener("click", async () => {
      hideNotice();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      if (!email || !password) { showNotice("Please enter email and password.", "error"); return; }
      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await refreshLoginState();
      } catch (err) {
        console.error(err);
        showNotice("Login error: " + (err.message || "Unknown error"), "error");
      }
    });

    // On load
    (async () => { switchTab("login"); await refreshLoginState(); })();
  </script>
</body>

</html>