<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
	<link rel="stylesheet" href="style.css">
	<title>SIMP Project</title>
	<style>
		.container3 {
			display: grid;
			grid-template-columns: repeat(3, minmax(0, 1fr));
			gap: 20px;
		}
		@media (max-width: 1024px) { .container3 { grid-template-columns: repeat(2, 1fr); } }
		@media (max-width: 640px) { .container3 { grid-template-columns: 1fr; } }

		.job-card {
			position: relative;
			border-radius: 16px;
			overflow: hidden;
			height: 260px;
			color: #fff;
			display: flex;
			align-items: flex-end;
			padding: 16px;
			box-shadow: 0 6px 18px rgba(17, 24, 39, 0.15);
			transition: transform .3s ease, box-shadow .3s ease;
			background: #1c2430;
		}
		.job-card:hover {
			transform: translateY(-4px) scale(1.02);
			box-shadow: 0 12px 28px rgba(17, 24, 39, 0.25);
		}

		/* Background image with overlay */
		.job-cover {
			position: absolute;
			inset: 0;
			background-size: cover;
			background-position: center;
			filter: brightness(75%); /* 25% dim */
			z-index: 1;
		}
		.job-overlay {
			position: absolute;
			inset: 0;
			background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.15));
			z-index: 2;
		}

		.job-body {
			position: relative;
			z-index: 3;
			width: 100%;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.job-body h3 {
			margin: 0;
			font-size: 1.15rem;
			font-weight: 700;
			line-height: 1.3;
		}
		.job-body p {
			margin: 0;
			font-size: .95rem;
			line-height: 1.4;
			color: #e2e8f0;
			flex-grow: 1;
		}

		.job-meta {
			display: flex;
			align-items: center;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 10px;
		}
		.job-city {
			display: flex;
			align-items: center;
			gap: 6px;
			font-size: .9rem;
			color: #cbd5e1;
		}
		.job-city i { font-size: 1.1rem; }

		.price {
			background: rgba(255, 255, 255, 0.15);
			padding: 6px 12px;
			border-radius: 999px;
			font-weight: 600;
			font-size: .9rem;
			backdrop-filter: blur(6px);
		}

		/* NEW: posted time pill */
		.posted-time {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			font-size: .85rem;
			background: rgba(0,0,0,.35);
			padding: 6px 10px;
			border-radius: 999px;
			color: #e2e8f0;
			white-space: nowrap;
		}
		.posted-time i { font-size: 1rem; }

		.empty-jobs {
			grid-column: 1 / -1;
			text-align: center; padding: 24px; border: 1px dashed #e2e8f0; border-radius: 12px; background: #fafcff; color: #425569;
		}
	</style>
</head>

<body>
	<!-- First Page -->
	<div class="firstPage">
		<nav>
			<ul class="nav_links">
				<div>
					<li><img src="img/logowhitebold.png" alt="logo" /></li>
					<li><a href="#">Home</a></li>
					<li><a href="#how-it-works">About Us</a></li>
					<li><a href="#how-it-works">How It Works</a></li>
					<li><a href="#contact">Contact Us</a></li>
				</div>
				<li><a href="login.html">Log in</a></li>
				<li><a href="signup.html">Sign up</a></li>
			</ul>
		</nav>
		<section class="section_container">
			<h3>Post your project. Get the best people. Done.</h3>
			<h2>Connect with Expert Technicians & Installers Across the Philippines!</h2>
			<button onclick="document.getElementById('jobs').scrollIntoView({behavior:'smooth'})">
				View Job Postings<span><i class="ri-arrow-right-line"></i></span>
			</button>
			<div class="scroll_bottom">
				<a href="#how-it-works">
					<span><i class="ri-mouse-fill"></i></span>
					SCROLL
				</a>
			</div>
			<div class="socials">
				<a href="adminLogin.html" aria-label="Admin"><i class="ri-user-settings-line"></i></a>
			</div>
		</section>
	</div>

	<!-- Second Page -->
	<div class="secondPage hiw" id="how-it-works">
		<div>
			<h1>How It Works</h1>
			<p class="hiw-subtitle">Mobile hiring made simple—post, learn, apply, and get hired with a seamless workflow.</p>
		div>
		<div class="hiw-steps container2">
			<div class="hiw-step"><h4>Create Your Profile</h4><p>Sign up and build your professional portfolio.</p></div>
			<div class="hiw-step"><h4>Level Up with Courses</h4><p>Take specialized courses to sharpen your expertise.</p></div>
			<div class="hiw-step"><h4>Find &amp; Apply for Jobs</h4><p>Browse nationwide roles and apply to the ones that fit.</p></div>
			<div class="hiw-step"><h4>Get Hired &amp; Succeed</h4><p>Deliver great work, earn reviews, and grow your reputation.</p></div>
		</div>
	</div>

	<!-- Third Page -->
	<div class="thirdPage" id="jobs">
		<div class="thirdPageTitle"><h1>Recent Job Postings</h1></div>
		<div class="container3" id="recentJobs">
			<div class="empty-jobs" id="jobsEmpty" style="display:none;">No recent job postings yet. Please check back soon.</div>
		</div>
	</div>

	<!-- Fourth Page -->
	<div class="fourthPage">
		<div class="container4">
			<p class="p1">Ready to Start Your Journey?</p>
			<p class="p2">Join our community of elite technicians and take control of your career today.</p>
			<button aria-label="View job postings from CTA" onclick="document.getElementById('jobs').scrollIntoView({behavior:'smooth'})">View Job Postings</button>
		</div>
	</div>

	<!-- Footer -->
	<footer class="site-footer">
		<div class="footer-inner">
			<div class="footer-brand"><strong>Powered by:</strong> STEQ Technological Solutions and Services Inc.</div>
			<div class="footer-meta">
				SIMP (<strong>STSSI Installers Management Platform</strong>)<br />
				Copyright © 2025. All Rights Reserved.
			</div>
			<address class="footer-contact" id="contact">
				<i class="ri-map-pin-line"></i> 1103 Don Pedro St., Valenzuela<br>
				<a href="mailto:sales@steq.online"><i class="ri-mail-line"></i> sales@steq.online</a><br>
				<a href="tel:+639177812111"><i class="ri-phone-line"></i> +63 917 781 2111</a>
			</address>
		</div>
	</footer>

	<!-- ScrollReveal -->
	<script src="https://unpkg.com/scrollreveal"></script>
	<script>
		const scrollRevealOption = { distance: "50px", origin: "bottom", duration: 1000 };
		ScrollReveal().reveal(".section_container h3", { ...scrollRevealOption });
		ScrollReveal().reveal(".section_container h2", { ...scrollRevealOption, origin: "right", delay: 200 });
		ScrollReveal().reveal(".section_container button", { ...scrollRevealOption, delay: 400 });
		ScrollReveal().reveal(".nav_links li", { ...scrollRevealOption, origin: "top", interval: 100 });
		ScrollReveal().reveal(".container2 > div", { ...scrollRevealOption, interval: 200 });
		ScrollReveal().reveal(".container3 > div", { ...scrollRevealOption, origin: "left", interval: 150 });
		ScrollReveal().reveal(".fourthPage", { ...scrollRevealOption, origin: "bottom" });
	</script>

	<!-- Fetch jobs -->
	<script type="module">
		import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./supabase.js";

		const jobsWrap = document.getElementById("recentJobs");
		const emptyState = document.getElementById("jobsEmpty");

		function peso(n) {
			return "₱" + Number(n || 0).toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
		}
		function truncate(text, max = 160) {
			if (!text) return "";
			const s = String(text);
			return s.length > max ? s.slice(0, max - 1) + "…" : s;
		}
		function cityOnly(locationValue) {
			if (!locationValue) return "";
			const s = String(locationValue);
			return s.split(",")[0].trim();
		}

		/* NEW: relative time helper */
		function timeAgo(iso) {
			if (!iso) return "";
			const d = new Date(iso);
			const now = new Date();
			const diff = Math.max(0, now - d); // ms
			const sec = Math.floor(diff / 1000);
			if (sec < 5) return "just now";
			if (sec < 60) return `${sec}s ago`;
			const min = Math.floor(sec / 60);
			if (min < 60) return `${min}m ago`;
			const hrs = Math.floor(min / 60);
			if (hrs < 24) return `${hrs}h ago`;
			const days = Math.floor(hrs / 24);
			if (days < 7) return `${days}d ago`;
			// Fallback to date for older posts
			return d.toLocaleDateString("en-PH", { month: "short", day: "numeric", year: "numeric" });
		}

		let supa = null;
		async function getClient() {
			if (supa) return supa;
			const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm");
			supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
			return supa;
		}

		async function resolveImageUrl(job_picture_url) {
			try {
				if (!job_picture_url) return null;
				const path = String(job_picture_url).replace(/^\/+/, "");
				if (/^https?:\/\//i.test(path)) return path;

				const client = await getClient();
				const { data: signed } = await client.storage.from("jobs").createSignedUrl(path, 3600);
				if (signed?.signedUrl) return signed.signedUrl;

				const { data: pub } = client.storage.from("jobs").getPublicUrl(path);
				return pub?.publicUrl || null;
			} catch {
				return null;
			}
		}

		async function jobCard(job) {
			const title = job.job_title || "Untitled Job";
			const desc = job.job_description || "";
			const city = cityOnly(job.job_location);
			const pay = job.job_pay != null ? peso(job.job_pay) : "—";
			const posted = timeAgo(job.created_at);

			const card = document.createElement("div");
			card.className = "job-card";
			card.innerHTML = `
				<div class="job-cover"></div>
				<div class="job-overlay"></div>
				<div class="job-body">
					<h3>${title}</h3>
					<p>${truncate(desc)}</p>
					<div class="job-meta">
						<span class="job-city" title="${job.job_location || ''}"><i class="ri-map-pin-line"></i>${city || "—"}</span>
						<span class="posted-time" title="${job.created_at ? new Date(job.created_at).toLocaleString('en-PH') : ''}">
							<i class="ri-time-line"></i>${posted || ""}
						</span>
						<span class="price">${pay}</span>
					</div>
				</div>
			`;

			const cover = card.querySelector(".job-cover");
			resolveImageUrl(job.job_picture_url).then(url => {
				if (url) cover.style.backgroundImage = `url("${url}")`;
			});

			return card;
		}

		async function loadRecentJobs() {
			try {
				/* keeps your existing API usage; already limited to 6 newest */
				const url = `${SUPABASE_URL}/rest/v1/public_recent_jobs?select=*&order=created_at.desc&limit=6`;
				const res = await fetch(url, {
					headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
				});
				if (!res.ok) throw new Error(await res.text());
				let rows = await res.json();

				// Extra safety: in case the view ignores limit, enforce top 6 here.
				rows = Array.isArray(rows)
					? rows.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 6)
					: [];

				jobsWrap.innerHTML = "";
				if (!rows?.length) {
					emptyState.style.display = "";
					jobsWrap.appendChild(emptyState);
					return;
				}
				emptyState.style.display = "none";
				for (const job of rows) jobsWrap.appendChild(await jobCard(job));

				// Optional: keep the "x minutes ago" fresh
				setInterval(() => {
					document.querySelectorAll(".posted-time").forEach((el, idx) => {
						const r = rows[idx];
						if (!r?.created_at) return;
						el.innerHTML = `<i class="ri-time-line"></i>${timeAgo(r.created_at)}`;
						el.title = new Date(r.created_at).toLocaleString('en-PH');
					});
				}, 60_000);
			} catch (e) {
				console.error(e);
				emptyState.textContent = "Could not load jobs.";
				emptyState.style.display = "";
				jobsWrap.appendChild(emptyState);
			}
		}
		loadRecentJobs();
	</script>
</body>
</html>
